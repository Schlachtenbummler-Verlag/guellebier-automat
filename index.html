<!doctype html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
<title>Saxonischer Automat</title>

<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  :root{
    /* --------- Layout / Skalierung --------- */
    --ui-scale: 1; /* wird per JS gesetzt (plateBreite / 1920) */

    /* Fenster-Koordinaten (relativ zur 16:9-Platte) */
    --r-top: 31.48%;
    --r-w:   14.06%;
    --r-h:   25.00%;
    --r0-left: 15.62%;
    --r1-left: 33.85%;
    --r2-left: 52.08%;
    --r3-left: 70.31%;

    /* Ergebnisfenster */
    --res-left: 14.58%;
    --res-top:  68.51%;
    --res-w:    70.83%;
    --res-h:    18.51%;

    /* Hebel/Lampen */
    --lever-x: 10%;
    --lever-y: 51.5%;
    --lamps-x: 90.5%;
    --lamps-y: 46.5%;

    /* proportionale Skalen */
    --reel-scale: 1;
    --lever-scale: 1;
    --lamps-scale: 1;

    /* Buttons Position/Skalierung */
    --sound-x:  12px;
    --sound-y:  12px;
    --sound-scale: 1;

    --exit-x:   12px;
    --exit-y:   60px;
    --exit-scale: 1;

    /* Buttons Transparenz (neu) */
    --sound-btn-alpha: 1;
    --exit-btn-alpha: 1;

    /* Farben/Outlines */
    --lamp-red-color:   #ff4d4d;
    --lamp-green-color: #4cd964;
    --lamp-blue-color:  #4da6ff;
    --lamp-gold-color:  #ffd400;
    --outline-reel:     #4dbbff;
    --outline-result:   #59ffa1;

    /* Ergebnis-Text (skaliert √ºber --ui-scale) */
    --result-name-color:   #ffffff;
    --result-desc-color:   #e8e8e8;
    --result-points-color: #ffd24a;
    --result-name-size:    calc(1.25rem * var(--ui-scale));
    --result-desc-size:    calc(1.00rem * var(--ui-scale));
    --result-points-size:  calc(1.10rem * var(--ui-scale));

    /* Schimmer (lokal, synchron) */
    --shine-angle: 120deg;
    --shine-core:  .20;
    --shine-speed: 60s;

    /* Scanlines (nur im Ergebnisfenster) */
    --scan-angle: 180deg;
    --scan-thickness: 1px;
    --scan-spacing: 3px;
    --scan-bright: rgba(255,255,255,.08);
    --scan-dark:   rgba(0,0,0,0);
    --scan-opacity: .22;
    --scan-blend: overlay;

    /* Lampen */
    --lamps-gap: 10px;
    --lamp-afterglow: 4.2s;

    /* Sound / Exit */
    --sound-enabled: 1;
    --exit-requires-confirm: 1;
    --exit-button-label: "Beenden";
    --exit-confirm-text: "Wirklich beenden?";
  }

  /* ===== Frame / Immersion ===== */
  html,body{
    margin:0; padding:0; width:100%;
    height:100svh;
    background:#000; overflow:hidden;
    overscroll-behavior:none;
    touch-action:manipulation;
    -webkit-user-select:none; user-select:none;
  }
  body{ position:fixed; inset:0; }

  .stage{position:fixed; inset:0; display:grid; place-items:center;}
  .plate{
    position:relative;
    width:min(100vw,calc(100svh*(16/9)));
    height:min(100svh,calc(100vw*(9/16)));
    font-size: calc(16px * var(--ui-scale));
  }

  .plate__img{position:absolute; inset:0; width:100%; height:100%; object-fit:contain; z-index:5; pointer-events:none;}

  /* ===== Reels ===== */
  .reels{position:absolute; inset:0; z-index:1; transform:scale(var(--reel-scale)); transform-origin:center;}
  .reel{
    position:absolute; top:var(--r-top); left:0; width:var(--r-w); height:var(--r-h);
    display:flex; align-items:center; justify-content:center; overflow:hidden; border-radius:10px;
    background:#111; padding:10px;
    box-shadow: inset 0 2px 10px rgba(0,0,0,.6), 0 8px 18px rgba(0,0,0,.25);
  }
  #reel-0{left:var(--r0-left);} #reel-1{left:var(--r1-left);} #reel-2{left:var(--r2-left);} #reel-3{left:var(--r3-left);}

  .reel::before, .reel::after{ content:""; position:absolute; left:0; right:0; height:22%; pointer-events:none; z-index:3; }
  .reel::before{ top:0;    background:linear-gradient(to bottom, rgba(0,0,0,.6), rgba(0,0,0,0)); }
  .reel::after { bottom:0; background:linear-gradient(to top,    rgba(0,0,0,.6), rgba(0,0,0,0)); }

  .reel .sweep{
    position:absolute; top:0; bottom:0; left:-120%; width:120%;
    background:linear-gradient(var(--shine-angle), rgba(255,255,255,0) 30%, rgba(255,255,255,var(--shine-core)) 50%, rgba(255,255,255,0) 70%);
    transform:skewX(-20deg); pointer-events:none; z-index:2;
    animation: sweep var(--shine-speed) linear infinite;
  }
  @keyframes sweep{ from{ left:-120%; } to{ left:120%; } }

  .symbol{ position:relative; width:80%; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; overflow:hidden; will-change: transform, filter; transition: filter .2s ease; }
  .symbol img{width:100%;height:100%;object-fit:contain;display:block;}

  .reel.spinning .symbol{ filter: blur(3px) saturate(1.1); animation: spin-jitter .12s linear infinite; }
  @keyframes spin-jitter{ 0%{transform:translateY(-3%)} 50%{transform:translateY(3%)} 100%{transform:translateY(-3%)} }
  .reel.spinning .streak{
    position:absolute; inset:-30% -10%;
    background:linear-gradient(90deg, rgba(255,255,255,0) 30%, rgba(255,255,255,.25) 50%, rgba(255,255,255,0) 70%);
    filter: blur(6px); opacity:.18; transform: rotate(12deg);
    animation: streak .5s linear infinite; pointer-events:none; z-index:4;
  }
  @keyframes streak{ from{transform:rotate(12deg) translateX(-8%)} to{transform:rotate(12deg) translateX(8%)} }
  .reel.stop-bounce .symbol{ animation: stop-bounce .32s cubic-bezier(.2,.8,.2,1) 1; filter:none; }
  @keyframes stop-bounce{ 0%{transform:translateY(10%)} 60%{transform:translateY(-4%)} 100%{transform:translateY(0)} }

  /* ===== Ergebnisfenster ===== */
  .result{
    position:absolute; left:var(--res-left); top:var(--res-top); width:var(--res-w); height:var(--res-h);
    display:grid; place-items:center; text-align:center; padding:8px 10px; z-index:0; line-height:1.25;
    overflow:hidden;
  }
  .result-inner{ display:grid; gap:.25rem; position:relative; z-index:1; }
  .result-inner .name{ color:var(--result-name-color); font-size:var(--result-name-size); font-weight:800; letter-spacing:.02em; }
  .result-inner .desc{ color:var(--result-desc-color); font-size:var(--result-desc-size); opacity:.95; }
  .result-inner .points{ color:var(--result-points-color); font-size:var(--result-points-size); font-weight:700; }

  .result::before{
    content:""; position:absolute; top:0; bottom:0; left:-120%; width:120%;
    background:linear-gradient(var(--shine-angle), rgba(255,255,255,0) 30%, rgba(255,255,255,var(--shine-core)) 50%, rgba(255,255,255,0) 70%);
    transform:skewX(-20deg); pointer-events:none;
    animation: sweep var(--shine-speed) linear infinite;
  }

  .result::after{
    content:""; position:absolute; inset:0; pointer-events:none;
    background:
      repeating-linear-gradient(
        var(--scan-angle),
        var(--scan-bright) 0,
        var(--scan-bright) var(--scan-thickness),
        var(--scan-dark)   var(--scan-thickness),
        var(--scan-dark)   calc(var(--scan-thickness) + var(--scan-spacing))
      );
    mix-blend-mode: var(--scan-blend);
    opacity: var(--scan-opacity);
    z-index:0;
  }

  /* ===== Hebel ===== */
  .lever-area{ position:absolute; left:var(--lever-x); top:var(--lever-y); transform:translate(-50%,-50%) scale(var(--lever-scale)); z-index:6; }
  .lever{ width:calc(72px * var(--ui-scale)); height:calc(300px * var(--ui-scale)); position:relative; cursor:grab; user-select:none; touch-action:none; filter: drop-shadow(0 6px 14px rgba(0,0,0,.35)); }
  .lever__back{ position:absolute; inset:0; border-radius:10px; background:linear-gradient(180deg,#1a1a1a,#0f0f0f); box-shadow: inset 0 6px 10px rgba(0,0,0,.6), inset 0 -6px 10px rgba(0,0,0,.4); }
  .lever__slot{ position:absolute; left:50%; top:14px; bottom:14px; width:12px; transform:translateX(-50%); background:#080808; border-radius:8px; box-shadow: inset 0 0 10px rgba(0,0,0,.9); }
  .lever__arm{ position:absolute; left:50%; top:22px; width:6px; bottom:22px; transform:translateX(-50%); background:linear-gradient(180deg,#555,#2a2a2a); border-radius:3px; box-shadow: inset 0 0 4px rgba(0,0,0,.6); }
  .lever__knob{
    --y:0px; position:absolute; left:50%; top:0; width:56px; height:56px; transform:translate(-50%, var(--y));
    border-radius:50%;
    background: radial-gradient(circle at 30% 30%, #ffb8b8, #ff4a4a 45%, #d33c3c 75%, #8a1d1d 100%);
    box-shadow: 0 10px 18px rgba(0,0,0,.45), inset 0 2px 0 rgba(255,255,255,.35);
    overflow:hidden;
  }
  .lever__knob::after{
    content:""; position:absolute; inset:0; border-radius:50%;
    background:linear-gradient(120deg, rgba(255,255,255,.65) 0%, rgba(255,255,255,0) 40%);
    mix-blend-mode:screen; opacity:.35; pointer-events:none; animation: knobShine 3s linear infinite;
  }
  @keyframes knobShine{ from{ transform:translateX(-100%) rotate(25deg);} to{ transform:translateX(100%) rotate(25deg);} }
  .lever__ring{ position:absolute; left:50%; width:32px; height:8px; transform:translate(-50%, calc(var(--y) + 52px)); background:linear-gradient(180deg,#777,#333); border-radius:8px; filter:blur(.2px); }

  /* ===== Lampen ===== */
  .lamps-area{
    position:absolute; left:var(--lamps-x); top:var(--lamps-y);
    transform:translate(-50%,-50%) scale(var(--lamps-scale)); z-index:6;
    display:flex; flex-direction:column; gap:var(--lamps-gap);
  }
  .lamp{
    pointer-events:none; user-select:none; min-width:calc(160px * var(--ui-scale)); height:calc(56px * var(--ui-scale)); padding:0 calc(16px * var(--ui-scale));
    display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden;
    border-radius:32px; background:linear-gradient(180deg,#2f2f2f,#161616);
    box-shadow: inset 0 4px 10px rgba(0,0,0,.7), inset 0 -4px 8px rgba(0,0,0,.5);
  }
  .lamp__label{ font-weight:900; letter-spacing:.08em; text-transform:uppercase; color:#8a8aa0; text-shadow: 0 1px 0 rgba(0,0,0,.6); }
  .lamp__shine{ content:""; position:absolute; inset:0; background: radial-gradient(ellipse at 50% -30%, rgba(255,255,255,.25), rgba(255,255,255,0) 45%); opacity:.35; mix-blend-mode:screen; pointer-events:none; }

  .lamp--red.active{   background: radial-gradient(circle at 50% 20%, #ffd6d6 0%, #ff4d4d 40%, #b11717 70%, #4a0a0a 100%); box-shadow: 0 0 18px 6px rgba(255,80,80,.55), 0 0 36px 16px rgba(255,80,80,.22); animation: lampPulse 1.2s ease-out 1; }
  .lamp--green.active{ background: radial-gradient(circle at 50% 20%, #eaffea 0%, #4cd964 40%, #1db954 70%, #0e3f1d 100%); box-shadow: 0 0 18px 6px rgba(80,255,120,.55), 0 0 36px 16px rgba(80,255,120,.22); animation: lampPulse 1.2s ease-out 1; }
  .lamp--blue.active{  background: radial-gradient(circle at 50% 20%, #e2efff 0%, #4da6ff 40%, #175ab1 70%, #0a224a 100%); box-shadow: 0 0 18px 6px rgba(80,120,255,.55), 0 0 36px 16px rgba(80,120,255,.22); animation: lampPulse 1.2s ease-out 1; }
  .lamp--gold.active{  background:#FFD400; box-shadow: 0 0 18px 6px rgba(255,212,0,.65), 0 0 36px 16px rgba(255,212,0,.28); animation: lampPulse 1.2s ease-out 1; }
  @keyframes lampPulse{ 0%{box-shadow:0 0 0 0 rgba(255,255,255,0)} 60%{box-shadow:0 0 28px 12px rgba(255,255,255,.65)} 100%{box-shadow:0 0 18px 6px rgba(255,255,255,.4)} }

  .lamp.glow::after{ content:""; position:absolute; inset:-10px; border-radius:inherit; opacity:0; filter: blur(10px); pointer-events:none; animation: afterglow var(--lamp-afterglow) ease-out forwards; }
  .lamp--gold.glow::after { background: radial-gradient(ellipse at 50% 50%, rgba(255,212,0,.90), rgba(255,212,0,.45) 42%, rgba(255,212,0,0) 70%); }
  .lamp--red.glow::after  { background: radial-gradient(ellipse at 50% 50%, rgba(255,110,110,.85), rgba(255,80,80,.35) 40%, rgba(255,80,80,0) 70%); }
  .lamp--green.glow::after{ background: radial-gradient(ellipse at 50% 50%, rgba(120,255,160,.85), rgba(80,255,120,.35) 40%, rgba(80,255,120,0) 70%); }
  .lamp--blue.glow::after { background: radial-gradient(ellipse at 50% 50%, rgba(140,180,255,.85), rgba(100,140,255,.35) 40%, rgba(100,140,255,0) 70%); }
  @keyframes afterglow{ from{opacity:.95} to{opacity:0} }

  /* Debug-Overlays */
  .debug .reel{ outline:2px dashed var(--outline-reel); outline-offset:-2px; }
  .debug .result{ outline:2px dashed var(--outline-result); }

  /* UI: Buttons (immer relativ zur Platte) */
  .ui-fixed-btn{
    position:fixed; z-index:2147483601; padding:calc(10px * var(--ui-scale)) calc(14px * var(--ui-scale));
    border-radius:10px; border:1px solid #333; background:#0e0e0e; color:#fff; cursor:pointer; font-weight:700;
    font-size:calc(14px * var(--ui-scale));
    transition:opacity .2s ease;
  }
  #soundToggle{
    left:calc(var(--sound-x) * var(--ui-scale));
    bottom:calc(var(--sound-y) * var(--ui-scale));
    transform:scale(calc(var(--sound-scale) * var(--ui-scale)));
    transform-origin: bottom left;
    opacity: var(--sound-btn-alpha);
  }
  #exitBtn{
    left:calc(var(--exit-x) * var(--ui-scale));
    bottom:calc(var(--exit-y) * var(--ui-scale));
    transform:scale(calc(var(--exit-scale) * var(--ui-scale)));
    transform-origin: bottom left;
    opacity: var(--exit-btn-alpha);
  }
  #dbgToggle{ right:12px; bottom:12px; z-index:2147483647; }

  /* ===== Start-Overlay ===== */
  #startOverlay{
    position:fixed; inset:0; z-index:99999; background:#000; display:grid; place-items:center;
  }
  #startInner{
    display:grid; gap:1rem; place-items:center; text-align:center; color:#fff;
    padding:2rem; max-width:min(92vw, 640px);
  }
  #startLogo{
    width:min(60vw, 420px); aspect-ratio:16/9; background:#111; border:1px solid #222; border-radius:12px;
    display:grid; place-items:center; color:#888; font-size:clamp(14px, 3vw, 18px);
  }
  #startBtn{
    appearance:none; border:none; border-radius:12px; background:#1a1a1a; color:#fff; cursor:pointer;
    padding:1rem 1.25rem; font-weight:800; font-size:clamp(16px, 4vw, 22px);
    box-shadow:0 10px 28px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.08);
  }
  #startBtn:active{ transform:scale(.98); }

  /* ===== Debug Panel (kompakt) ===== */
  #dbgPanel{
    position:fixed; right:12px; bottom:64px; width:min(92vw,420px);
    max-height:72vh; overflow:auto; z-index:2147483600; background:#0b0b0b; color:#fff;
    border:1px solid #333; border-radius:14px; box-shadow:0 12px 28px rgba(0,0,0,.5); display:none;
  }
  #dbgPanel header{ position:sticky; top:0; padding:10px 12px; background:#101010; border-bottom:1px solid #222; display:flex; align-items:center; justify-content:space-between; gap:8px; cursor:move; }
  #dbgPanel header h4{ margin:0; font-size:1rem; }
  #dbgPanel .grp{ padding:10px 12px; border-top:1px solid #1a1a1a; }
  #dbgPanel .row{ display:grid; grid-template-columns: 1fr auto; align-items:center; gap:8px; margin:6px 0; }
  #dbgPanel label{ font-size:.9rem; color:#ddd; }
  #dbgPanel input[type="range"]{ width:100%; }
  #dbgPanel input[type="number"]{ width:110px; background:#000; color:#fff; border:1px solid #333; border-radius:8px; padding:6px; }
  #dbgPanel input[type="color"]{ width:42px; height:32px; padding:0; border:none; background:transparent; }
</style>
</head>
<body>

<!-- ===== Start Overlay ===== -->
<div id="startOverlay" aria-modal="true" role="dialog">
  <div id="startInner">
    <div id="startLogo">Platzhalter f√ºr Startbild / Logo</div>
    <button id="startBtn" type="button">Dr√ºcken zum Starten</button>
  </div>
</div>

<div class="stage" aria-hidden="true">
  <div class="plate">

    <!-- Walzen -->
    <div class="reels" id="reels">
      <div class="reel" id="reel-0">
        <div class="sweep"></div><div class="streak" hidden></div>
        <div class="symbol"><img src="assets/img/rot.png" alt=""></div>
      </div>
      <div class="reel" id="reel-1">
        <div class="sweep"></div><div class="streak" hidden></div>
        <div class="symbol"><img src="assets/img/blau.png" alt=""></div>
      </div>
      <div class="reel" id="reel-2">
        <div class="sweep"></div><div class="streak" hidden></div>
        <div class="symbol"><img src="assets/img/gruen.png" alt=""></div>
      </div>
      <div class="reel" id="reel-3">
        <div class="sweep"></div><div class="streak" hidden></div>
        <div class="symbol"><img src="assets/img/gelb.png" alt=""></div>
      </div>
    </div>

    <!-- Ergebnis -->
    <div class="result" id="gbaResult">
      <div class="result-inner">
        <div class="name" id="resName">Ziehe den Hebel f√ºr einen Ernteauftrag!</div>
        <div class="desc" id="resDesc"></div>
        <div class="points" id="resPts"></div>
      </div>
    </div>

    <!-- Hebel -->
    <div class="lever-area">
      <div id="lever" class="lever" role="button" aria-label="Hebel ziehen" tabindex="0">
        <div class="lever__back"></div>
        <div class="lever__slot"></div>
        <div class="lever__arm"></div>
        <div class="lever__knob"></div>
        <div class="lever__ring"></div>
      </div>
    </div>

    <!-- Lampen -->
    <div class="lamps-area">
      <div id="lampGold"  class="lamp lamp--gold"><span class="lamp__label">Legend√§r</span><div class="lamp__shine"></div></div>
      <div id="lampBlue"  class="lamp lamp--blue"><span class="lamp__label">Mittel</span><div class="lamp__shine"></div></div>
      <div id="lampGreen" class="lamp lamp--green"><span class="lamp__label">Normal</span><div class="lamp__shine"></div></div>
      <div id="lampRed"   class="lamp lamp--red"><span class="lamp__label">Einfach</span><div class="lamp__shine"></div></div>
    </div>

    <!-- Frontplatte -->
    <img class="plate__img" src="assets/img/overlay.png" alt="Frontplatte">
  </div>
</div>

<div id="rotateOverlay" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.9);color:#FFD700;align-items:center;justify-content:center;text-align:center;padding:20px;box-sizing:border-box">
  Bitte Querformat drehen<br><small>(Taste D: Debug-Outlines)</small>
</div>

<!-- UI -->
<button id="soundToggle" class="ui-fixed-btn" type="button">üîä Sound: AN</button>
<button id="exitBtn" class="ui-fixed-btn" type="button"></button>
<button id="dbgToggle" class="ui-fixed-btn" type="button">üõ†Ô∏è Debug</button>

<!-- Debug Panel (kompakt & funktional) -->
<div id="dbgPanel" role="dialog" aria-label="Layout Debug">
  <header>
    <h4>Layout Debug</h4>
    <div>
      <button class="btn" id="dbgClose" type="button">Schlie√üen</button>
    </div>
  </header>

  <div class="grp">
    <div class="row"><label><input type="checkbox" id="dbgOutlines"> Outlines an (Taste D)</label><div></div></div>
    <div class="row"><label><input type="checkbox" id="dbgSound"> Sound an/aus</label><div></div></div>
  </div>

  <div class="grp"><strong>Buttons Transparenz</strong>
    <div class="row"><label>Sound-Button Alpha</label><input id="alphaSound" type="range" min="0" max="1" step="0.05"></div>
    <div class="row"><label>Beenden-Button Alpha</label><input id="alphaExit" type="range" min="0" max="1" step="0.05"></div>
  </div>
</div>

<script>
(function(){
  const $  = s => document.querySelector(s);
  const $$ = s => [...document.querySelectorAll(s)];

  /* ===== Grund-Immersion & Start ===== */
  let wakeLock=null, fsAsked=false;
  async function enterImmersive(){
    try{
      const el=document.documentElement;
      if(!document.fullscreenElement){
        if(el.requestFullscreen) await el.requestFullscreen();
        else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      }
    }catch{}
    try{ if(screen.orientation?.lock) await screen.orientation.lock('landscape'); }catch{}
    try{
      if('wakeLock' in navigator && !wakeLock){
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener?.('release',()=>{wakeLock=null;});
      }
    }catch{}
    try{ window.scrollTo(0,0);}catch{}
  }
  function askImmersiveOnce(){ if(fsAsked) return; fsAsked=true; enterImmersive(); }

  $('#startBtn').addEventListener('click', ()=>{
    askImmersiveOnce();
    $('#startOverlay').style.display='none';
    document.querySelector('.stage').setAttribute('aria-hidden','false');
  });

  window.addEventListener('focus', ()=>{ if(!document.fullscreenElement) fsAsked=false; });
  document.addEventListener('fullscreenchange', ()=>{ if(!document.fullscreenElement){ fsAsked=false; wakeLock=null; } });

  // Gesten/Zoom reduzieren
  document.addEventListener('contextmenu', e=> e.preventDefault(), {passive:false});
  document.addEventListener('gesturestart', e=> e.preventDefault(), {passive:false});
  document.addEventListener('touchstart', ()=>askImmersiveOnce(), {passive:true});
  document.addEventListener('mousedown',  ()=>askImmersiveOnce());

  /* ===== Layout-Stabilit√§t: einheitliche Skalierung ===== */
  const plate = $('.plate');
  function updateUiScale(){
    const scale = plate.clientWidth / 1920;
    document.documentElement.style.setProperty('--ui-scale', scale.toFixed(5));
  }
  new ResizeObserver(updateUiScale).observe(plate);
  updateUiScale();

  /* ===== Orientierung & Debug-Outlines ===== */
  function checkOrientation(){ $('#rotateOverlay').style.display = (innerHeight>innerWidth)?'flex':'none'; }
  addEventListener('resize',checkOrientation);
  addEventListener('orientationchange',checkOrientation);
  document.addEventListener('DOMContentLoaded',checkOrientation);

  addEventListener('keydown', (e)=>{
    if(e.key.toLowerCase()==='d'){
      document.body.classList.toggle('debug');
      const cb=$('#dbgOutlines'); if(cb) cb.checked=document.body.classList.contains('debug');
    }
  });

  /* ===== Assets ===== */
  const IMG = {
    rot:'assets/img/rot.png',
    blau:'assets/img/blau.png',
    gruen:'assets/img/gruen.png',
    gelb:'assets/img/gelb.png',
    stoer:'assets/img/stoer.png'
  };
  const COLORS_ALL = Object.keys(IMG);
  const COLORS_NO_STOER = COLORS_ALL.filter(c=>c!=='stoer');

  /* ===== Sound ===== */
  const audio = {
    lever:   new Audio('assets/snd/lever.mp3'),
    dreh:    new Audio('assets/snd/dreh.mp3'),
    anhalten:new Audio('assets/snd/anhalten.mp3'),
    ergebnis:new Audio('assets/snd/ergebnis.mp3'),
    fanfare: new Audio('assets/snd/fanfare.mp3'),
    stoer:   new Audio('assets/snd/stoer.mp3'),
    get enabled(){ return getVar('--sound-enabled')==='1'; }
  };
  audio.dreh.loop = true;
  function safePlay(a){ if(!audio.enabled) return; try{ a.currentTime=0; a.play(); }catch{} }
  function safeStop(a){ try{ a.pause(); a.currentTime=0; }catch{} }

  const soundBtn = $('#soundToggle');
  function syncSoundBtn(){
    const on = getVar('--sound-enabled')==='1';
    soundBtn.textContent = on ? 'üîä Sound: AN' : 'üîá Sound: AUS';
    $('#dbgSound').checked = on;
  }
  soundBtn.addEventListener('click', ()=>{
    const on = getVar('--sound-enabled')==='1';
    setVar('--sound-enabled', on?'0':'1');
    if(on) safeStop(audio.dreh);
    syncSoundBtn();
  });
  syncSoundBtn();

  /* ===== Exit-Button ‚Üí Weiterleitung ===== */
  const exitBtn = $('#exitBtn');
  function applyExitBtnFromVars(){
    exitBtn.textContent = getVar('--exit-button-label').replace(/(^"|"$)/g,'') || 'Beenden';
  }
  applyExitBtnFromVars();
  exitBtn.addEventListener('click', ()=>{
    const need = getVar('--exit-requires-confirm')==='1';
    const url = 'https://schlachtenbummler-verlag.jimdosite.com/neu/';
    if(!need){ location.href=url; return; }
    const msg = getVar('--exit-confirm-text').replace(/(^"|"$)/g,'') || 'Wirklich beenden?';
    if(confirm(msg)) location.href=url;
  });

  /* ===== Reels, Lamps, Result ===== */
  const reelsWrap = $('#reels');
  const reels = $$('#reels .reel');
  const nameEl = $('#resName'), descEl = $('#resDesc'), ptsEl = $('#resPts');

  function setSymbol(reelEl, color){
    const imgEl = reelEl.querySelector('img');
    if(imgEl){ imgEl.src = IMG[color]; imgEl.alt = color; }
  }
  const rndFrom = arr => arr[(Math.random()*arr.length)|0];
  const rndAll = () => rndFrom(COLORS_ALL);
  const rndNoStoer = () => rndFrom(COLORS_NO_STOER);
  reels.forEach(r=> setSymbol(r, rndNoStoer()));

  const lamps = { gold:$('#lampGold'), blue:$('#lampBlue'), green:$('#lampGreen'), red:$('#lampRed') };

  function getVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
  function setVar(n, v){
    const root=document.documentElement;
    if(n.endsWith('-size') && typeof v==='number') root.style.setProperty(n, v+'rem');
    else if(/--(result-shine-speed|shine-speed|lamp-afterglow)$/.test(n)) root.style.setProperty(n, parseFloat(v)+'s');
    else if(n==='--shine-angle' || n==='--scan-angle') root.style.setProperty(n, parseFloat(v)+'deg');
    else root.style.setProperty(n, v);
  }

  /* Lampen-Logik */
  const lampTimers = new WeakMap();
  function clearLampTimers(){
    Object.values(lamps).forEach(n=>{
      const t = lampTimers.get(n);
      if(t){ clearTimeout(t); lampTimers.delete(n); }
      n.classList.remove('active','glow');
    });
  }
  function flashLamp(el){
    clearLampTimers();
    el.classList.add('active','glow');
    const sec = parseFloat(getVar('--lamp-afterglow')) || 4.2;
    const t = setTimeout(()=>{ el.classList.remove('active','glow'); lampTimers.delete(el); }, sec*1000);
    lampTimers.set(el, t);
  }
  function setLampsByScore(score){
    if(score >= 13)      flashLamp(lamps.gold);
    else if(score >= 10) flashLamp(lamps.blue);
    else if(score >= 6)  flashLamp(lamps.green);
    else                 flashLamp(lamps.red);
  }
  function allLampsOff(){ Object.values(lamps).forEach(l=> l.classList.remove('active','glow')); }
  function chaosLamps(ms=1200){
    const els = Object.values(lamps); let t=0;
    const int = setInterval(()=>{
      els.forEach(l=> l.classList.remove('active','glow'));
      const count = 1 + (Math.random()*3|0);
      for(let i=0;i<count;i++){ els[Math.random()*els.length|0].classList.add('active'); }
      t+=120; if(t>=ms){ clearInterval(int); allLampsOff(); }
    }, 120);
  }

  /* ===== Vibration (progressiv) ===== */
  let vibInterval=null, vibStart=0;
  function startVibration(){
    if(!("vibrate" in navigator)) return;
    vibStart = Date.now();
    stopVibration();
    vibInterval = setInterval(()=>{
      const dur = Date.now()-vibStart;
      if(dur < 800){
        navigator.vibrate(10);
      } else if(dur < 2000){
        navigator.vibrate([18,28]);
      } else {
        navigator.vibrate([28,18,28]);
      }
    }, 180);
  }
  function stopVibration(){
    if(vibInterval){ clearInterval(vibInterval); vibInterval=null; }
    if("vibrate" in navigator) navigator.vibrate(0);
  }

  /* ===== Rezepte ===== */
  const RECIPES = {
    'rot,rot,rot,rot':   {name:'D√∂sselheimer G√ºllebier', pts:15, desc:'Die braune Seele Saxoniens.'},
    'blau,blau,blau,blau': {name:'Leberknebel - Export', pts:15, desc:'Seitenstechen auch ohne Meuchelm√∂rder.'},
    'gruen,gruen,gruen,gruen': {name:'Braune So√üe', pts:14, desc:'Z√§hfl√ºssig, herzhaft, l√∂st Sorgen und Rost.'},
    'gelb,gelb,gelb,gelb': {name:'Flotter Otto - Extra Hell', pts:14, desc:'Flie√üt es erst heraus, bleibst du lieber gleich zuhaus!'},
    'rot,rot,rot,blau':  {name:'Klemritzer Nierenquetscher', pts:13, desc:'Massiert die Organe von innen nach au√üen.'},
    'rot,rot,rot,gruen': {name:'R√ºlpsheimer Starkbier', pts:13, desc:'Schenkt Bass im Bauch.'},
    'rot,rot,rot,gelb':  {name:'Lord Villains Glanzparade', pts:13, desc:'Edel und unbestechlich herb.'},
    'blau,blau,blau,rot':  {name:'Donnerburger Stei√ütritt', pts:13, desc:'Treffsicherer Geschmack.'},
    'blau,blau,blau,gruen':{name:'Hassnitzer Kellerbr√§u', pts:13, desc:'Aus dem ganz dunklen Fass.'},
    'blau,blau,blau,gelb': {name:'Stinkhornsuppe - Spezial', pts:13, desc:'Duftet nach Abenteuer, Freiheit und alten Socken.'},
    'gruen,gruen,gruen,rot': {name:'Pl√§rrener Humpentrunk', pts:13, desc:'Gro√ü im Glas, laut im Kopf.'},
    'gruen,gruen,gruen,blau':{name:'Hassburger Urstoff Br√ºhe', pts:13, desc:'So bek√∂mmlich wie eine kleine Pilzvergiftung.'},
    'gruen,gruen,gruen,gelb':{name:'Dreschmarer Magenhieb', pts:12, desc:'Direkt, ehrlich, unvergesslich.'},
    'gelb,gelb,gelb,rot':  {name:'Knurrwitzer Abtritt', pts:12, desc:'So m√§nnlich wie konservative Ein-Artikler.'},
    'gelb,gelb,gelb,blau': {name:'Ynnors Schnarchtrunk', pts:12, desc:'Wirkt sofort.'},
    'gelb,gelb,gelb,gruen':{name:'Schwitzwasser Abblende', pts:12, desc:'Leicht bek√∂mmliches D√ºnnbier.'},
    'rot,rot,blau,blau':   {name:'Bei√üburger R√ºbenhamsterwurf', pts:11, desc:'Zwei Paare, ein Ziel.'},
    'rot,rot,gruen,gruen': {name:'Ningelner Nostalgiker - Urtyp', pts:11, desc:'Schmeckt so gut wie fr√ºher, nur besser.'},
    'rot,rot,gelb,gelb':   {name:'Stockheimer Knollentrunk', pts:10, desc:'Dick im Glas, jetzt mit noch mehr Fruchtfleisch.'},
    'blau,blau,gruen,gruen':{name:'Pl√§rrener Feldschorle - Spezial', pts:10, desc:'Damit sie auch morgen noch lauthals schreien k√∂nnen.'},
    'blau,blau,gelb,gelb': {name:'Grollst√§dter R√ºbensprudel - Deluxe', pts:9, desc:'Gebraut mit Liebe.'},
    'gruen,gruen,gelb,gelb':{name:'Grimmiger Krauttrunk - Extra Herb', pts:9, desc:'Kratzig im Abgang.'},
    'rot,rot,blau,gruen': {name:'Kellerleichen - Party - Mix', pts:8, desc:'F√ºr N√§chte an die man sich lieber nicht erinnert.'},
    'rot,rot,blau,gelb':  {name:'Broilinger Doppelacker Sud', pts:7, desc:'Das beste aus zwei Welten.'},
    'rot,rot,gruen,gelb': {name:'Feierabend Erntetrunk', pts:7, desc:'Erfrischend wie eine 16 Stundenschicht bei Schnell & Billig.'},
    'blau,blau,rot,gruen': {name:'Zwicker Feldweg - Kn√∂chelknacks', pts:6, desc:'Holprig und bitter.'},
    'blau,blau,rot,gelb':  {name:'Ackerbowle', pts:6, desc:'Erdig-Herb'},
    'blau,blau,gruen,gelb':{name:'Lumpa Umpas goldene Brause - Edel', pts:6, desc:'Kurz aber kr√§ftig.'},
    'gruen,gruen,rot,blau': {name:'Freudloser Hopfenr√ºbling - Hell', pts:5, desc:'Der Spa√ü aus dem Glas.'},
    'gruen,gruen,rot,gelb': {name:'Ackerschorle - Export', pts:5, desc:'Das Erfrischungsgetr√§nk f√ºr jede Arbeit.'},
    'gruen,gruen,blau,gelb':{name:'Winkelst√§dter G√§rtnerpils', pts:5, desc:'Gereift im Biercubus.'},
    'gelb,gelb,rot,blau':  {name:'L√§sterhainer Jodelsprudel', pts:4, desc:'Nach zwei Schlucken singst du.'},
    'gelb,gelb,rot,gruen': {name:'Donnerburger R√ºbensch√§del - Spezial', pts:4, desc:'Gebraut mit Blitz und Donner.'},
    'gelb,gelb,blau,gruen':{name:'Karnickelfangschlag', pts:4, desc:'Erst pelzig auf der Zunge, dann schnell im Abgang.'},
    'rot,blau,gruen,gelb': {name:'Querbeet - Klassik', pts:2, desc:'Von allem ein bisschen.'}
  };

  const keyOf = arr => arr.slice().sort().join(',');
  const RECIPES_INDEX = {};
  Object.keys(RECIPES).forEach(k => { RECIPES_INDEX[keyOf(k.split(','))] = RECIPES[k]; });
  function getRecipeFromColors(colorsArr){ return RECIPES_INDEX[keyOf(colorsArr)]; }

  function setResult(name='', desc='', pts=''){
    nameEl.textContent = name;
    descEl.textContent = desc;
    ptsEl.textContent  = pts;
  }

  /* ===== Hebel ===== */
  const lever = $('#lever');
  const knob  = lever.querySelector('.lever__knob');
  const ring  = lever.querySelector('.lever__ring');
  let dragging=false, startY=0, startVal=0, maxY=200;

  function measure(){ const rect = lever.getBoundingClientRect(); maxY = Math.max(120, rect.height-64); }
  measure(); addEventListener('resize',measure);

  function setKnob(y, withTransition){
    const clamped = Math.max(0, Math.min(maxY, y));
    if(!withTransition){ knob.style.transition='none'; ring.style.transition='none'; }
    knob.style.setProperty('--y', clamped+'px');
    ring.style.transform = `translate(-50%, ${clamped+52}px)`;
    if(!withTransition){ void knob.offsetHeight; knob.style.transition=''; ring.style.transition=''; }
    return clamped;
  }
  function onDown(e){
    dragging=true;
    startY=('touches' in e ? e.touches[0].clientY : e.clientY);
    const cur=parseFloat(getComputedStyle(knob).getPropertyValue('--y'))||0;
    startVal=cur; setKnob(cur,false);
    safePlay(audio.lever);
    startVibration();   // Start Vibration
    askImmersiveOnce();
    e.preventDefault();
  }
  function onMove(e){
    if(!dragging) return;
    const y=('touches' in e ? e.touches[0].clientY : e.clientY);
    const dy=y-startY; setKnob(startVal+dy,false);
    e.preventDefault();
  }
  function onUp(){
    if(!dragging) return; dragging=false;
    stopVibration();
    const cur=parseFloat(getComputedStyle(knob).getPropertyValue('--y'))||0;
    const ratio=cur/(maxY||1);
    setKnob(0,true);
    if(ratio>=0.8) spin();
  }
  lever.addEventListener('mousedown',onDown); addEventListener('mousemove',onMove); addEventListener('mouseup',onUp);
  lever.addEventListener('touchstart',onDown,{passive:false}); addEventListener('touchmove',onMove,{passive:false}); addEventListener('touchend',onUp);
  lever.addEventListener('keydown',e=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); setKnob(maxY,true); setTimeout(()=>{ setKnob(0,true); spin(); },180); } });

  /* ===== Spin ===== */
  let spinning=false; let timers=[]; let intervals=[];
  function clearTimers(){ intervals.forEach(i=>clearInterval(i)); intervals=[]; timers.forEach(t=>clearTimeout(t)); timers=[]; }

  function spin(){
    if(spinning) return; spinning=true;
    setResult('‚Ä¶suche Rezept‚Ä¶','','');
    reelsWrap.classList.add('spinning');
    safePlay(audio.dreh);

    const STOER_CHANCE = 40;
    const willForceStoerStop = ((Math.random()*STOER_CHANCE)|0)===0;

    reels.forEach((r,i)=>{
      r.classList.add('spinning');
      r.querySelector('.streak').hidden=false;
      const intId = setInterval(()=> setSymbol(r, rndAll()), 92);
      intervals.push(intId);
    });

    const stopBase=[1100,1750,2400,3050];
    let finalColors = [];

    reels.forEach((r,i)=>{
      const to=setTimeout(()=>{
        clearInterval(intervals[i]);
        let finalColor = willForceStoerStop ? 'stoer' : rndNoStoer();
        setSymbol(r, finalColor);
        finalColors[i]=finalColor;

        r.classList.remove('spinning'); r.classList.add('stop-bounce');
        r.querySelector('.streak').hidden=true;
        safePlay(audio.anhalten);
        r.addEventListener('animationend',()=> r.classList.remove('stop-bounce'),{once:true});

        if(i===reels.length-1){
          reelsWrap.classList.remove('spinning');
          safeStop(audio.dreh);

          if(finalColors.every(c=>c==='stoer')){
            chaosLamps(1400);
            setResult('‚ùå Maschine hat eine St√∂rung!','Ziehe Hebel zum Neustart.','');
            safePlay(audio.stoer);
            spinning=false; clearTimers(); return;
          }

          const recipe = getRecipeFromColors(finalColors);
          if(!recipe){
            setResult('Unbekanntes Rezept','(Kombination nicht definiert)','');
            spinning=false; clearTimers(); return;
          }

          setLampsByScore(recipe.pts);
          setResult(recipe.name, recipe.desc, `+${recipe.pts} Thaler`);
          safePlay(audio.ergebnis);
          if(recipe.pts>=13) safePlay(audio.fanfare);

          spinning=false; clearTimers();
        }
      }, stopBase[i]+Math.floor(Math.random()*260));
      timers.push(to);
    });
  }

  /* ===== Debug Panel Logik ===== */
  const dbgToggle = $('#dbgToggle');
  const dbgPanel  = $('#dbgPanel');
  const dbgClose  = $('#dbgClose');
  const dbgOutlines = $('#dbgOutlines');
  const dbgSound    = $('#dbgSound');
  const alphaSound  = $('#alphaSound');
  const alphaExit   = $('#alphaExit');

  // √ñffnen/Schlie√üen
  dbgToggle.addEventListener('click', ()=> dbgPanel.style.display = (dbgPanel.style.display==='block'?'none':'block') );
  dbgClose.addEventListener('click', ()=> dbgPanel.style.display='none');

  // Initialwerte in die Controls spiegeln
  function syncDbgInputs(){
    dbgOutlines.checked = document.body.classList.contains('debug');
    dbgSound.checked = (getVar('--sound-enabled')==='1');
    alphaSound.value = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--sound-btn-alpha')) || 1;
    alphaExit.value  = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--exit-btn-alpha'))  || 1;
  }
  syncDbgInputs();

  // Outlines
  dbgOutlines.addEventListener('change', ()=> document.body.classList.toggle('debug', dbgOutlines.checked));

  // Sound-Checkbox
  dbgSound.addEventListener('change', ()=>{
    setVar('--sound-enabled', dbgSound.checked ? '1' : '0');
    if(!dbgSound.checked) safeStop(audio.dreh);
    syncSoundBtn();
  });

  // Transparenzen
  alphaSound.addEventListener('input', ()=> document.documentElement.style.setProperty('--sound-btn-alpha', alphaSound.value));
  alphaExit.addEventListener('input',  ()=> document.documentElement.style.setProperty('--exit-btn-alpha',  alphaExit.value));

})();
</script>
</body>
</html>
