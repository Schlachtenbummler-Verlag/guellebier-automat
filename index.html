<!doctype html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>Saxonischer Automat (Design-Space 1920×1080)</title>
<style>
  /* ====== Design-Space Grundwerte ====== */
  :root{
    /* feste Bühne */
    --design-w: 1920;
    --design-h: 1080;

    /* Reel-Fenster (PX in 1920×1080) */
    --r-top:   340;   /* y */
    --r-w:     270;   /* width */
    --r-h:     270;   /* height */
    --r0-left: 300;   /* x */
    --r1-left: 640;
    --r2-left: 980;
    --r3-left: 1320;

    /* Ergebnisfenster (PX) */
    --res-left: 280;
    --res-top:  740;
    --res-w:    1360;
    --res-h:    200;

    /* Hebel/Lampen (PX, Zentrum) */
    --lever-x: 150;
    --lever-y: 560;
    --lamps-x: 1770;
    --lamps-y: 520;

    /* Proportionale Skalen innerhalb des Design-Space */
    --reel-scale: 1;
    --lever-scale: 1;
    --lamps-scale: 1;

    /* UI Buttons (gleich groß) */
    --ui-btn-w: 220px;
    --ui-btn-h: 52px;
    --ui-opacity: 0.85;         /* nur Hintergrund/Border */
    --ui-radius: 12px;
    --ui-pad-x: 14px;
    --ui-pad-y: 10px;

    /* Sound & Exit Position relativ zum Viewportrand */
    --sound-x: 12px;
    --sound-y: 12px;
    --exit-x:  12px;
    --exit-y:  72px;

    /* Farben */
    --lamp-red:   #ff4d4d;
    --lamp-green: #4cd964;
    --lamp-blue:  #4da6ff;
    --lamp-gold:  #ffd400;

    /* Ergebnis-Text */
    --result-name-color:   #ffffff;
    --result-desc-color:   #e8e8e8;
    --result-points-color: #ffd24a;
    --result-name-size:    32px; /* px */
    --result-desc-size:    24px; /* px */
    --result-points-size:  26px; /* px */

    /* Schimmer */
    --shine-angle: 120deg;
    --shine-core:  .20;
    --shine-speed: 9s;      /* globaler Sweep */
    --scan-angle:  180deg;
    --scan-thickness: 1px;
    --scan-spacing:  3px;
    --scan-bright: rgba(255,255,255,.08);
    --scan-dark:   rgba(0,0,0,0);
    --scan-opacity: .22;
    --scan-blend: overlay;

    /* Lampen */
    --lamps-gap: 10px;
    --lamp-afterglow: 4.2s;

    /* Sound */
    --sound-enabled: 1;

    /* Debug Farben */
    --outline-reel:   #4dbbff;
    --outline-result: #59ffa1;

    /* Buttons Label (nur Info) */
    --exit-label:  "Beenden";
    --sound-label: "Sound";

    /* Startscreen */
    --start-bg: #000;
    --start-fg: #fff;

    /* Hebel-Grenzen */
    --lever-bottom-clearance: 6;  /* px Luft bis Schlitz-Ende (Sicherheitsabstand) */
    --lever-ring-offset: 52;      /* Abstand: Knauf-Y → Ring-Oberkante */
    --lever-ring-h: 8;            /* Ring-Höhe (px) */
}
 /* Override ganz unten einfügen */
:root{
  --r-top: 345;
  --r-w: 315;
  --r-h: 271;
  --r0-left: 313;
  --r1-left: 633;
  --r2-left: 952;
  --r3-left: 1273;
  --res-left: 340;
  --res-top: 730;
  --res-w: 1230;
  --res-h: 250;
  --lever-x: 162;
  --lever-y: 546;
  --lamps-x: 1744;
  --lamps-y: 492;
  --reel-scale: 1;
  --lever-scale: 1.5;
  --lamps-scale: 0.87;
  --lamps-gap: 49px;
  --lamp-afterglow: 4.2s;
  --ui-btn-w: 124px;
  --ui-btn-h: 46px;
  --ui-opacity: 0.85;
  --shine-core: .20;
  --shine-speed: 9s;
  --shine-angle: 120deg;
  --scan-thickness: 1.5px;
  --scan-spacing: 3px;
  --scan-opacity: 0.3;
  --scan-blend: overlay;
  --result-name-size: 40px;
  --result-desc-size: 35px;
  --result-points-size: 30px;
  --result-name-color: #008040;
  --result-desc-color: #008040;
  --result-points-color: #008040;
  --scan-angle: 180deg;
  --scan-bright: #00ff40;
  --scan-dark: #004000;
  --sound-x: 100px;
  --sound-y: 826px;
  --exit-x: 100px;
  --exit-y: 905px;
  --sound-enabled: 1;
}


   html,body{margin:0;padding:0;height:100%;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif; -webkit-text-size-adjust:100%}
  .stage{position:fixed;inset:0;display:grid;place-items:center; background:#000; padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}
  .canvas{
    position:relative;
    width: calc(var(--design-w) * 1px);
    height: calc(var(--design-h) * 1px);
    transform-origin: top left;
    image-rendering: auto;
  }

  .plate__img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:7;pointer-events:none;}

  .global-sweep{position:absolute; inset:0; z-index:4; pointer-events:none; overflow:hidden;}
  .global-sweep__stripe{
    position:absolute; top:0; bottom:0; left:-120%; width:120%;
    background:linear-gradient(var(--shine-angle),
      rgba(255,255,255,0) 30%,
      rgba(255,255,255,var(--shine-core)) 50%,
      rgba(255,255,255,0) 70%);
    transform:skewX(-20deg);
    animation:sweep var(--shine-speed) linear infinite;
  }
  .apply-clip{ clip-path: url(#winClip); }
  @keyframes sweep{ from{ left:-120%; } to{ left:120%; } }
  .reels.spinning ~ .global-sweep{ display:none; }

  .reels{position:absolute; inset:0; z-index:1; transform:scale(var(--reel-scale)); transform-origin:center;}
  .reel{
    position:absolute;
    top:  calc(var(--r-top) * 1px);
    width:calc(var(--r-w)   * 1px);
    height:calc(var(--r-h)  * 1px);
    display:flex; align-items:center; justify-content:center; overflow:hidden; border-radius:10px;
    background:#111; padding:10px; box-shadow: inset 0 2px 10px rgba(0,0,0,.6), 0 8px 18px rgba(0,0,0,.25);
  }
  #reel-0{left:calc(var(--r0-left) * 1px);}
  #reel-1{left:calc(var(--r1-left) * 1px);}
  #reel-2{left:calc(var(--r2-left) * 1px);}
  #reel-3{left:calc(var(--r3-left) * 1px);}

  .reel::before, .reel::after{ content:""; position:absolute; left:0; right:0; height:22%; pointer-events:none; z-index:3; }
  .reel::before{ top:0;    background:linear-gradient(to bottom, rgba(0,0,0,.6), rgba(0,0,0,0)); }
  .reel::after { bottom:0; background:linear-gradient(to top,    rgba(0,0,0,.6), rgba(0,0,0,0)); }

  .reel .sweep{ display:none !important; }

  .symbol{ position:relative; width:80%; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; overflow:hidden; will-change: transform, filter; transition: filter .2s ease; }
  .symbol img{width:100%;height:100%;object-fit:contain;display:block;}

  .reel.spinning .symbol{ filter: blur(3px) saturate(1.1); animation: spin-jitter .12s linear infinite; }
  @keyframes spin-jitter{ 0%{transform:translateY(-3%)} 50%{transform:translateY(3%)} 100%{transform:translateY(-3%)} }
  .reel.spinning .streak{
    position:absolute; inset:-30% -10%;
    background:linear-gradient(90deg, rgba(255,255,255,0) 30%, rgba(255,255,255,.25) 50%, rgba(255,255,255,0) 70%);
    filter: blur(6px); opacity:.18; transform: rotate(12deg);
    animation: streak .5s linear infinite; pointer-events:none; z-index:4;
  }
  @keyframes streak{ from{transform:rotate(12deg) translateX(-8%)} to{transform:rotate(12deg) translateX(8%)} }
  .reel.stop-bounce .symbol{ animation: stop-bounce .32s cubic-bezier(.2,.8,.2,1) 1; filter:none; }
  @keyframes stop-bounce{ 0%{transform:translateY(10%)} 60%{transform:translateY(-4%)} 100%{transform:translateY(0)} }

  .result{
    position:absolute;
    left: calc(var(--res-left) * 1px);
    top:  calc(var(--res-top)  * 1px);
    width:calc(var(--res-w)    * 1px);
    height:calc(var(--res-h)   * 1px);
    display:grid; place-items:center; text-align:center; padding:8px 10px; z-index:0; line-height:1.25;
    overflow:hidden;
  }
  .result-inner{ display:grid; gap:.35rem; position:relative; z-index:1; }
  .result-inner .name{ color:var(--result-name-color);   font-size:var(--result-name-size);   font-weight:800; letter-spacing:.02em; }
  .result-inner .desc{ color:var(--result-desc-color);   font-size:var(--result-desc-size);   opacity:.95; }
  .result-inner .points{ color:var(--result-points-color); font-size:var(--result-points-size); font-weight:700; }

  .result::after{
    content:""; position:absolute; inset:0; pointer-events:none;
    background: repeating-linear-gradient(
      var(--scan-angle),
      var(--scan-bright) 0,
      var(--scan-bright) var(--scan-thickness),
      var(--scan-dark)   var(--scan-thickness),
      var(--scan-dark)   calc(var(--scan-thickness) + var(--scan-spacing))
    );
    mix-blend-mode: var(--scan-blend);
    opacity: var(--scan-opacity);
    z-index:0;
  }

  .lever-area{
    position:absolute;
    left: calc(var(--lever-x) * 1px);
    top:  calc(var(--lever-y) * 1px);
    transform:translate(-50%,-50%) scale(var(--lever-scale));
    z-index:8;
  }
  .lever{ width:72px; height:300px; position:relative; cursor:grab; user-select:none; touch-action:none; filter: drop-shadow(0 6px 14px rgba(0,0,0,.35)); }
  .lever__back{ position:absolute; inset:0; border-radius:10px; background:linear-gradient(180deg,#1a1a1a,#0f0f0f); box-shadow: inset 0 6px 10px rgba(0,0,0,.6), inset 0 -6px 10px rgba(0,0,0,.4); }
  .lever__slot{ position:absolute; left:50%; top:14px; bottom:14px; width:12px; transform:translateX(-50%); background:#080808; border-radius:8px; box-shadow: inset 0 0 10px rgba(0,0,0,.9); }
  .lever__arm{ position:absolute; left:50%; top:22px; width:6px; bottom:22px; transform:translateX(-50%); background:linear-gradient(180deg,#555,#2a2a2a); border-radius:3px; box-shadow: inset 0 0 4px rgba(0,0,0,.6); }
  .lever__knob{
    --y:0px; position:absolute; left:50%; top:0; width:56px; height:56px; transform:translate(-50%, var(--y));
    border-radius:50%;
    background: radial-gradient(circle at 30% 30%, #ffb8b8, #ff4a4a 45%, #d33c3c 75%, #8a1d1d 100%);
    box-shadow: 0 10px 18px rgba(0,0,0,.45), inset 0 2px 0 rgba(255,255,255,.35);
    overflow:hidden;
  }
  .lever__knob::after{
    content:""; position:absolute; inset:0; border-radius:50%;
    background:linear-gradient(120deg, rgba(255,255,255,.65) 0%, rgba(255,255,255,0) 40%);
    mix-blend-mode:screen; opacity:.35; pointer-events:none; animation: knobShine 3s linear infinite;
  }
  @keyframes knobShine{ from{ transform:translateX(-100%) rotate(25deg);} to{ transform:translateX(100%) rotate(25deg);} }
  .lever__ring{ position:absolute; left:50%; width:32px; height:8px; transform:translate(-50%, calc(var(--y) + 52px)); background:linear-gradient(180deg,#777,#333); border-radius:8px; filter:blur(.2px); }

  .lamps-area{
    position:absolute;
    left: calc(var(--lamps-x) * 1px);
    top:  calc(var(--lamps-y) * 1px);
    transform:translate(-50%,-50%) scale(var(--lamps-scale));
    z-index:8;
    display:flex; flex-direction:column; gap: max(var(--lamps-gap), 8px);
  }
  @supports not (gap: 1px) {
    .lamps-area .lamp + .lamp{ margin-top: max(var(--lamps-gap), 8px); }
  }

  .lamp{
    pointer-events:none; user-select:none; min-width:160px; height:56px; padding:0 16px;
    display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden;
    border-radius:32px; background:linear-gradient(180deg,#2f2f2f,#161616);
    box-shadow: inset 0 4px 10px rgba(0,0,0,.7), inset 0 -4px 8px rgba(0,0,0,.5);
  }
  .lamp__label{ font-weight:900; letter-spacing:.08em; text-transform:uppercase; color:#8a8aa0; text-shadow: 0 1px 0 rgba(0,0,0,.6); }
  .lamp__shine{ content:""; position:absolute; inset:0; background: radial-gradient(ellipse at 50% -30%, rgba(255,255,255,.25), rgba(255,255,255,0) 45%); opacity:.35; mix-blend-mode:screen; }

  .lamp--red.active{   background: radial-gradient(circle at 50% 20%, #ffd6d6 0%, #ff4d4d 40%, #b11717 70%, #4a0a0a 100%); box-shadow: 0 0 18px 6px rgba(255,80,80,.55), 0 0 36px 16px rgba(255,80,80,.22); animation: lampPulse 1.2s ease-out 1; }
  .lamp--green.active{ background: radial-gradient(circle at 50% 20%, #eaffea 0%, #4cd964 40%, #1db954 70%, #0e3f1d 100%); box-shadow: 0 0 18px 6px rgba(80,255,120,.55), 0 0 36px 16px rgba(80,255,120,.22); animation: lampPulse 1.2s ease-out 1; }
  .lamp--blue.active{  background: radial-gradient(circle at 50% 20%, #e2efff 0%, #4da6ff 40%, #175ab1 70%, #0a224a 100%); box-shadow: 0 0 18px 6px rgba(80,120,255,.55), 0 0 36px 16px rgba(80,120,255,.22); animation: lampPulse 1.2s ease-out 1; }
  .lamp--gold.active{  background:#FFD400; box-shadow: 0 0 18px 6px rgba(255,212,0,.65), 0 0 36px 16px rgba(255,212,0,.28); animation: lampPulse 1.2s ease-out 1; }
  @keyframes lampPulse{ 0%{box-shadow:0 0 0 0 rgba(255,255,255,0)} 60%{box-shadow:0 0 28px 12px rgba(255,255,255,.65)} 100%{box-shadow:0 0 18px 6px rgba(255,255,255,.4)} }
  .lamp.glow::after{ content:""; position:absolute; inset:-10px; border-radius:inherit; opacity:0; filter: blur(10px); pointer-events:none; animation: afterglow var(--lamp-afterglow) ease-out forwards; }
  .lamp--gold.glow::after { background: radial-gradient(ellipse at 50% 50%, rgba(255,212,0,.90), rgba(255,212,0,.45) 42%, rgba(255,212,0,0) 70%); }
  .lamp--red.glow::after  { background: radial-gradient(ellipse at 50% 50%, rgba(255,110,110,.85), rgba(255,80,80,.35) 40%, rgba(255,80,80,0) 70%); }
  .lamp--green.glow::after{ background: radial-gradient(ellipse at 50% 50%, rgba(120,255,160,.85), rgba(80,255,120,.35) 40%, rgba(80,255,120,0) 70%); }
  .lamp--blue.glow::after { background: radial-gradient(ellipse at 50% 50%, rgba(140,180,255,.85), rgba(100,140,255,.35) 40%, rgba(100,140,255,0) 70%); }

  .debug .reel{ outline:2px dashed var(--outline-reel); outline-offset:-2px; }
  .debug .result{ outline:2px dashed var(--outline-result); }
  .debug .lever-area{ outline:2px dashed #ff8a00; outline-offset:4px; }

  @keyframes machine-shake {
    0% { transform: translate(0,0) rotate(0deg); }
    20% { transform: translate(2px,-2px) rotate(-0.2deg); }
    40% { transform: translate(-2px,2px) rotate(0.2deg); }
    60% { transform: translate(1px,-1px) rotate(-0.15deg); }
    80% { transform: translate(-1px,1px) rotate(0.15deg); }
    100% { transform: translate(0,0) rotate(0deg); }
  }
  .canvas.shake { animation: machine-shake 320ms ease; }

  .ui-fixed-btn{
    position:fixed; z-index:2147483601; display:inline-flex; align-items:center; justify-content:center;
    width:var(--ui-btn-w); height:var(--ui-btn-h);
    padding:var(--ui-pad-y) var(--ui-pad-x);
    border-radius:var(--ui-radius);
    border:1px solid rgba(255,255,255,calc(var(--ui-opacity)*.7));
    background: rgba(20,20,20,var(--ui-opacity));
    color:#fff; cursor:pointer; font-weight:800; letter-spacing:.02em;
    backdrop-filter: blur(4px);
    box-sizing:border-box;
  }
  #soundToggle{ left:var(--sound-x); top:var(--sound-y); }
  #exitBtn{ left:var(--exit-x); top:var(--exit-y); text-decoration:none; }

  #dbgToggle{ position:fixed; right:12px; bottom:12px; z-index:2147483647; }

  #dbgPanel{ position:fixed; right:12px; bottom:64px; width:min(92vw,420px); max-height:72vh; overflow:auto; z-index:2147483600; background:#0b0b0b; color:#fff; border:1px solid #333; border-radius:14px; box-shadow:0 12px 28px rgba(0,0,0,.5); display:none; }
  #dbgPanel header{ position:sticky; top:0; padding:10px 12px; background:#101010; border-bottom:1px solid #222; display:flex; align-items:center; justify-content:space-between; gap:8px; cursor:move; }
  #dbgPanel header h4{ margin:0; font-size:1rem; }
  #dbgPanel .grp{ padding:10px 12px; border-top:1px solid #1a1a1a; }
  #dbgPanel .row{ display:grid; grid-template-columns: 1fr auto; align-items:center; gap:8px; margin:6px 0; }
  #dbgPanel label{ font-size:.9rem; color:#ddd; }
  #dbgPanel input[type="range"]{ width:100%; }
  #dbgPanel input[type="number"]{ width:110px; background:#000; color:#fff; border:1px solid #333; border-radius:8px; padding:6px; }
  #dbgPanel input[type="color"]{ width:42px; height:32px; padding:0; border:none; background:transparent; }
  #dbgPanel input[type="text"]{ width:100%; background:#000; color:#fff; border:1px solid #333; border-radius:8px; padding:6px; }

  .startscreen{
    position:fixed; inset:0; display:grid; place-items:center; z-index:2147483602;
    background:var(--start-bg); color:var(--start-fg);
  }
  .startscreen button{
    display:inline-flex; align-items:center; justify-content:center;
    min-width: 280px; min-height:64px; padding:16px 22px;
    border-radius:16px; border:2px solid #fff; background:#111; color:#fff; font-size:1.15rem; font-weight:900; letter-spacing:.03em; cursor:pointer;
  }
  /* Startscreen – große Typo */
  .start-panel{
    max-width: min(1100px, 92vw);
    color:#eee;
    text-align:left;
    padding: 0 16px 28px;
  }
  .start-panel .intro{
    font-style: italic;
    font-size: clamp(18px, 2.2vw, 26px);
    line-height: 1.45;
    margin: 0 0 16px 0;
  }
  .start-panel h2{
    margin: 8px 0 6px 0;
    font-size: clamp(22px, 2.4vw, 32px);
    letter-spacing:.02em;
  }
  .start-panel ol{
    margin: 6px 0 0 1.2em;
    padding:0;
    font-size: clamp(16px, 1.8vw, 22px);
    line-height:1.45;
  }
  .start-actions{
    margin-top: 18px;
    display:flex;
    justify-content:center;
  }

  #rotateOverlay{position:fixed;inset:0;display:none;z-index:9999;background:rgba(0,0,0,.9);color:#FFD700;align-items:center;justify-content:center;text-align:center;padding:20px;box-sizing:border-box}

  /* ---- UI-Buttons im Lampen-Look (aus Script hierher verschoben) ---- */
  .ui-fixed-btn.ui-lamp{
    min-width:160px;
    height:56px;
    padding:0 16px;
    border:none; /* überschreibt Standard-Border */
    border-radius:32px;
    display:flex; align-items:center; justify-content:center;
    background:linear-gradient(180deg,#2f2f2f,#161616);
    color:#fff;
    font-weight:900; letter-spacing:.08em; text-transform:uppercase;
    box-shadow: inset 0 4px 10px rgba(0,0,0,.7), inset 0 -4px 8px rgba(0,0,0,.5);
    cursor:pointer;
  }
  .ui-fixed-btn.ui-lamp::after{
    content:""; position:absolute; inset:0; border-radius:inherit;
    background: radial-gradient(ellipse at 50% -30%, rgba(255,255,255,.25), rgba(255,255,255,0) 45%);
    opacity:.35; mix-blend-mode:screen; pointer-events:none;
  }
  /* Farbvarianten, passend zu .lamp */
  .ui-lamp--blue.active{
    background: radial-gradient(circle at 50% 20%, #e2efff 0%, #4da6ff 40%, #175ab1 70%, #0a224a 100%);
    box-shadow: 0 0 18px 6px rgba(80,120,255,.55), 0 0 36px 16px rgba(80,120,255,.22);
    animation: lampPulse 1.2s ease-out 1;
  }
  .ui-lamp--blue.glow::after{
    background: radial-gradient(ellipse at 50% 50%, rgba(140,180,255,.85), rgba(100,140,255,.35) 40%, rgba(100,140,255,0) 70%);
  }
  .ui-lamp--gold{ color:#222; text-shadow:none; }
  .ui-lamp--gold.active{
    background:#FFD400;
    box-shadow: 0 0 18px 6px rgba(255,212,0,.65), 0 0 36px 16px rgba(255,212,0,.28);
    animation: lampPulse 1.2s ease-out 1;
  }
  .ui-lamp--gold.glow::after{
    background: radial-gradient(ellipse at 50% 50%, rgba(255,212,0,.90), rgba(255,212,0,.45) 42%, rgba(255,212,0,0) 70%);
  }
  /* existierende Größen-Variablen weiter nutzen */
  .ui-fixed-btn.ui-lamp{
    width:var(--ui-btn-w);
    height:var(--ui-btn-h);
  }
  .ui-fixed-btn.ui-lamp{
  color:#8a8aa0;
  text-shadow:0 1px 0 rgba(0,0,0,.6);
}
</style>
</head>
<body>
<div class="startscreen" id="startScreen">
  <div class="start-panel">
    <p class="intro">
      <em>„In Saxonien sprudeln unzählige geheime Güllebier-Rezepte – und kein Mensch kann sie sich alle merken. Darum übernimmt der legendäre Automatron: Eine dampfbetriebene Wundermaschine voller guter Vorsätze (und gelegentlicher Fehlzündungen). Sie spuckt Ernteaufträge aus, streng nach Rezept – und wehe, die Rüben stehen nicht parat!“</em>
    </p>

    <h2>Kurzanleitung</h2>
    <ol>
      <li><b>Hebel ziehen:</b> Ziehe den roten Knauf kräftig nach unten (fast bis zum Ende) und lass los – die Walzen starten.</li>
      <li><b>Kombination abwarten:</b> Die unterschiedlichen Rüben (Farben) ergeben das geheime Güllebier-Rezept und somit euren Ernteauftrag.</li>
      <li><b>Seltenheit & Lohn:</b> Aufträge reichen von einfach bis legendär und werden unterschiedlich vergütet.</li>
      <li><b>Schnell sein:</b> Wer die Rüben-Kombination als erstes auslegen kann, kassiert die Thaler. Für eine neue Runde zieht den Hebel erneut.</li>
    </ol>

    <div class="start-actions">
      <button id="startBtn" type="button">Drücken zum Starten</button>
    </div>
  </div>
</div>


<div class="stage">
  <div class="canvas" id="canvas">
    <svg width="0" height="0" aria-hidden="true">
      <defs>
        <clipPath id="winClip" clipPathUnits="userSpaceOnUse">
          <rect x="0" y="0" width="0" height="0" fill="none" />
          <rect x="300" y="340" width="270" height="270" />
          <rect x="640" y="340" width="270" height="270" />
          <rect x="980" y="340" width="270" height="270" />
          <rect x="1320" y="340" width="270" height="270" />
          <rect x="280" y="740" width="1360" height="200" />
        </clipPath>
      </defs>
    </svg>

    <div class="reels" id="reels">
      <div class="reel" id="reel-0"><div class="sweep"></div><div class="streak" hidden></div><div class="symbol"><img src="assets/img/rot.png" alt=""></div></div>
      <div class="reel" id="reel-1"><div class="sweep"></div><div class="streak" hidden></div><div class="symbol"><img src="assets/img/blau.png" alt=""></div></div>
      <div class="reel" id="reel-2"><div class="sweep"></div><div class="streak" hidden></div><div class="symbol"><img src="assets/img/gruen.png" alt=""></div></div>
      <div class="reel" id="reel-3"><div class="sweep"></div><div class="streak" hidden></div><div class="symbol"><img src="assets/img/gelb.png" alt=""></div></div>
    </div>

    <div class="result" id="gbaResult">
      <div class="result-inner">
        <div class="name" id="resName">Ziehe den Hebel für einen Ernteauftrag!</div>
        <div class="desc" id="resDesc"></div>
        <div class="points" id="resPts"></div>
      </div>
    </div>

    <div class="global-sweep apply-clip" aria-hidden="true"><div class="global-sweep__stripe"></div></div>

    <div class="lever-area">
      <div id="lever" class="lever" role="button" aria-label="Hebel ziehen" tabindex="0">
        <div class="lever__back"></div>
        <div class="lever__slot"></div>
        <div class="lever__arm"></div>
        <div class="lever__knob"></div>
        <div class="lever__ring"></div>
      </div>
    </div>

    <div class="lamps-area">
      <div id="lampGold"  class="lamp lamp--gold"><span class="lamp__label">Legendär</span><div class="lamp__shine"></div></div>
      <div id="lampBlue"  class="lamp lamp--blue"><span class="lamp__label">Mittel</span><div class="lamp__shine"></div></div>
      <div id="lampGreen" class="lamp lamp--green"><span class="lamp__label">Normal</span><div class="lamp__shine"></div></div>
      <div id="lampRed"   class="lamp lamp--red"><span class="lamp__label">Einfach</span><div class="lamp__shine"></div></div>
    </div>

    <img class="plate__img" src="assets/img/overlay.png" alt="Frontplatte">
  </div>
</div>

<div id="rotateOverlay">Bitte Querformat drehen<br><small>(Taste D: Debug-Outlines)</small></div>

<button id="soundToggle" class="ui-fixed-btn ui-lamp ui-lamp--blue" type="button">🔊 SOUND</button>
<a id="exitBtn" class="ui-fixed-btn ui-lamp ui-lamp--gold" href="https://schlachtenbummler-verlag.jimdosite.com/neu/">BEENDEN</a>
<button id="dbgToggle" class="ui-fixed-btn" type="button">🛠️ Debug</button>

<div id="dbgPanel" role="dialog" aria-label="Layout Debug">
  <header>
    <h4>Layout Debug (Design-Space 1920×1080)</h4>
    <div>
      <button class="btn" id="dbgCopyCss">CSS kopieren</button>
      <button class="btn" id="dbgSave">Speichern</button>
      <button class="btn danger" id="dbgReset">Reset</button>
    </div>
  </header>

  <div class="grp">
    <div class="sw"><input type="checkbox" id="dbgOn"> <label for="dbgOn"><strong>Debug an (Outlines)</strong></label></div>
    <div class="sw"><input type="checkbox" id="dbgSoundOn"> <label for="dbgSoundOn"><strong>Sound an</strong></label></div>
  </div>

  <div class="grp"><strong>Walzen-Fenster (px)</strong>
    <div class="row"><label>Top Y <input type="range" min="0" max="1080" step="1" data-var="--r-top"></label><input type="number" step="1" data-var="--r-top"></div>
    <div class="row"><label>W Breite <input type="range" min="50" max="600" step="1" data-var="--r-w"></label><input type="number" step="1" data-var="--r-w"></div>
    <div class="row"><label>H Höhe <input type="range" min="50" max="600" step="1" data-var="--r-h"></label><input type="number" step="1" data-var="--r-h"></div>
    <div class="row"><label>Reel 0 X <input type="range" min="0" max="1920" step="1" data-var="--r0-left"></label><input type="number" step="1" data-var="--r0-left"></div>
    <div class="row"><label>Reel 1 X <input type="range" min="0" max="1920" step="1" data-var="--r1-left"></label><input type="number" step="1" data-var="--r1-left"></div>
    <div class="row"><label>Reel 2 X <input type="range" min="0" max="1920" step="1" data-var="--r2-left"></label><input type="number" step="1" data-var="--r2-left"></div>
    <div class="row"><label>Reel 3 X <input type="range" min="0" max="1920" step="1" data-var="--r3-left"></label><input type="number" step="1" data-var="--r3-left"></div>
  </div>

  <div class="grp"><strong>Ergebnis (px)</strong>
    <div class="row"><label>Left X <input type="range" min="0" max="1920" step="1" data-var="--res-left"></label><input type="number" step="1" data-var="--res-left"></div>
    <div class="row"><label>Top Y <input type="range" min="0" max="1080" step="1" data-var="--res-top"></label><input type="number" step="1" data-var="--res-top"></div>
    <div class="row"><label>Breite <input type="range" min="100" max="1920" step="1" data-var="--res-w"></label><input type="number" step="1" data-var="--res-w"></div>
    <div class="row"><label>Höhe <input type="range" min="60" max="1080" step="1" data-var="--res-h"></label><input type="number" step="1" data-var="--res-h"></div>

    <div class="row"><label>Name Größe px <input type="range" min="10" max="64" step="1" data-var="--result-name-size"></label><input type="number" step="1" data-var="--result-name-size"></div>
    <div class="row"><label>Name Farbe <input type="color" data-var="--result-name-color"></label><input type="text" data-var="--result-name-color" placeholder="#ffffff oder rgba(...)"></div>

    <div class="row"><label>Beschreibung Größe px <input type="range" min="8" max="48" step="1" data-var="--result-desc-size"></label><input type="number" step="1" data-var="--result-desc-size"></div>
    <div class="row"><label>Beschreibung Farbe <input type="color" data-var="--result-desc-color"></label><input type="text" data-var="--result-desc-color" placeholder="#e8e8e8 oder rgba(...)"></div>

    <div class="row"><label>Punkte Größe px <input type="range" min="8" max="48" step="1" data-var="--result-points-size"></label><input type="number" step="1" data-var="--result-points-size"></div>
    <div class="row"><label>Punkte Farbe <input type="color" data-var="--result-points-color"></label><input type="text" data-var="--result-points-color" placeholder="#ffd24a oder rgba(...)"></div>
  </div>

  <div class="grp"><strong>Hebel & Lampen (px + Scale)</strong>
    <div class="row"><label>Hebel X <input type="range" min="0" max="1920" step="1" data-var="--lever-x"></label><input type="number" step="1" data-var="--lever-x"></div>
    <div class="row"><label>Hebel Y <input type="range" min="0" max="1080" step="1" data-var="--lever-y"></label><input type="number" step="1" data-var="--lever-y"></div>
    <div class="row"><label>Hebel Scale <input type="range" min="0.5" max="2" step="0.01" data-var="--lever-scale"></label><input type="number" step="0.01" data-var="--lever-scale"></div>

    <div class="row"><label>Lampen X <input type="range" min="0" max="1920" step="1" data-var="--lamps-x"></label><input type="number" step="1" data-var="--lamps-x"></div>
    <div class="row"><label>Lampen Y <input type="range" min="0" max="1080" step="1" data-var="--lamps-y"></label><input type="number" step="1" data-var="--lamps-y"></div>
    <div class="row"><label>Lampen Scale <input type="range" min="0.5" max="2" step="0.01" data-var="--lamps-scale"></label><input type="number" step="0.01" data-var="--lamps-scale"></div>
    <div class="row"><label>Lampen Abstand <input type="range" min="0" max="100" step="1" data-var="--lamps-gap"></label><input type="number" step="1" data-var="--lamps-gap"></div>
  </div>

  <div class="grp"><strong>UI Buttons</strong>
    <div class="row"><label>Button Breite px <input type="range" min="160" max="360" step="1" data-var="--ui-btn-w"></label><input type="number" step="1" data-var="--ui-btn-w"></div>
    <div class="row"><label>Button Höhe px <input type="range" min="40" max="80" step="1" data-var="--ui-btn-h"></label><input type="number" step="1" data-var="--ui-btn-h"></div>
    <div class="row"><label>Transparenz 0–1 <input type="range" min="0" max="1" step="0.01" data-var="--ui-opacity"></label><input type="number" step="0.01" data-var="--ui-opacity"></div>
  </div>

  <div class="grp"><strong>Buttons (Position)</strong>
    <div class="row"><label>Sound X px <input type="range" min="0" max="1920" step="1" data-var="--sound-x"></label><input type="number" step="1" data-var="--sound-x"></div>
    <div class="row"><label>Sound Y px <input type="range" min="0" max="1080" step="1" data-var="--sound-y"></label><input type="number" step="1" data-var="--sound-y"></div>
    <div class="row"><label>Exit X px <input type="range" min="0" max="1920" step="1" data-var="--exit-x"></label><input type="number" step="1" data-var="--exit-x"></div>
    <div class="row"><label>Exit Y px <input type="range" min="0" max="1080" step="1" data-var="--exit-y"></label><input type="number" step="1" data-var="--exit-y"></div>
  </div>

  <div class="grp"><strong>Schimmer</strong>
    <div class="row"><label>Winkel ° <input type="range" min="0" max="180" step="1" data-var="--shine-angle"></label><input type="number" step="1" data-var="--shine-angle"></div>
    <div class="row"><label>Kern 0–.6 <input type="range" min="0" max="0.6" step="0.01" data-var="--shine-core"></label><input type="number" step="0.01" data-var="--shine-core"></div>
    <div class="row"><label>Speed s <input type="range" min="2" max="20" step="0.1" data-var="--shine-speed"></label><input type="number" step="0.1" data-var="--shine-speed"></div>
  </div>

  <div class="grp"><strong>Scanlines</strong>
    <div class="row"><label>Dicke px <input type="range" min="0.5" max="6" step="0.5" data-var="--scan-thickness"></label><input type="number" step="0.5" data-var="--scan-thickness"></div>
    <div class="row"><label>Abstand px <input type="range" min="0" max="12" step="0.5" data-var="--scan-spacing"></label><input type="number" step="0.5" data-var="--scan-spacing"></div>
    <div class="row"><label>Deckkraft <input type="range" min="0" max="1" step="0.01" data-var="--scan-opacity"></label><input type="number" step="0.01" data-var="--scan-opacity"></div>
    <div class="row"><label>Blend-Mode <input type="text" placeholder="overlay, soft-light..." data-var="--scan-blend"></label><div></div></div>

    <div class="row"><label>Winkel ° <input type="range" min="0" max="360" step="1" data-var="--scan-angle"></label><input type="number" step="1" data-var="--scan-angle"></div>
    <div class="row"><label>Hellfarbe <input type="color" data-var="--scan-bright"></label><input type="text" data-var="--scan-bright" placeholder="#ffffff oder rgba(...)"></div>
    <div class="row"><label>Dunkelfarbe <input type="color" data-var="--scan-dark"></label><input type="text" data-var="--scan-dark" placeholder="transparent oder rgba(...)"></div>
  </div>
</div>


<script>
(function(){
  const $  = s => document.querySelector(s);
  const $$ = s => [...document.querySelectorAll(s)];

  /* ===== Startscreen + Fullscreen ===== */
  const startScreen = $('#startScreen');
  $('#startBtn').addEventListener('click', async ()=>{
    startScreen.style.display='none';
    const el = document.documentElement;
    try{ if(!document.fullscreenElement && el.requestFullscreen){ await el.requestFullscreen(); } }catch{}
  });

  /* ===== Design-Space skalieren ===== */
  const canvas = $('#canvas');
  function fit(){
    const W = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--design-w')) || 1920;
    const H = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--design-h')) || 1080;
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const scale = Math.min(vw / W, vh / H);
    canvas.style.transform = `translate(${(vw - W*scale)/2}px, ${(vh - H*scale)/2}px) scale(${scale})`;
  }
  addEventListener('resize', fit);
  addEventListener('orientationchange', fit);
  document.addEventListener('DOMContentLoaded', fit);

  function checkOrientation(){ $('#rotateOverlay').style.display = (innerHeight>innerWidth)?'flex':'none'; }
  addEventListener('resize',checkOrientation);
  addEventListener('orientationchange',checkOrientation);
  document.addEventListener('DOMContentLoaded',checkOrientation);

  addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='d'){ document.body.classList.toggle('debug'); const cb=$('#dbgOn'); if(cb) cb.checked=document.body.classList.contains('debug'); } });

  /* Assets */
  const IMG = { rot:'assets/img/rot.png', blau:'assets/img/blau.png', gruen:'assets/img/gruen.png', gelb:'assets/img/gelb.png', stoer:'assets/img/stoer.png' };
  const COLORS_ALL = Object.keys(IMG);
  const COLORS_NO_STOER = COLORS_ALL.filter(c=>c!=='stoer');

  /* Sounds */
  const audio = {
    lever:   new Audio('assets/snd/lever.mp3'),
    dreh:    new Audio('assets/snd/dreh.mp3'),
    anhalten:new Audio('assets/snd/anhalten.mp3'),
    ergebnis:new Audio('assets/snd/ergebnis.mp3'),
    fanfare: new Audio('assets/snd/fanfare.mp3'),
    stoer:   new Audio('assets/snd/stoer.mp3'),
    get enabled(){ return getVar('--sound-enabled')==='1'; }
  };
  audio.dreh.loop = true;
  function safePlay(a){ if(!audio.enabled) return; try{ a.currentTime=0; a.play(); }catch{} }
  function safeStop(a){ try{ a.pause(); a.currentTime=0; }catch{} }

  /* UI Buttons */
  const soundBtn = $('#soundToggle');
  function syncSoundBtn(){
  const on = getVar('--sound-enabled')==='1';
  soundBtn.textContent = on ? '🔊 SOUND' : '🔇 SOUND';
  // bisher: leuchtet bei "on"
  // soundBtn.classList.toggle('active', on);
  // soundBtn.classList.toggle('glow', on);

  // neu: leuchtet NUR bei "off"
  soundBtn.classList.toggle('active', !on);
  soundBtn.classList.toggle('glow', !on);
}
  soundBtn.addEventListener('click', ()=>{
    const on = getVar('--sound-enabled')==='1';
    setVar('--sound-enabled', on ? '0' : '1');
    if(on) safeStop(audio.dreh);
    syncSoundBtn();
    const cb = $('#dbgSoundOn'); if(cb) cb.checked = !on;
  });
  syncSoundBtn();

  const exitBtn = $('#exitBtn');
  exitBtn.addEventListener('mousedown', ()=>{
    exitBtn.classList.add('active','glow');
    setTimeout(()=> exitBtn.classList.remove('active','glow'), 800);
  });

  /* Reels & Lamps */
  const reelsWrap = $('#reels');
  const reels = $$('#reels .reel');
  const nameEl = $('#resName'), descEl = $('#resDesc'), ptsEl = $('#resPts');
  function setSymbol(reelEl, color){ const imgEl = reelEl.querySelector('img'); if(imgEl){ imgEl.src = IMG[color]; imgEl.alt = color; } }
  const rndFrom = arr => arr[(Math.random()*arr.length)|0];
  const rndAll = () => rndFrom(COLORS_ALL);
  const rndNoStoer = () => rndFrom(COLORS_NO_STOER);
  reels.forEach(r=> setSymbol(r, rndNoStoer()));

  const lamps = { gold:$('#lampGold'), blue:$('#lampBlue'), green:$('#lampGreen'), red:$('#lampRed') };

  function getVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
  function setVar(n, v){
    const root=document.documentElement;
    if(n==='--shine-angle' || n==='--scan-angle') root.style.setProperty(n, parseFloat(v)+'deg');
    else if(/--(shine-speed|lamp-afterglow)$/.test(n)) root.style.setProperty(n, parseFloat(v)+'s');
    else if(n.startsWith('--ui-btn-') || n==='--ui-opacity') root.style.setProperty(n, String(v));
    else root.style.setProperty(n, v);
  }

  /* Lampen */
  const lampTimers = new WeakMap();
  function clearLampTimers(){ Object.values(lamps).forEach(n=>{ const t = lampTimers.get(n); if(t){ clearTimeout(t); lampTimers.delete(n); } n.classList.remove('active','glow'); }); }
  function flashLamp(el){
    clearLampTimers();
    el.classList.add('active','glow');
    const sec = parseFloat(getVar('--lamp-afterglow')) || 4.2;
    const t = setTimeout(()=>{ el.classList.remove('active','glow'); lampTimers.delete(el); }, sec*1000);
    lampTimers.set(el, t);
  }
  function setLampsByScore(score){
    if(score >= 13)      flashLamp(lamps.gold);
    else if(score >= 10) flashLamp(lamps.blue);
    else if(score >= 6)  flashLamp(lamps.green);
    else                 flashLamp(lamps.red);
  }
  function allLampsOff(){ Object.values(lamps).forEach(l=> l.classList.remove('active','glow')); }
  function chaosLamps(ms=1200){
    const els = Object.values(lamps); let t=0;
    const int = setInterval(()=>{
      els.forEach(l=> l.classList.remove('active','glow'));
      const count = 1 + (Math.random()*3|0);
      for(let i=0;i<count;i++){ const el = els[Math.random()*els.length|0]; el.classList.add('active'); }
      t+=120; if(t>=ms){ clearInterval(int); allLampsOff(); }
    }, 120);
    setTimeout(()=>clearInterval(int), ms+150);
  }

  /* Rezepte */
  const RECIPES = {
    'rot,rot,rot,rot':{name:'Dösselheimer Güllebier',pts:15,desc:'Die braune Seele Saxoniens.'},
    'blau,blau,blau,blau':{name:'Leberknebel - Export',pts:15,desc:'Seitenstechen auch ohne Meuchelmörder.'},
    'gruen,gruen,gruen,gruen':{name:'Braune Soße',pts:14,desc:'Zähflüssig, herzhaft, löst Sorgen und Rost.'},
    'gelb,gelb,gelb,gelb':{name:'Flotter Otto - Extra Hell',pts:14,desc:'Fließt es erst heraus, bleibst du lieber gleich zuhaus!'},
    'rot,rot,rot,blau':{name:'Klemritzer Nierenquetscher',pts:13,desc:'Massiert die Organe von innen nach außen.'},
    'rot,rot,rot,gruen':{name:'Rülpsheimer Starkbier',pts:13,desc:'Schenkt Bass im Bauch.'},
    'rot,rot,rot,gelb':{name:'Lord Villains Glanzparade',pts:13,desc:'Edel und unbestechlich herb.'},
    'blau,blau,blau,rot':{name:'Donnerburger Steißtritt',pts:13,desc:'Treffsicherer Geschmack.'},
    'blau,blau,blau,gruen':{name:'Hassnitzer Kellerbräu',pts:13,desc:'Aus dem ganz dunklen Fass.'},
    'blau,blau,blau,gelb':{name:'Stinkhornsuppe - Spezial',pts:13,desc:'Duftet nach Abenteuer, Freiheit und alten Socken.'},
    'gruen,gruen,gruen,rot':{name:'Plärrener Humpentrunk',pts:13,desc:'Groß im Glas, laut im Kopf.'},
    'gruen,gruen,gruen,blau':{name:'Hassburger Urstoff Brühe',pts:13,desc:'So bekömmlich wie eine kleine Pilzvergiftung.'},
    'gruen,gruen,gruen,gelb':{name:'Dreschmarer Magenhieb',pts:12,desc:'Direkt, ehrlich, unvergesslich.'},
    'gelb,gelb,gelb,rot':{name:'Knurrwitzer Abtritt',pts:12,desc:'So männlich wie konservative Ein-Artikler.'},
    'gelb,gelb,gelb,blau':{name:'Ynnors Schnarchtrunk',pts:12,desc:'Wirkt sofort.'},
    'gelb,gelb,gelb,gruen':{name:'Schwitzwasser Abblende',pts:12,desc:'Leicht bekömmliches Dünnbier.'},
    'rot,rot,blau,blau':{name:'Beißburger Rübenhamsterwurf',pts:11,desc:'Zwei Paare, ein Ziel.'},
    'rot,rot,gruen,gruen':{name:'Ningelner Nostalgiker - Urtyp',pts:11,desc:'Schmeckt so gut wie früher, nur besser.'},
    'rot,rot,gelb,gelb':{name:'Stockheimer Knollentrunk',pts:10,desc:'Dick im Glas, jetzt mit noch mehr Fruchtfleisch.'},
    'blau,blau,gruen,gruen':{name:'Plärrener Feldschorle - Spezial',pts:10,desc:'Damit sie auch morgen noch lauthals schreien können.'},
    'blau,blau,gelb,gelb':{name:'Grollstädter Rübensprudel - Deluxe',pts:9,desc:'Gebraut mit Liebe.'},
    'gruen,gruen,gelb,gelb':{name:'Grimmiger Krauttrunk - Extra Herb',pts:9,desc:'Kratzig im Abgang.'},
    'rot,rot,blau,gruen':{name:'Kellerleichen - Party - Mix',pts:8,desc:'Für Nächte an die man sich lieber nicht erinnert.'},
    'rot,rot,blau,gelb':{name:'Broilinger Doppelacker Sud',pts:7,desc:'Das beste aus zwei Welten.'},
    'rot,rot,gruen,gelb':{name:'Feierabend Erntetrunk',pts:7,desc:'Erfrischend wie eine 16 Stundenschicht bei Schnell & Billig.'},
    'blau,blau,rot,gruen':{name:'Zwicker Feldweg - Knöchelknacks',pts:6,desc:'Holprig und bitter.'},
    'blau,blau,rot,gelb':{name:'Ackerbowle',pts:6,desc:'Erdig-Herb'},
    'blau,blau,gruen,gelb':{name:'Lumpa Umpas goldene Brause - Edel',pts:6,desc:'Kurz aber kräftig.'},
    'gruen,gruen,rot,blau':{name:'Freudloser Hopfenrübling - Hell',pts:5,desc:'Der Spaß aus dem Glas.'},
    'gruen,gruen,rot,gelb':{name:'Ackerschorle - Export',pts:5,desc:'Das Erfrischungsgetränk für jede Arbeit.'},
    'gruen,gruen,blau,gelb':{name:'Winkelstädter Gärtnerpils',pts:5,desc:'Gereift im Biercubus.'},
    'gelb,gelb,rot,blau':{name:'Lästerhainer Jodelsprudel',pts:4,desc:'Nach zwei Schlucken singst du.'},
    'gelb,gelb,rot,gruen':{name:'Donnerburger Rübenschädel - Spezial',pts:4,desc:'Gebraut mit Blitz und Donner.'},
    'gelb,gelb,blau,gruen':{name:'Karnickelfangschlag',pts:4,desc:'Erst pelzig auf der Zunge, dann schnell im Abgang.'},
    'rot,blau,gruen,gelb':{name:'Querbeet - Klassik',pts:2,desc:'Von allem ein bisschen.'}
  };
  const keyOf = arr => arr.slice().sort().join(',');
  const RECIPES_INDEX = {}; Object.keys(RECIPES).forEach(k => { RECIPES_INDEX[keyOf(k.split(','))] = RECIPES[k]; });
  function getRecipeFromColors(colorsArr){ return RECIPES_INDEX[keyOf(colorsArr)] }
  function setResult(name='', desc='', pts=''){ nameEl.textContent = name; descEl.textContent = desc; ptsEl.textContent  = pts; }

  /* ===== Hebel + Endanschlag an Schlitz ===== */
  const lever = $('#lever');
  const knob  = lever.querySelector('.lever__knob');
  const ring  = lever.querySelector('.lever__ring');
  const slot  = lever.querySelector('.lever__slot');
  let dragging=false, startY=0, startVal=0, maxY=200;

  function measure(){
    const leverRect = lever.getBoundingClientRect();
    const knobH = knob.getBoundingClientRect().height || 56;

    // Schlitz-Geometrie relativ zum Hebel
    const slotTop = slot.offsetTop;                      // z.B. 14
    const slotBottom = slotTop + slot.offsetHeight;      // z.B. 286

    // Parameter aus Variablen
    const bc = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--lever-bottom-clearance')) || 6;
    const ringOffset = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--lever-ring-offset')) || 52;
    const ringH = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--lever-ring-h')) || 8;

    // 1) Knauf darf den Hebel nicht unten überragen
    const maxByKnob = (leverRect.height - knobH - bc);

    // 2) Ring muss vollständig im Schlitz bleiben
    //    Ring-Oberkante = y + ringOffset; Unterkante = y + ringOffset + ringH
    const maxByRing = (slotBottom - (ringOffset + ringH) - bc);

    // Endanschlag = kleinster erlaubter Wert, niemals negativ
    maxY = Math.max(0, Math.min(maxByKnob, maxByRing));
  }
  measure();
  addEventListener('resize', measure);

  // Vibrations-Stubbs
  let vibTimer=null, holdStart=0;
  function startVibrationHold(){}
  function stopVibrationHold(){}
  function burstVibration(){}

  function setKnob(y, withTransition){
    const clamped = Math.max(0, Math.min(maxY, y));
    if(!withTransition){ knob.style.transition='none'; ring.style.transition='none'; }
    knob.style.setProperty('--y', clamped+'px');
    ring.style.transform = `translate(-50%, ${clamped + 52}px)`; // 52 = ringOffset (CSS)
    if(!withTransition){ void knob.offsetHeight; knob.style.transition=''; ring.style.transition=''; }
    return clamped;
  }

  function onDown(e){
    measure(); // bei Start neu messen (falls gescaled)
    dragging=true;
    startY=('touches' in e ? e.touches[0].clientY : e.clientY);
    const cur=parseFloat(getComputedStyle(knob).getPropertyValue('--y'))||0;
    startVal=cur; setKnob(cur,false);
    safePlay(audio.lever);
    startVibrationHold();
    e.preventDefault();
  }
  function onMove(e){
    if(!dragging) return;
    const y=('touches' in e ? e.touches[0].clientY : e.clientY);
    const dy=y-startY; setKnob(startVal+dy,false);
    e.preventDefault();
  }
  function onUp(){
    if(!dragging) return; dragging=false;
    stopVibrationHold(); burstVibration();
    const cur=parseFloat(getComputedStyle(knob).getPropertyValue('--y'))||0;
    const ratio=cur/(maxY||1);
    setKnob(0,true);
    if(ratio>=0.8) spin();
  }

  lever.addEventListener('mousedown',onDown);
  addEventListener('mousemove',onMove);
  addEventListener('mouseup',onUp);
  lever.addEventListener('touchstart',onDown,{passive:false});
  addEventListener('touchmove',onMove,{passive:false});
  addEventListener('touchend',onUp);
  lever.addEventListener('keydown',e=>{
    if(e.key===' '||e.key==='Enter'){
      e.preventDefault();
      setKnob(maxY,true);
      setTimeout(()=>{ setKnob(0,true); spin(); },180);
    }
  });

  /* Spin-Logik */
  let spinning=false; let timers=[]; let intervals=[];
  function clearTimers(){ intervals.forEach(i=>clearInterval(i)); intervals=[]; timers.forEach(t=>clearTimeout(t)); timers=[]; }

  function spin(){
    if(spinning) return; spinning=true;
    canvas.classList.add('shake'); setTimeout(()=> canvas.classList.remove('shake'), 360);
    setResult('…suche Rezept…','','');
    reelsWrap.classList.add('spinning');
    safePlay(audio.dreh);

    const STOER_CHANCE = 40;
    const willForceStoerStop = ((Math.random()*STOER_CHANCE)|0)===0;

    reels.forEach((r)=>{
      r.classList.add('spinning');
      r.querySelector('.streak').hidden=false;
      const intId = setInterval(()=> setSymbol(r, rndAll()), 92);
      intervals.push(intId);
    });

    const stopBase=[1100,1750,2400,3050];
    let finalColors = [];

    reels.forEach((r,i)=>{
      const to=setTimeout(()=>{
        clearInterval(intervals[i]);
        const finalColor = willForceStoerStop ? 'stoer' : rndNoStoer();
        setSymbol(r, finalColor);
        finalColors[i]=finalColor;

        r.classList.remove('spinning'); r.classList.add('stop-bounce');
        r.querySelector('.streak').hidden=true;
        safePlay(audio.anhalten);
        r.addEventListener('animationend',()=> r.classList.remove('stop-bounce'),{once:true});

        if(i===reels.length-1){
          reelsWrap.classList.remove('spinning');
          safeStop(audio.dreh);

          if(finalColors.every(c=>c==='stoer')){
            chaosLamps(1400);
            setResult('❌ Maschine hat eine Störung!','Ziehe den Hebel zum Neustart.','');
            safePlay(audio.stoer);
            spinning=false; clearTimers(); return;
          }

          const recipe = getRecipeFromColors(finalColors);
          if(!recipe){
            setResult('Unbekanntes Rezept','(Kombination nicht definiert)','');
            spinning=false; clearTimers(); return;
          }

          setLampsByScore(recipe.pts);
          setResult(recipe.name, recipe.desc, `+${recipe.pts} Thaler`);
          safePlay(audio.ergebnis);
          if(recipe.pts>=13) safePlay(audio.fanfare);

          spinning=false; clearTimers();
        }
      }, stopBase[i]+Math.floor(Math.random()*260));
      timers.push(to);
    });
  }

  /* ===== Debug-Panel, Storage & Drag ===== */
  (function(){
    const BUILD_VERSION = (new URLSearchParams(location.search).get('dbgver')) || '2025-09-01-a';
    const STORAGE_PREFIX = 'rezep_debug_vars';
    const STORAGE_KEY    = `${STORAGE_PREFIX}_${BUILD_VERSION}`;
    const DBG_KEY        = `${STORAGE_PREFIX}_flag_${BUILD_VERSION}`;
    const POS_KEY        = `${STORAGE_PREFIX}_panelpos_${BUILD_VERSION}`;
    const posStore       = sessionStorage;

    const root   = document.documentElement;
    const panel  = $('#dbgPanel');
    const dbgOn  = $('#dbgOn');
    const dbgSoundOn = $('#dbgSoundOn');

    function getVarLocal(n){ return getComputedStyle(root).getPropertyValue(n).trim(); }
    function flashSaved(sel, okText='✅ Gespeichert'){
      const btn = document.querySelector(sel); if(!btn) return;
      const prev = btn.textContent; btn.disabled = true; btn.textContent = okText;
      setTimeout(()=>{ btn.textContent = prev; btn.disabled = false; }, 1200);
    }

    const VARS_PX      = ['--r-top','--r-w','--r-h','--r0-left','--r1-left','--r2-left','--r3-left','--res-left','--res-top','--res-w','--res-h','--lever-x','--lever-y','--lamps-x','--lamps-y'];
    const VARS_SCALE   = ['--reel-scale','--lever-scale','--lamps-scale'];
    const VARS_LAMPS   = ['--lamps-gap','--lamp-afterglow'];
    const VARS_UI      = ['--ui-btn-w','--ui-btn-h','--ui-opacity'];
    const VARS_SHINE   = ['--shine-core','--shine-speed','--shine-angle'];
    const VARS_SCAN    = ['--scan-thickness','--scan-spacing','--scan-opacity','--scan-blend'];
    const VARS_MISC    = ['--sound-enabled'];
    const VARS_TEXT    = ['--result-name-size','--result-desc-size','--result-points-size','--result-name-color','--result-desc-color','--result-points-color'];
    const VARS_SCAN_X  = ['--scan-angle','--scan-bright','--scan-dark'];
    const VARS_BTN_POS = ['--sound-x','--sound-y','--exit-x','--exit-y'];

    const VARS = [...VARS_PX, ...VARS_SCALE, ...VARS_LAMPS, ...VARS_UI, ...VARS_SHINE, ...VARS_SCAN, ...VARS_TEXT, ...VARS_SCAN_X, ...VARS_BTN_POS, ...VARS_MISC];

    function setVarAuto(n, raw){
      if (VARS_PX.includes(n)) { root.style.setProperty(n, String(parseFloat(raw)||0));
      } else if (n==='--shine-angle' || n==='--scan-angle') { root.style.setProperty(n, (parseFloat(raw)||0) + 'deg');
      } else if (n==='--shine-speed' || n==='--lamp-afterglow') { root.style.setProperty(n, (parseFloat(raw)||0) + 's');
      } else if (n==='--ui-btn-w' || n==='--ui-btn-h') { root.style.setProperty(n, (parseFloat(raw)||0) + 'px');
      } else if (n==='--sound-x' || n==='--sound-y' || n==='--exit-x' || n==='--exit-y') { root.style.setProperty(n, (parseFloat(raw)||0) + 'px');
      } else if (n==='--result-name-size' || n==='--result-desc-size' || n==='--result-points-size') { root.style.setProperty(n, (parseFloat(raw)||0) + 'px');
      } else if (n==='--lamps-gap') { root.style.setProperty(n, (parseFloat(raw)||0) + 'px');
      } else if (n==='--scan-thickness' || n==='--scan-spacing') { root.style.setProperty(n, (parseFloat(raw)||0) + 'px');
      } else { root.style.setProperty(n, raw); }
    }

    function syncClipFromVars(){
      const cp = document.querySelector('#winClip'); if(!cp) return;
      const vals = {
        rtop:+getVarLocal('--r-top'), rw:+getVarLocal('--r-w'), rh:+getVarLocal('--r-h'),
        r0:+getVarLocal('--r0-left'), r1:+getVarLocal('--r1-left'), r2:+getVarLocal('--r2-left'), r3:+getVarLocal('--r3-left'),
        rx:+getVarLocal('--res-left'), ry:+getVarLocal('--res-top'), rw2:+getVarLocal('--res-w'), rh2:+getVarLocal('--res-h')
      };
      const rects = cp.querySelectorAll('rect');
      if(rects.length>=6){
        rects[1].setAttribute('x', vals.r0); rects[1].setAttribute('y', vals.rtop); rects[1].setAttribute('width', vals.rw); rects[1].setAttribute('height', vals.rh);
        rects[2].setAttribute('x', vals.r1); rects[2].setAttribute('y', vals.rtop); rects[2].setAttribute('width', vals.rw); rects[2].setAttribute('height', vals.rh);
        rects[3].setAttribute('x', vals.r2); rects[3].setAttribute('y', vals.rtop); rects[3].setAttribute('width', vals.rw); rects[3].setAttribute('height', vals.rh);
        rects[4].setAttribute('x', vals.r3); rects[4].setAttribute('y', vals.rtop); rects[4].setAttribute('width', vals.rw); rects[4].setAttribute('height', vals.rh);
        rects[5].setAttribute('x', vals.rx); rects[5].setAttribute('y', vals.ry); rects[5].setAttribute('width', vals.rw2); rects[5].setAttribute('height', vals.rh2);
      }
    }

    function save(){
      try{
        const out={}; VARS.forEach(n=> out[n]=getVarLocal(n));
        localStorage.setItem(STORAGE_KEY, JSON.stringify(out));
        localStorage.setItem(DBG_KEY, document.body.classList.contains('debug')?'1':'0');
        const t=$('#dbgToggle'); t.textContent='✅ Gespeichert'; setTimeout(()=> t.textContent='🛠️ Debug', 900);
      }catch(err){ console.error('Save failed:', err); }
    }
    function load(){
      const raw=localStorage.getItem(STORAGE_KEY);
      if(raw){ try{ const obj=JSON.parse(raw); Object.entries(obj).forEach(([k,v])=>{ if(VARS.includes(k)) setVarAuto(k,v); }); }catch{} }
      const df=localStorage.getItem(DBG_KEY);
      document.body.classList.toggle('debug', df==='1');
      if(dbgOn) dbgOn.checked=document.body.classList.contains('debug');

      if(dbgSoundOn) dbgSoundOn.checked = getVarLocal('--sound-enabled')==='1';
      syncSoundBtn();
      syncInputs();
      syncClipFromVars();
      fit();
    }
    function reset(){
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(DBG_KEY);
      [...VARS].forEach(n=> root.style.removeProperty(n));
      syncInputs(); syncClipFromVars(); fit();
    }
    function stripUnit(name, val){
      if (name==='--shine-angle' || name==='--scan-angle') return parseFloat(val)||0;
      if (name==='--shine-speed' || name==='--lamp-afterglow') return parseFloat(val)||0;
      if (name.startsWith('--ui-btn-')) return parseFloat(val)||0;
      if (name==='--sound-x' || name==='--sound-y' || name==='--exit-x' || name==='--exit-y') return parseFloat(val)||0;
      if (name==='--result-name-size' || name==='--result-desc-size' || name==='--result-points-size') return parseFloat(val)||0;
      if (name==='--lamps-gap') return parseFloat(val)||0;
      if (name==='--scan-thickness' || name==='--scan-spacing') return parseFloat(val)||0;
      if (VARS_PX.includes(name)) return parseFloat(val)||0;
      return (val||'').replace(/(^"|"$)/g,'');
    }
    function syncInputs(){
      panel.querySelectorAll('[data-var]').forEach(inp=>{
        const name = inp.getAttribute('data-var');
        const cssVal = getVarLocal(name);
        if (inp.type === 'color') {
          if (/^#([0-9a-f]{3}|[0-9a-f]{6}|[0-9a-f]{8})$/i.test(cssVal)) { inp.value = cssVal; } else { inp.value = '#ffffff'; }
        } else if (inp.type === 'text') { inp.value = cssVal;
        } else { inp.value = stripUnit(name, cssVal); }
      });
    }

    $('#dbgToggle').addEventListener('click', ()=> panel.style.display = (panel.style.display==='block'?'none':'block') );
    panel.addEventListener('input', (e)=>{
      const el=e.target; if(!el.matches('[data-var]')) return;
      const name=el.getAttribute('data-var'); let raw=el.value;
      if(name==='--lamps-gap') raw = String(Math.max(8, parseFloat(raw)||0));
      setVarAuto(name, raw);
      panel.querySelectorAll(`[data-var="${name}"]`).forEach(x=>{ if(x!==el) x.value=raw; });
      if(VARS_PX.includes(name)) syncClipFromVars();
      if(name.startsWith('--ui-btn-')) fit();
      if(name==='--lever-scale') measure();
    });

    document.getElementById('dbgSave').addEventListener('click', save);
    document.getElementById('dbgReset').addEventListener('click', reset);
    document.getElementById('dbgCopyCss').addEventListener('click', ()=>{
      const css=':root{\n'+VARS.map(n=>`  ${n}: ${getVarLocal(n)};`).join('\n')+'\n}';
      if(navigator.clipboard) navigator.clipboard.writeText(css);
    });

    if(dbgOn) dbgOn.addEventListener('change', ()=>{ document.body.classList.toggle('debug', dbgOn.checked); });
    if(dbgSoundOn) dbgSoundOn.addEventListener('change', ()=>{
      root.style.setProperty('--sound-enabled', dbgSoundOn.checked?'1':'0');
      if(!dbgSoundOn.checked) safeStop(audio.dreh);
      syncSoundBtn();
    });

    (function panelDrag(){
      const header = panel.querySelector('header');
      let drag=false, offX=0, offY=0;
      const place=(x,y)=>{ panel.style.left=x+'px'; panel.style.top=y+'px'; panel.style.right='auto'; panel.style.bottom='auto'; };
      const savePos = ()=>{ const r = panel.getBoundingClientRect(); posStore.setItem(POS_KEY, JSON.stringify({x:r.left, y:r.top})); };
      const loadPos = ()=>{ const raw = posStore.getItem(POS_KEY); if(!raw) return; try{ const {x,y} = JSON.parse(raw); if(Number.isFinite(x)&&Number.isFinite(y)) place(x,y); }catch{} };
      document.getElementById('dbgToggle')?.addEventListener('dblclick', ()=>{
        posStore.removeItem(POS_KEY);
        panel.style.left = ''; panel.style.top = ''; panel.style.right = '12px'; panel.style.bottom = '64px';
      });
      header.addEventListener('mousedown', e=>{ drag=true; const r=panel.getBoundingClientRect(); offX=e.clientX-r.left; offY=e.clientY-r.top; e.preventDefault(); });
      addEventListener('mousemove', e=>{ if(!drag) return; place(e.clientX-offX, e.clientY-offY); });
      addEventListener('mouseup', ()=>{ if(drag){ drag=false; savePos(); } });
      header.addEventListener('touchstart', e=>{ drag=true; const t=e.touches[0]; const r=panel.getBoundingClientRect(); offX=t.clientX-r.left; offY=t.clientY-r.top; }, {passive:true});
      addEventListener('touchmove', e=>{ if(!drag) return; const t=e.touches[0]; place(t.clientX-offX, t.clientY-offY); }, {passive:true});
      addEventListener('touchend', ()=>{ if(drag){ drag=false; savePos(); } });
      loadPos();
    })();

    load();
  })();

  $('#dbgToggle').addEventListener('dblclick', ()=>{ const p=$('#dbgPanel'); p.style.display='block'; });
  fit();
})();
</script>
</body>
</html>
