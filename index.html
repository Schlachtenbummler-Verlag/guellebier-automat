<!doctype html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Saxonischer Automat</title>
<style>
  :root{
    /* Scanlines (voll steuerbar) */
    --scan-angle: 180deg;              /* 0..360 ‚Äì 180 = horizontal */
    --scan-thickness: 1px;             /* helle Linienh√∂he */
    --scan-spacing: 3px;               /* Abstand bis zur n√§chsten Linie (exkl. thickness) */
    --scan-bright: rgba(255,255,255,.08); /* helle Linie */
    --scan-dark:   rgba(0,0,0,0);         /* Zwischenraum */
    --scan-opacity: .22;                /* Gesamtopazit√§t 0..1 */
    --scan-blend: overlay;             /* overlay | soft-light | multiply | normal ... */

    /* Reel-Fenster (relativ zu 1920√ó1080) */
    --r-top: 31.48%;
    --r-w:   14.06%;
    --r-h:   25.00%;
    --r0-left: 15.62%;
    --r1-left: 33.85%;
    --r2-left: 52.08%;
    --r3-left: 70.31%;

    /* Ausgabefeld */
    --res-left: 14.58%;
    --res-top:  68.51%;
    --res-w:    70.83%;
    --res-h:    18.51%;

    /* Hebel/Lampen Position */
    --lever-x: 10%;
    --lever-y: 51.5%;
    --lamps-x: 90.5%;
    --lamps-y: 46.5%;

    /* Proportionale Skalen */
    --reel-scale: 1;
    --lever-scale: 1;
    --lamps-scale: 1;

    /* >>> Sound & Exit Buttons steuerbar <<< */
    --sound-x:  12px;
    --sound-y:  12px;
    --sound-scale: 1;

    --exit-x:   12px;
    --exit-y:   60px;
    --exit-scale: 1;

    /* Farben (per Debug √§nderbar) */
    --lamp-red-color:   #ff4d4d;
    --lamp-green-color: #4cd964;
    --lamp-blue-color:  #4da6ff;
    --lamp-gold-color:  #ffd400;
    --outline-reel:     #4dbbff;
    --outline-result:   #59ffa1;

    /* Ergebnis-Text (3 Zeilen) */
    --result-name-color:  #ffffff;
    --result-desc-color:  #e8e8e8;
    --result-points-color:#ffd24a;
    --result-name-size:   1.25rem;
    --result-desc-size:   1rem;
    --result-points-size: 1.1rem;

    /* Schimmer (identisch f√ºr Reels & Result) */
    --shine-angle: 120deg;
    --shine-core:  .20;
    --shine-speed: 60s;       /* Reels */
    --result-shine-speed: 60s; /* Ausgabe */

    /* Lampen-Abstand & Afterglow */
    --lamps-gap: 10px;
    --lamp-afterglow: 4.2s;

    /* Sound */
    --sound-enabled: 1; /* 1=an, 0=aus */

    /* Beenden-Dialog */
    --exit-requires-confirm: 1; /* 1=ja, 0=nein */
    --exit-button-label: "Beenden";
    --exit-confirm-text: "Wirklich beenden?";
  }

  html,body{margin:0;padding:0;width:100%;height:100%;background:#000;overflow:hidden;overscroll-behavior:none;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif;}

  .stage{position:fixed;inset:0;display:grid;place-items:center;}
  .plate{position:relative;width:min(100vw,calc(100vh*(16/9)));height:min(100vh,calc(100vw*(9/16)));}

  .plate__img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;z-index:5;pointer-events:none;}

  /* ===== Reels ===== */
  .reels{position:absolute;inset:0;z-index:1;transform:scale(var(--reel-scale));transform-origin:center;}
  .reel{
    position:absolute; top:var(--r-top); left:0; width:var(--r-w); height:var(--r-h);
    display:flex; align-items:center; justify-content:center; overflow:hidden; border-radius:10px;
    background:#111; padding:10px; box-shadow: inset 0 2px 10px rgba(0,0,0,.6), 0 8px 18px rgba(0,0,0,.25);
  }
  #reel-0{left:var(--r0-left);} #reel-1{left:var(--r1-left);} #reel-2{left:var(--r2-left);} #reel-3{left:var(--r3-left);}

  /* Top/Bottom Vignette */
  .reel::before, .reel::after{ content:""; position:absolute; left:0; right:0; height:22%; pointer-events:none; z-index:3; }
  .reel::before{ top:0;    background:linear-gradient(to bottom, rgba(0,0,0,.6), rgba(0,0,0,0)); }
  .reel::after { bottom:0; background:linear-gradient(to top,    rgba(0,0,0,.6), rgba(0,0,0,0)); }

  /* Einheitlicher Schimmer nur INNEN (wie Ausgabe) */
  .reel .sweep{
    position:absolute; top:0; bottom:0; left:-120%; width:120%;
    background:linear-gradient(var(--shine-angle), rgba(255,255,255,0) 30%, rgba(255,255,255,var(--shine-core)) 50%, rgba(255,255,255,0) 70%);
    transform:skewX(-20deg);
    pointer-events:none; z-index:2;
    animation: sweep var(--shine-speed) linear infinite;
  }
  .reels.spinning .sweep{ display:none; }
  @keyframes sweep{ from{ left:-120%; } to{ left:120%; } }

  .symbol{ position:relative; width:80%; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; overflow:hidden; will-change: transform, filter; transition: filter .2s ease; }
  .symbol img{width:100%;height:100%;object-fit:contain;display:block;}

  .reel.spinning .symbol{ filter: blur(3px) saturate(1.1); animation: spin-jitter .12s linear infinite; }
  @keyframes spin-jitter{ 0%{transform:translateY(-3%)} 50%{transform:translateY(3%)} 100%{transform:translateY(-3%)} }
  .reel.spinning .streak{
    position:absolute; inset:-30% -10%;
    background:linear-gradient(90deg, rgba(255,255,255,0) 30%, rgba(255,255,255,.25) 50%, rgba(255,255,255,0) 70%);
    filter: blur(6px); opacity:.18; transform: rotate(12deg);
    animation: streak .5s linear infinite; pointer-events:none; z-index:4;
  }
  @keyframes streak{ from{transform:rotate(12deg) translateX(-8%)} to{transform:rotate(12deg) translateX(8%)} }
  .reel.stop-bounce .symbol{ animation: stop-bounce .32s cubic-bezier(.2,.8,.2,1) 1; filter:none; }
  @keyframes stop-bounce{ 0%{transform:translateY(10%)} 60%{transform:translateY(-4%)} 100%{transform:translateY(0)} }

  /* Ergebnisfenster (hinter Overlay) + gleicher Schimmer */
  .result{
    position:absolute; left:var(--res-left); top:var(--res-top); width:var(--res-w); height:var(--res-h);
    display:grid; place-items:center; text-align:center; padding:8px 10px; z-index:0; line-height:1.25;
    overflow:hidden; /* WICHTIG: Schimmer & Scanlines clippen */
  }
  .result-inner{ display:grid; gap:.25rem; position:relative; z-index:1; }
  .result-inner .name{ color:var(--result-name-color); font-size:var(--result-name-size); font-weight:800; letter-spacing:.02em; }
  .result-inner .desc{ color:var(--result-desc-color); font-size:var(--result-desc-size); opacity:.95; }
  .result-inner .points{ color:var(--result-points-color); font-size:var(--result-points-size); font-weight:700; }

  /* Schimmer √ºber der Ausgabe */
  .result::before{
    content:""; position:absolute; top:0; bottom:0; left:-120%; width:120%;
    background:linear-gradient(var(--shine-angle), rgba(255,255,255,0) 30%, rgba(255,255,255,var(--shine-core)) 50%, rgba(255,255,255,0) 70%);
    transform:skewX(-20deg); pointer-events:none;
    animation: sweep var(--result-shine-speed) linear infinite;
  }

  /* Scanlines (variablenbasiert) */
  .result::after{
    content:""; position:absolute; inset:0; pointer-events:none;
    background:
      repeating-linear-gradient(
        var(--scan-angle),
        var(--scan-bright) 0,
        var(--scan-bright) var(--scan-thickness),
        var(--scan-dark)   var(--scan-thickness),
        var(--scan-dark)   calc(var(--scan-thickness) + var(--scan-spacing))
      );
    mix-blend-mode: var(--scan-blend);
    opacity: var(--scan-opacity);
    z-index:0;
  }

  /* Hebel */
  .lever-area{ position:absolute; left:var(--lever-x); top:var(--lever-y);
    transform:translate(-50%,-50%) scale(var(--lever-scale)); z-index:6; }
  .lever{ width:72px; height:300px; position:relative; cursor:grab; user-select:none; touch-action:none; filter: drop-shadow(0 6px 14px rgba(0,0,0,.35)); }
  .lever__back{ position:absolute; inset:0; border-radius:10px; background:linear-gradient(180deg,#1a1a1a,#0f0f0f); box-shadow: inset 0 6px 10px rgba(0,0,0,.6), inset 0 -6px 10px rgba(0,0,0,.4); }
  .lever__slot{ position:absolute; left:50%; top:14px; bottom:14px; width:12px; transform:translateX(-50%); background:#080808; border-radius:8px; box-shadow: inset 0 0 10px rgba(0,0,0,.9); }
  .lever__arm{ position:absolute; left:50%; top:22px; width:6px; bottom:22px; transform:translateX(-50%); background:linear-gradient(180deg,#555,#2a2a2a); border-radius:3px; box-shadow: inset 0 0 4px rgba(0,0,0,.6); }
  .lever__knob{
    --y:0px; position:absolute; left:50%; top:0; width:56px; height:56px; transform:translate(-50%, var(--y));
    border-radius:50%;
    background: radial-gradient(circle at 30% 30%,
            #ffb8b8,
            #ff4a4a 45%,
            #d33c3c 75%,
            #8a1d1d 100%);
    box-shadow: 0 10px 18px rgba(0,0,0,.45), inset 0 2px 0 rgba(255,255,255,.35);
    overflow:hidden;
  }
  .lever__knob::after{
    content:""; position:absolute; inset:0; border-radius:50%;
    background:linear-gradient(120deg, rgba(255,255,255,.65) 0%, rgba(255,255,255,0) 40%);
    mix-blend-mode:screen; opacity:.35; pointer-events:none; animation: knobShine 3s linear infinite;
  }
  @keyframes knobShine{ from{ transform:translateX(-100%) rotate(25deg);} to{ transform:translateX(100%) rotate(25deg);} }
  .lever__ring{ position:absolute; left:50%; width:32px; height:8px; transform:translate(-50%, calc(var(--y) + 52px)); background:linear-gradient(180deg,#777,#333); border-radius:8px; filter:blur(.2px); }

  /* Lampen (rechts, oben Legend√§r ‚Üí unten Einfach) */
  .lamps-area{
    position:absolute; left:var(--lamps-x); top:var(--lamps-y);
    transform:translate(-50%,-50%) scale(var(--lamps-scale)); z-index:6;
    display:flex; flex-direction:column; gap:var(--lamps-gap);
  }
  .lamp{
    pointer-events:none; user-select:none; min-width:160px; height:56px; padding:0 16px;
    display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden;
    border-radius:32px; background:linear-gradient(180deg,#2f2f2f,#161616);
    box-shadow: inset 0 4px 10px rgba(0,0,0,.7), inset 0 -4px 8px rgba(0,0,0,.5);
  }
  .lamp__label{ font-weight:900; letter-spacing:.08em; text-transform:uppercase; color:#8a8aa0; text-shadow: 0 1px 0 rgba(0,0,0,.6); }
  .lamp__shine{ content:""; position:absolute; inset:0; background: radial-gradient(ellipse at 50% -30%, rgba(255,255,255,.25), rgba(255,255,255,0) 45%); opacity:.35; mix-blend-mode:screen; pointer-events:none; }

  .lamp--red.active{   background: radial-gradient(circle at 50% 20%, #ffd6d6 0%, #ff4d4d 40%, #b11717 70%, #4a0a0a 100%); box-shadow: 0 0 18px 6px rgba(255,80,80,.55), 0 0 36px 16px rgba(255,80,80,.22); animation: lampPulse 1.2s ease-out 1; }
  .lamp--green.active{ background: radial-gradient(circle at 50% 20%, #eaffea 0%, #4cd964 40%, #1db954 70%, #0e3f1d 100%); box-shadow: 0 0 18px 6px rgba(80,255,120,.55), 0 0 36px 16px rgba(80,255,120,.22); animation: lampPulse 1.2s ease-out 1; }
  .lamp--blue.active{  background: radial-gradient(circle at 50% 20%, #e2efff 0%, #4da6ff 40%, #175ab1 70%, #0a224a 100%); box-shadow: 0 0 18px 6px rgba(80,120,255,.55), 0 0 36px 16px rgba(80,120,255,.22); animation: lampPulse 1.2s ease-out 1; }
  .lamp--gold.active{  background:#FFD400; box-shadow: 0 0 18px 6px rgba(255,212,0,.65), 0 0 36px 16px rgba(255,212,0,.28); animation: lampPulse 1.2s ease-out 1; }
  @keyframes lampPulse{ 0%{box-shadow:0 0 0 0 rgba(255,255,255,0)} 60%{box-shadow:0 0 28px 12px rgba(255,255,255,.65)} 100%{box-shadow:0 0 18px 6px rgba(255,255,255,.4)} }

  .lamp.glow::after{ content:""; position:absolute; inset:-10px; border-radius:inherit; opacity:0; filter: blur(10px); pointer-events:none; animation: afterglow var(--lamp-afterglow) ease-out forwards; }
  .lamp--gold.glow::after { background: radial-gradient(ellipse at 50% 50%, rgba(255,212,0,.90), rgba(255,212,0,.45) 42%, rgba(255,212,0,0) 70%); }
  .lamp--red.glow::after  { background: radial-gradient(ellipse at 50% 50%, rgba(255,110,110,.85), rgba(255,80,80,.35) 40%, rgba(255,80,80,0) 70%); }
  .lamp--green.glow::after{ background: radial-gradient(ellipse at 50% 50%, rgba(120,255,160,.85), rgba(80,255,120,.35) 40%, rgba(80,255,120,0) 70%); }
  .lamp--blue.glow::after { background: radial-gradient(ellipse at 50% 50%, rgba(140,180,255,.85), rgba(100,140,255,.35) 40%, rgba(100,140,255,0) 70%); }
  @keyframes afterglow{ from{opacity:.95} to{opacity:0} }

  /* Hochformat-Hinweis & Debug-Outlines */
  #rotateOverlay{position:fixed;inset:0;display:none;z-index:9999;background:rgba(0,0,0,.9);color:#FFD700;align-items:center;justify-content:center;text-align:center;padding:20px;box-sizing:border-box}
  .debug .reel{ outline:2px dashed var(--outline-reel); outline-offset:-2px; }
  .debug .result{ outline:2px dashed var(--outline-result); }

  /* UI: Buttons unten */
  .ui-fixed-btn{ position:fixed; z-index:2147483601; padding:10px 14px; border-radius:10px; border:1px solid #333; background:#0e0e0e; color:#fff; cursor:pointer; font-weight:700; }

  /* Position/Scale aus Variablen statt festen Werten */
  #soundToggle{
    left:var(--sound-x);
    bottom:var(--sound-y);
    transform:scale(var(--sound-scale));
    transform-origin: bottom left;
  }
  #exitBtn{
    left:var(--exit-x);
    bottom:var(--exit-y);
    transform:scale(var(--exit-scale));
    transform-origin: bottom left;
  }

  /* Debug-Button bleibt rechts unten fix */
  #dbgToggle{ right:12px; bottom:12px; z-index:2147483647; }

  /* Debug Panel */
  #dbgPanel{ position:fixed; right:12px; bottom:64px; width:min(92vw,420px); max-height:72vh; overflow:auto; z-index:2147483600; background:#0b0b0b; color:#fff; border:1px solid #333; border-radius:14px; box-shadow:0 12px 28px rgba(0,0,0,.5); display:none; }
  #dbgPanel header{ position:sticky; top:0; padding:10px 12px; background:#101010; border-bottom:1px solid #222; display:flex; align-items:center; justify-content:space-between; gap:8px; cursor:move; }
  #dbgPanel header h4{ margin:0; font-size:1rem; }
  #dbgPanel .grp{ padding:10px 12px; border-top:1px solid #1a1a1a; }
  #dbgPanel .row{ display:grid; grid-template-columns: 1fr auto; align-items:center; gap:8px; margin:6px 0; }
  #dbgPanel label{ font-size:.9rem; color:#ddd; }
  #dbgPanel input[type="range"]{ width:100%; }
  #dbgPanel input[type="number"]{ width:110px; background:#000; color:#fff; border:1px solid #333; border-radius:8px; padding:6px; }
  #dbgPanel input[type="color"]{ width:42px; height:32px; padding:0; border:none; background:transparent; }
  #dbgPanel input[type="text"]{ width:100%; background:#000; color:#fff; border:1px solid #333; border-radius:8px; padding:6px; }
</style>
</head>
<body>
<div class="stage">
  <div class="plate">
    <!-- Walzen -->
    <div class="reels" id="reels">
      <div class="reel" id="reel-0">
        <div class="sweep"></div><div class="streak" hidden></div>
        <div class="symbol"><img src="assets/img/rot.png" alt=""></div>
      </div>
      <div class="reel" id="reel-1">
        <div class="sweep"></div><div class="streak" hidden></div>
        <div class="symbol"><img src="assets/img/blau.png" alt=""></div>
      </div>
      <div class="reel" id="reel-2">
        <div class="sweep"></div><div class="streak" hidden></div>
        <div class="symbol"><img src="assets/img/gruen.png" alt=""></div>
      </div>
      <div class="reel" id="reel-3">
        <div class="sweep"></div><div class="streak" hidden></div>
        <div class="symbol"><img src="assets/img/gelb.png" alt=""></div>
      </div>
    </div>

    <!-- Ergebnisfeld (hinter Overlay sichtbar) -->
    <div class="result" id="gbaResult">
      <div class="result-inner">
        <div class="name" id="resName">Ziehe den Hebel f√ºr einen Ernteauftrag!</div>
        <div class="desc" id="resDesc"></div>
        <div class="points" id="resPts"></div>
      </div>
    </div>

    <!-- Hebel -->
    <div class="lever-area">
      <div id="lever" class="lever" role="button" aria-label="Hebel ziehen" tabindex="0">
        <div class="lever__back"></div>
        <div class="lever__slot"></div>
        <div class="lever__arm"></div>
        <div class="lever__knob"></div>
        <div class="lever__ring"></div>
      </div>
    </div>

    <!-- Lampen (oben ‚Üí unten) -->
    <div class="lamps-area">
      <div id="lampGold"  class="lamp lamp--gold"><span class="lamp__label">Legend√§r</span><div class="lamp__shine"></div></div>
      <div id="lampBlue"  class="lamp lamp--blue"><span class="lamp__label">Mittel</span><div class="lamp__shine"></div></div>
      <div id="lampGreen" class="lamp lamp--green"><span class="lamp__label">Normal</span><div class="lamp__shine"></div></div>
      <div id="lampRed"   class="lamp lamp--red"><span class="lamp__label">Einfach</span><div class="lamp__shine"></div></div>
    </div>

    <!-- Frontplatte -->
    <img class="plate__img" src="assets/img/overlay.png" alt="Frontplatte">
  </div>
</div>

<div id="rotateOverlay">Bitte Querformat drehen<br><small>(Taste D: Debug-Outlines)</small></div>

<!-- UI: Sound Toggle, Exit & Debug -->
<button id="soundToggle" class="ui-fixed-btn" type="button">üîä Sound: AN</button>
<button id="exitBtn" class="ui-fixed-btn" type="button"></button>
<button id="dbgToggle" class="ui-fixed-btn" type="button">üõ†Ô∏è Debug</button>

<!-- Debug Panel -->
<div id="dbgPanel" role="dialog" aria-label="Layout Debug">
  <header>
    <h4>Layout Debug</h4>
    <div>
      <button class="btn" id="dbgCopyCss">CSS kopieren</button>
      <button class="btn" id="dbgSave">Speichern</button>
      <button class="btn danger" id="dbgReset">Reset</button>
    </div>
  </header>

  <div class="grp">
    <div class="sw"><input type="checkbox" id="dbgOn"> <label for="dbgOn"><strong>Debug an (Outlines)</strong></label></div>
    <div class="sw"><input type="checkbox" id="dbgSoundOn"> <label for="dbgSoundOn"><strong>Sound an</strong></label></div>
  </div>

  <div class="grp"><strong>Walzen (Fenster)</strong>
    <div class="row"><label>Top %     <input type="range"  min="0" max="100" step="0.01" data-var="--r-top"></label><input  type="number" step="0.01" data-var="--r-top"></div>
    <div class="row"><label>Breite %  <input type="range"  min="0" max="100" step="0.01" data-var="--r-w"></label><input   type="number" step="0.01" data-var="--r-w"></div>
    <div class="row"><label>H√∂he %    <input type="range"  min="0" max="100" step="0.01" data-var="--r-h"></label><input   type="number" step="0.01" data-var="--r-h"></div>
    <div class="row"><label>Reel 0 L% <input type="range"  min="0" max="100" step="0.01" data-var="--r0-left"></label><input type="number" step="0.01" data-var="--r0-left"></div>
    <div class="row"><label>Reel 1 L% <input type="range"  min="0" max="100" step="0.01" data-var="--r1-left"></label><input type="number" step="0.01" data-var="--r1-left"></div>
    <div class="row"><label>Reel 2 L% <input type="range"  min="0" max="100" step="0.01" data-var="--r2-left"></label><input type="number" step="0.01" data-var="--r2-left"></div>
    <div class="row"><label>Reel 3 L% <input type="range"  min="0" max="100" step="0.01" data-var="--r3-left"></label><input type="number" step="0.01" data-var="--r3-left"></div>
  </div>

  <div class="grp"><strong>Ausgabefeld</strong>
    <div class="row"><label>Left %    <input type="range"  min="0" max="100" step="0.01" data-var="--res-left"></label><input type="number" step="0.01" data-var="--res-left"></div>
    <div class="row"><label>Top %     <input type="range"  min="0" max="100" step="0.01" data-var="--res-top"></label><input  type="number" step="0.01" data-var="--res-top"></div>
    <div class="row"><label>Breite %  <input type="range"  min="0" max="100" step="0.01" data-var="--res-w"></label><input   type="number" step="0.01" data-var="--res-w"></div>
    <div class="row"><label>H√∂he %    <input type="range"  min="0" max="100" step="0.01" data-var="--res-h"></label><input   type="number" step="0.01" data-var="--res-h"></div>

    <div class="row"><label>Name Gr√∂√üe rem <input type="range" min="0.6" max="2.5" step="0.01" data-var="--result-name-size"></label><input type="number" step="0.01" data-var="--result-name-size"></div>
    <div class="row"><label>Name Farbe <input type="color" data-var="--result-name-color"></label><input type="text" data-var="--result-name-color"></div>

    <div class="row"><label>Beschreibung Gr√∂√üe rem <input type="range" min="0.6" max="2.5" step="0.01" data-var="--result-desc-size"></label><input type="number" step="0.01" data-var="--result-desc-size"></div>
    <div class="row"><label>Beschreibung Farbe <input type="color" data-var="--result-desc-color"></label><input type="text" data-var="--result-desc-color"></div>

    <div class="row"><label>Punkte Gr√∂√üe rem <input type="range" min="0.6" max="2.5" step="0.01" data-var="--result-points-size"></label><input type="number" step="0.01" data-var="--result-points-size"></div>
    <div class="row"><label>Punkte Farbe <input type="color" data-var="--result-points-color"></label><input type="text" data-var="--result-points-color"></div>

    <div class="row"><label>Result Shine s <input type="range"  min="3" max="20" step="0.1" data-var="--result-shine-speed"></label><input type="number" step="0.1" data-var="--result-shine-speed"></div>
  </div>

  <div class="grp"><strong>Hebel</strong>
    <div class="row"><label>X %       <input type="range"  min="0" max="100" step="0.01" data-var="--lever-x"></label><input  type="number" step="0.01" data-var="--lever-x"></div>
    <div class="row"><label>Y %       <input type="range"  min="0" max="100" step="0.01" data-var="--lever-y"></label><input  type="number" step="0.01" data-var="--lever-y"></div>
    <div class="row"><label>Scale √ó   <input type="range"  min="0.5" max="2"   step="0.01" data-var="--lever-scale"></label><input type="number" step="0.01" data-var="--lever-scale"></div>
  </div>

  <div class="grp"><strong>Lampen</strong>
    <div class="row"><label>X %       <input type="range"  min="0" max="100" step="0.01" data-var="--lamps-x"></label><input  type="number" step="0.01" data-var="--lamps-x"></div>
    <div class="row"><label>Y %       <input type="range"  min="0" max="100" step="0.01" data-var="--lamps-y"></label><input  type="number" step="0.01" data-var="--lamps-y"></div>
    <div class="row"><label>Scale √ó   <input type="range"  min="0.5" max="2"   step="0.01" data-var="--lamps-scale"></label><input type="number" step="0.01" data-var="--lamps-scale"></div>
    <div class="row"><label>Abstand px <input type="range" min="0" max="100" step="1" data-var="--lamps-gap"></label><input type="number" step="1" data-var="--lamps-gap"></div>
    <div class="row"><label>Afterglow s <input type="range" min="1" max="15" step="0.1" data-var="--lamp-afterglow"></label><input type="number" step="0.1" data-var="--lamp-afterglow"></div>
  </div>

  <!-- Scanlines -->
  <div class="grp"><strong>Scanlines</strong>
    <div class="row"><label>Winkel ¬∞ <input type="range" min="0" max="360" step="1" data-var="--scan-angle"></label><input type="number" step="1" data-var="--scan-angle"></div>
    <div class="row"><label>Dicke px <input type="range" min="0.5" max="6" step="0.5" data-var="--scan-thickness"></label><input type="number" step="0.5" data-var="--scan-thickness"></div>
    <div class="row"><label>Abstand px <input type="range" min="0" max="12" step="0.5" data-var="--scan-spacing"></label><input type="number" step="0.5" data-var="--scan-spacing"></div>
    <div class="row"><label>Deckkraft 0‚Äì1 <input type="range" min="0" max="1" step="0.01" data-var="--scan-opacity"></label><input type="number" step="0.01" data-var="--scan-opacity"></div>
    <div class="row"><label>Hellfarbe <input type="color" data-var="--scan-bright"></label><input type="text" data-var="--scan-bright"></div>
    <div class="row"><label>Dunkelfarbe <input type="color" data-var="--scan-dark"></label><input type="text" data-var="--scan-dark"></div>
    <div class="row"><label>Blend-Mode <input type="text" placeholder="overlay, soft-light..." data-var="--scan-blend"></label><div></div></div>
  </div>

  <!-- Buttons steuerbar -->
  <div class="grp"><strong>Buttons</strong>
    <div class="row"><label>Sound X px <input type="range" min="0" max="640" step="1" data-var="--sound-x"></label><input type="number" step="1" data-var="--sound-x"></div>
    <div class="row"><label>Sound Y px <input type="range" min="0" max="640" step="1" data-var="--sound-y"></label><input type="number" step="1" data-var="--sound-y"></div>
    <div class="row"><label>Sound Scale √ó <input type="range" min="0.5" max="2" step="0.01" data-var="--sound-scale"></label><input type="number" step="0.01" data-var="--sound-scale"></div>

    <div class="row"><label>Exit X px <input type="range" min="0" max="640" step="1" data-var="--exit-x"></label><input type="number" step="1" data-var="--exit-x"></div>
    <div class="row"><label>Exit Y px <input type="range" min="0" max="640" step="1" data-var="--exit-y"></label><input type="number" step="1" data-var="--exit-y"></div>
    <div class="row"><label>Exit Scale √ó <input type="range" min="0.5" max="2" step="0.01" data-var="--exit-scale"></label><input type="number" step="0.01" data-var="--exit-scale"></div>
  </div>

  <div class="grp"><strong>Reels global</strong>
    <div class="row"><label>Scale √ó       <input type="range" min="0.5" max="2" step="0.01" data-var="--reel-scale"></label><input type="number" step="0.01" data-var="--reel-scale"></div>
    <div class="row"><label>Shine Kern    <input type="range" min="0"   max="0.6" step="0.01" data-var="--shine-core"></label><input type="number" step="0.01" data-var="--shine-core"></div>
    <div class="row"><label>Shine Winkel¬∞ <input type="range" min="0" max="180" step="1" data-var="--shine-angle"></label><input type="number" step="1" data-var="--shine-angle"></div>
    <div class="row"><label>Shine Speed s <input type="range" min="1" max="20" step="0.1" data-var="--shine-speed"></label><input type="number" step="0.1" data-var="--shine-speed"></div>
  </div>

  <div class="grp"><strong>Beenden-Button</strong>
    <div class="sw"><input type="checkbox" id="dbgExitConfirm"> <label for="dbgExitConfirm">Best√§tigung n√∂tig</label></div>
    <div class="row"><label>Label <input type="text" id="dbgExitLabel"></label><div></div></div>
    <div class="row"><label>Confirm-Text <input type="text" id="dbgExitText"></label><div></div></div>
  </div>

</div>

<script>
(function(){
  const $  = s => document.querySelector(s);
  const $$ = s => [...document.querySelectorAll(s)];

  /* Orientierung & Outlines */
  function checkOrientation(){ $('#rotateOverlay').style.display = (innerHeight>innerWidth)?'flex':'none'; }
  addEventListener('resize',checkOrientation);
  addEventListener('orientationchange',checkOrientation);
  document.addEventListener('DOMContentLoaded',checkOrientation);
  addEventListener('keydown', (e)=>{ if(e.key.toLowerCase()==='d'){ document.body.classList.toggle('debug'); const cb=$('#dbgOn'); if(cb) cb.checked=document.body.classList.contains('debug'); } });

  /* Assets */
  const IMG = {
    rot:'assets/img/rot.png',
    blau:'assets/img/blau.png',
    gruen:'assets/img/gruen.png',
    gelb:'assets/img/gelb.png',
    stoer:'assets/img/stoer.png'
  };
  const COLORS_ALL = Object.keys(IMG);              // inkl. stoer (f√ºr Spin)
  const COLORS_NO_STOER = COLORS_ALL.filter(c=>c!=='stoer'); // ohne stoer (f√ºr Ergebnis)

  /* Sounds */
  const audio = {
    lever:   new Audio('assets/snd/lever.mp3'),
    dreh:    new Audio('assets/snd/dreh.mp3'),        // Loop
    anhalten:new Audio('assets/snd/anhalten.mp3'),
    ergebnis:new Audio('assets/snd/ergebnis.mp3'),
    fanfare: new Audio('assets/snd/fanfare.mp3'),
    stoer:   new Audio('assets/snd/stoer.mp3'),
    get enabled(){ return getVar('--sound-enabled')==='1'; }
  };
  audio.dreh.loop = true;
  function safePlay(a){ if(!audio.enabled) return; try{ a.currentTime=0; a.play(); }catch{} }
  function safeStop(a){ try{ a.pause(); a.currentTime=0; }catch{} }

  const soundBtn = $('#soundToggle');
  function syncSoundBtn(){
    const on = getVar('--sound-enabled')==='1';
    soundBtn.textContent = on ? 'üîä Sound: AN' : 'üîá Sound: AUS';
  }
  soundBtn.addEventListener('click', ()=>{
    const on = getVar('--sound-enabled')==='1';
    setVar('--sound-enabled', on?'0':'1');
    if(on) safeStop(audio.dreh);
    syncSoundBtn();
    const cb=$('#dbgSoundOn'); if(cb) cb.checked = !on;
  });

  /* Exit Button */
  const exitBtn = $('#exitBtn');
  function applyExitBtnFromVars(){
    exitBtn.textContent = getVar('--exit-button-label').replace(/(^"|"$)/g,'') || 'Beenden';
  }
  exitBtn.addEventListener('click', ()=>{
    const need = getVar('--exit-requires-confirm')==='1';
    if(!need){ closeUI(); return; }
    const msg = getVar('--exit-confirm-text').replace(/(^"|"$)/g,'') || 'Wirklich beenden?';
    if(confirm(msg)) closeUI();
  });
  function closeUI(){ location.reload(); }

  /* Reels & Lamps */
  const reelsWrap = $('#reels');
  const reels = $$('#reels .reel');
  const nameEl = $('#resName'), descEl = $('#resDesc'), ptsEl = $('#resPts');

  function setSymbol(reelEl, color){
    const imgEl = reelEl.querySelector('img');
    if(imgEl){ imgEl.src = IMG[color]; imgEl.alt = color; }
  }
  const rndFrom = arr => arr[(Math.random()*arr.length)|0];
  const rndAll = () => rndFrom(COLORS_ALL);
  const rndNoStoer = () => rndFrom(COLORS_NO_STOER);

  // init Symbole
  reels.forEach(r=> setSymbol(r, rndNoStoer()));

  const lamps = { gold:$('#lampGold'), blue:$('#lampBlue'), green:$('#lampGreen'), red:$('#lampRed') };

  function getVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
  function setVar(n, v){
    const root=document.documentElement;
    if(n.endsWith('-size') && typeof v==='number') root.style.setProperty(n, v+'rem');
    else if(/--(result-shine-speed|shine-speed|lamp-afterglow)$/.test(n)) root.style.setProperty(n, parseFloat(v)+'s');
    else if(n==='--shine-angle' || n==='--scan-angle') root.style.setProperty(n, parseFloat(v)+'deg');
    else root.style.setProperty(n, v);
  }

  /* Lampen: Pulse + Afterglow */
  const lampTimers = new WeakMap();
  function clearLampTimers(){
    Object.values(lamps).forEach(n=>{
      const t = lampTimers.get(n);
      if(t){ clearTimeout(t); lampTimers.delete(n); }
      n.classList.remove('active','glow');
    });
  }
  function flashLamp(el){
    clearLampTimers();
    el.classList.add('active','glow');
    const sec = parseFloat(getVar('--lamp-afterglow')) || 4.2;
    const t = setTimeout(()=>{ el.classList.remove('active','glow'); lampTimers.delete(el); }, sec*1000);
    lampTimers.set(el, t);
  }
  function setLampsByScore(score){
    if(score >= 13)      flashLamp(lamps.gold);
    else if(score >= 10) flashLamp(lamps.blue);   // Mittel (10‚Äì12)
    else if(score >= 6)  flashLamp(lamps.green);  // Normal (6‚Äì9)
    else                 flashLamp(lamps.red);    // Einfach (2‚Äì5)
  }
  function allLampsOff(){ Object.values(lamps).forEach(l=> l.classList.remove('active','glow')); }

  /* Chaos-Blinken bei St√∂rung */
  function chaosLamps(ms=1200){
    const els = Object.values(lamps);
    let t=0;
    const int = setInterval(()=>{
      els.forEach(l=> l.classList.remove('active','glow'));
      const count = 1 + (Math.random()*3|0);
      for(let i=0;i<count;i++){
        const el = els[Math.random()*els.length|0];
        el.classList.add('active');
      }
      t+=120;
      if(t>=ms){ clearInterval(int); allLampsOff(); }
    }, 120);
  }

// 1) Deine Liste (jetzt komplett mit 35 Eintr√§gen)
const RECIPES = {
  'rot,rot,rot,rot':   {name:'D√∂sselheimer G√ºllebier', pts:15, desc:'Die braune Seele Saxoniens.'},
  'blau,blau,blau,blau': {name:'Leberknebel - Export', pts:15, desc:'Seitenstechen auch ohne Meuchelm√∂rder.'},
  'gruen,gruen,gruen,gruen': {name:'Braune So√üe', pts:14, desc:'Z√§hfl√ºssig, herzhaft, l√∂st Sorgen und Rost.'},
  'gelb,gelb,gelb,gelb': {name:'Flotter Otto - Extra Hell', pts:14, desc:'Flie√üt es erst heraus, bleibst du lieber gleich zuhaus!'},
  'rot,rot,rot,blau':  {name:'Klemritzer Nierenquetscher', pts:13, desc:'Massiert die Organe von innen nach au√üen.'},
  'rot,rot,rot,gruen': {name:'R√ºlpsheimer Starkbier', pts:13, desc:'Schenkt Bass im Bauch.'},
  'rot,rot,rot,gelb':  {name:'Lord Villains Glanzparade', pts:13, desc:'Edel und unbestechlich herb.'},
  'blau,blau,blau,rot':  {name:'Donnerburger Stei√ütritt', pts:13, desc:'Treffsicherer Geschmack.'},
  'blau,blau,blau,gruen':{name:'Hassnitzer Kellerbr√§u', pts:13, desc:'Aus dem ganz dunklen Fass.'},
  'blau,blau,blau,gelb': {name:'Stinkhornsuppe - Spezial', pts:13, desc:'Duftet nach Abenteuer, Freiheit und alten Socken.'},
  'gruen,gruen,gruen,rot': {name:'Pl√§rrener Humpentrunk', pts:13, desc:'Gro√ü im Glas, laut im Kopf.'},
  'gruen,gruen,gruen,blau':{name:'Hassburger Urstoff Br√ºhe', pts:13, desc:'So bek√∂mmlich wie eine kleine Pilzvergiftung.'},
  'gruen,gruen,gruen,gelb':{name:'Dreschmarer Magenhieb', pts:12, desc:'Direkt, ehrlich, unvergesslich.'},
  'gelb,gelb,gelb,rot':  {name:'Knurrwitzer Abtritt', pts:12, desc:'So m√§nnlich wie konservative Ein-Artikler.'},
  'gelb,gelb,gelb,blau': {name:'Ynnors Schnarchtrunk', pts:12, desc:'Wirkt sofort.'},
  'gelb,gelb,gelb,gruen':{name:'Schwitzwasser Abblende', pts:12, desc:'Leicht bek√∂mmliches D√ºnnbier.'},
  'rot,rot,blau,blau':   {name:'Bei√üburger R√ºbenhamsterwurf', pts:11, desc:'Zwei Paare, ein Ziel.'},
  'rot,rot,gruen,gruen': {name:'Ningelner Nostalgiker - Urtyp', pts:11, desc:'Schmeckt so gut wie fr√ºher, nur besser.'},
  'rot,rot,gelb,gelb':   {name:'Stockheimer Knollentrunk', pts:10, desc:'Dick im Glas, jetzt mit noch mehr Fruchtfleisch.'},
  'blau,blau,gruen,gruen':{name:'Pl√§rrener Feldschorle - Spezial', pts:10, desc:'Damit sie auch morgen noch lauthals schreien k√∂nnen.'},
  'blau,blau,gelb,gelb': {name:'Grollst√§dter R√ºbensprudel - Deluxe', pts:9, desc:'Gebraut mit Liebe.'},
  'gruen,gruen,gelb,gelb':{name:'Grimmiger Krauttrunk - Extra Herb', pts:9, desc:'Kratzig im Abgang.'},
  'rot,rot,blau,gruen': {name:'Kellerleichen - Party - Mix', pts:8, desc:'F√ºr N√§chte an die man sich lieber nicht erinnert.'},
  'rot,rot,blau,gelb':  {name:'Broilinger Doppelacker Sud', pts:7, desc:'Das beste aus zwei Welten.'},
  'rot,rot,gruen,gelb': {name:'Feierabend Erntetrunk', pts:7, desc:'Erfrischend wie eine 16 Stundenschicht bei Schnell & Billig.'},
  'blau,blau,rot,gruen': {name:'Zwicker Feldweg - Kn√∂chelknacks', pts:6, desc:'Holprig und bitter.'},
  'blau,blau,rot,gelb':  {name:'Ackerbowle', pts:6, desc:'Erdig-Herb'},
  'blau,blau,gruen,gelb':{name:'Lumpa Umpas goldene Brause - Edel', pts:6, desc:'Kurz aber kr√§ftig.'},
  'gruen,gruen,rot,blau': {name:'Freudloser Hopfenr√ºbling - Hell', pts:5, desc:'Der Spa√ü aus dem Glas.'},
  'gruen,gruen,rot,gelb': {name:'Ackerschorle - Export', pts:5, desc:'Das Erfrischungsgetr√§nk f√ºr jede Arbeit.'},
  'gruen,gruen,blau,gelb':{name:'Winkelst√§dter G√§rtnerpils', pts:5, desc:'Gereift im Biercubus.'},
  'gelb,gelb,rot,blau':  {name:'L√§sterhainer Jodelsprudel', pts:4, desc:'Nach zwei Schlucken singst du.'},
  'gelb,gelb,rot,gruen': {name:'Donnerburger R√ºbensch√§del - Spezial', pts:4, desc:'Gebraut mit Blitz und Donner.'},
  'gelb,gelb,blau,gruen':{name:'Karnickelfangschlag', pts:4, desc:'Erst pelzig auf der Zunge, dann schnell im Abgang.'},
  'rot,blau,gruen,gelb': {name:'Querbeet - Klassik', pts:2, desc:'Von allem ein bisschen.'}
};

// 2) Normalisierungs-Index (Reihenfolge egal)
const keyOf = arr => arr.slice().sort().join(',');
const RECIPES_INDEX = {};
Object.keys(RECIPES).forEach(k => {
  RECIPES_INDEX[keyOf(k.split(','))] = RECIPES[k];
});

// 3) Rezept lookup immer √ºber sortierten Schl√ºssel
function getRecipeFromColors(colorsArr){
  return RECIPES_INDEX[keyOf(colorsArr)];
}


  function setResult(name='', desc='', pts=''){
    nameEl.textContent = name;
    descEl.textContent = desc;
    ptsEl.textContent  = pts;
  }

  /* Hebel */
  const lever = $('#lever');
  const knob  = lever.querySelector('.lever__knob');
  const ring  = lever.querySelector('.lever__ring');
  let dragging=false, startY=0, startVal=0, maxY=200;

  function measure(){ const rect = lever.getBoundingClientRect(); maxY = Math.max(120, rect.height-64); }
  measure(); addEventListener('resize',measure);

  function setKnob(y, withTransition){
    const clamped = Math.max(0, Math.min(maxY, y));
    if(!withTransition){ knob.style.transition='none'; ring.style.transition='none'; }
    knob.style.setProperty('--y', clamped+'px');
    ring.style.transform = `translate(-50%, ${clamped+52}px)`;
    if(!withTransition){ void knob.offsetHeight; knob.style.transition=''; ring.style.transition=''; }
    return clamped;
  }
  function onDown(e){
    dragging=true;
    startY=('touches' in e ? e.touches[0].clientY : e.clientY);
    const cur=parseFloat(getComputedStyle(knob).getPropertyValue('--y'))||0;
    startVal=cur; setKnob(cur,false);
    safePlay(audio.lever);
    e.preventDefault();
  }
  function onMove(e){
    if(!dragging) return;
    const y=('touches' in e ? e.touches[0].clientY : e.clientY);
    const dy=y-startY; setKnob(startVal+dy,false);
    e.preventDefault();
  }
  function onUp(){
    if(!dragging) return; dragging=false;
    const cur=parseFloat(getComputedStyle(knob).getPropertyValue('--y'))||0;
    const ratio=cur/(maxY||1);
    setKnob(0,true);
    if(ratio>=0.8) spin();
  }
  lever.addEventListener('mousedown',onDown); addEventListener('mousemove',onMove); addEventListener('mouseup',onUp);
  lever.addEventListener('touchstart',onDown,{passive:false}); addEventListener('touchmove',onMove,{passive:false}); addEventListener('touchend',onUp);
  lever.addEventListener('keydown',e=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); setKnob(maxY,true); setTimeout(()=>{ setKnob(0,true); spin(); },180); } });

  /* Spin-Logik */
  let spinning=false; let timers=[]; let intervals=[];
  function clearTimers(){ intervals.forEach(i=>clearInterval(i)); intervals=[]; timers.forEach(t=>clearTimeout(t)); timers=[]; }

  function spin(){
    if(spinning) return; spinning=true;
    setResult('‚Ä¶suche Rezept‚Ä¶','',''); // w√§hrend des Spins
    reelsWrap.classList.add('spinning');
    safePlay(audio.dreh);

    // St√∂rungschance (z. B. 1/40) ‚Äì wenn true, werden ALLE 4 auf 'stoer' gesetzt.
    const STOER_CHANCE = 40;
    const willForceStoerStop = ((Math.random()*STOER_CHANCE)|0)===0;

    reels.forEach((r,i)=>{
      r.classList.add('spinning');
      r.querySelector('.streak').hidden=false;
      const intId = setInterval(()=> setSymbol(r, rndAll()), 92); // alle inkl. stoer im Spin
      intervals.push(intId);
    });

    const stopBase=[1100,1750,2400,3050];
    let finalColors = [];

    reels.forEach((r,i)=>{
      const to=setTimeout(()=>{
        clearInterval(intervals[i]);

        let finalColor = willForceStoerStop ? 'stoer' : rndNoStoer();
        setSymbol(r, finalColor);
        finalColors[i]=finalColor;

        r.classList.remove('spinning'); r.classList.add('stop-bounce');
        r.querySelector('.streak').hidden=true;
        safePlay(audio.anhalten);
        r.addEventListener('animationend',()=> r.classList.remove('stop-bounce'),{once:true});

        if(i===reels.length-1){
          reelsWrap.classList.remove('spinning');
          safeStop(audio.dreh);

          // St√∂rungsfall: alle 4 == 'stoer'
          if(finalColors.every(c=>c==='stoer')){
            chaosLamps(1400);
            setResult('‚ùå Maschine hat eine St√∂rung!','Ziehe Hebel zum Neustart.','');
            safePlay(audio.stoer);
            spinning=false; clearTimers();
            return;
          }

          // Reihenfolge-agnostisches Rezept ermitteln
          const recipe = getRecipeFromColors(finalColors);
          if(!recipe){
            setResult('Unbekanntes Rezept','(Kombination nicht definiert)','');
            spinning=false; clearTimers();
            return;
          }

          // Lampen & Anzeige nach Rezept-Punkten
          setLampsByScore(recipe.pts);
          setResult(recipe.name, recipe.desc, `+${recipe.pts} Thaler`);


          safePlay(audio.ergebnis);
          if(recipe.pts>=13) safePlay(audio.fanfare);

          spinning=false; clearTimers();
        }
      }, stopBase[i]+Math.floor(Math.random()*260));
      timers.push(to);
    });
  }

  /* ===== Debug-Panel ===== */
  (function(){
    const root = document.documentElement;
    const panel  = $('#dbgPanel');
    const dbgOn  = $('#dbgOn');
    const dbgSoundOn = $('#dbgSoundOn');

    // Exit controls
    const dbgExitConfirm = $('#dbgExitConfirm');
    const dbgExitLabel   = $('#dbgExitLabel');
    const dbgExitText    = $('#dbgExitText');

    const VARS_PERCENT = ['--r-top','--r-w','--r-h','--r0-left','--r1-left','--r2-left','--r3-left','--res-left','--res-top','--res-w','--res-h','--lever-x','--lever-y','--lamps-x','--lamps-y'];
    const VARS_SCALE   = ['--reel-scale','--lever-scale','--lamps-scale','--sound-scale','--exit-scale'];
    const VARS_PX      = ['--lamps-gap','--sound-x','--sound-y','--exit-x','--exit-y','--scan-thickness','--scan-spacing'];
    const VARS_DEG     = ['--shine-angle','--scan-angle'];
    const VARS_SEC     = ['--shine-speed','--lamp-afterglow','--result-shine-speed'];
    const VARS_COLOR   = ['--result-name-color','--result-desc-color','--result-points-color','--outline-reel','--outline-result','--lamp-red-color','--lamp-green-color','--lamp-blue-color','--lamp-gold-color','--scan-bright','--scan-dark'];
    const VARS_REM     = ['--result-name-size','--result-desc-size','--result-points-size'];
    const VARS_MISC    = ['--sound-enabled','--exit-requires-confirm','--exit-button-label','--exit-confirm-text','--shine-core','--scan-opacity','--scan-blend'];

    const VARS = [...VARS_PERCENT, ...VARS_SCALE, ...VARS_PX, ...VARS_DEG, ...VARS_SEC, ...VARS_COLOR, ...VARS_REM, ...VARS_MISC];

    const STORAGE_KEY = 'rezep_debug_vars_v10';
    const POS_KEY     = 'rezep_debug_panel_pos_v1';
    const posStore = sessionStorage;  // <‚Äî nur innerhalb der Tab-Session
    const DBG_KEY     = 'rezep_debug_flag_v1';
    const defaults = {};

    const getVarLocal = n => getComputedStyle(root).getPropertyValue(n).trim();
    function setVarAuto(n, raw){
      if (VARS_PERCENT.includes(n)) root.style.setProperty(n, parseFloat(raw) + '%');
      else if (VARS_PX.includes(n))  root.style.setProperty(n, parseFloat(raw) + 'px');
      else if (VARS_DEG.includes(n)) root.style.setProperty(n, parseFloat(raw) + 'deg');
      else if (VARS_SEC.includes(n)) root.style.setProperty(n, parseFloat(raw) + 's');
      else if (VARS_REM.includes(n)) root.style.setProperty(n, parseFloat(raw) + 'rem');
      else                           root.style.setProperty(n, raw);
    }

    function loadDefaults(){ VARS.forEach(n=> defaults[n] = getVarLocal(n)); }
    function apply(values){ Object.entries(values).forEach(([k,v])=>{ if(!VARS.includes(k)||v==null) return; setVarAuto(k, v); }); syncInputs(); }
    function save(){
      const out={}; VARS.forEach(n=> out[n]=getVarLocal(n));
      localStorage.setItem(STORAGE_KEY, JSON.stringify(out));
      localStorage.setItem(DBG_KEY, document.body.classList.contains('debug')?'1':'0');
    }
    function load(){
      const raw=localStorage.getItem(STORAGE_KEY); if(raw){ try{ apply(JSON.parse(raw)); }catch{} }
      const df=localStorage.getItem(DBG_KEY); document.body.classList.toggle('debug', df==='1'); if(dbgOn) dbgOn.checked=document.body.classList.contains('debug');

      // set checkboxes/fields from vars
      dbgSoundOn.checked = getVarLocal('--sound-enabled')==='1';
      $('#dbgExitConfirm').checked = getVarLocal('--exit-requires-confirm')==='1';
      $('#dbgExitLabel').value = getVarLocal('--exit-button-label').replace(/(^"|"$)/g,'');
      $('#dbgExitText').value  = getVarLocal('--exit-confirm-text').replace(/(^"|"$)/g,'');
      applyExitBtnFromVars();
      syncSoundBtn();
    }
    function reset(){ apply(defaults); localStorage.removeItem(STORAGE_KEY); localStorage.removeItem(DBG_KEY); document.body.classList.remove('debug'); if(dbgOn) dbgOn.checked=false; syncSoundBtn(); applyExitBtnFromVars(); }

    function stripUnit(name, val){
      if (VARS_PERCENT.includes(name)) return parseFloat(val)||0;
      if (VARS_PX.includes(name))      return parseFloat(val)||0;
      if (VARS_DEG.includes(name))     return parseFloat(val)||0;
      if (VARS_SEC.includes(name))     return parseFloat(val)||0;
      if (VARS_REM.includes(name))     return parseFloat(val)||0;
      return val.replace(/(^"|"$)/g,'');
    }
    function syncInputs(){
      panel.querySelectorAll('[data-var]').forEach(inp=>{
        const name = inp.getAttribute('data-var');
        let v = getVarLocal(name);
        inp.value = stripUnit(name, v);
      });
    }
    function onInput(e){
      const el=e.target; if(!el.matches('[data-var]')) return;
      const name=el.getAttribute('data-var'); const raw=el.value;
      setVarAuto(name, raw);
      panel.querySelectorAll(`[data-var="${name}"]`).forEach(x=>{ if(x!==el) x.value=raw; });
    }
    function toCssSnippet(){ return `:root{\n`+VARS.map(n=>`  ${n}: ${getVarLocal(n)};`).join('\n')+`\n}`; }

    // Panel √∂ffnen/schlie√üen
    $('#dbgToggle').addEventListener('click', ()=> panel.style.display = (panel.style.display==='block'?'none':'block') );
    panel.addEventListener('input', onInput);
    $('#dbgSave').addEventListener('click', ()=>{ save(); const t=$('#dbgToggle'); t.textContent='‚úÖ Gespeichert'; setTimeout(()=> t.textContent='üõ†Ô∏è Debug', 900); });
    $('#dbgReset').addEventListener('click', reset);
    $('#dbgCopyCss').addEventListener('click', ()=>{ const css=toCssSnippet(); if(navigator.clipboard){ navigator.clipboard.writeText(css); } else { const ta=document.createElement('textarea'); ta.value=css; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); } });

    if(dbgOn) dbgOn.addEventListener('change', ()=>{ document.body.classList.toggle('debug', dbgOn.checked); });

    // Sound toggle im Panel
    dbgSoundOn.addEventListener('change', ()=>{
      setVar('--sound-enabled', dbgSoundOn.checked?'1':'0');
      if(!dbgSoundOn.checked) safeStop(audio.dreh);
      syncSoundBtn();
    });

    // Exit controls
    $('#dbgExitConfirm').addEventListener('change', ()=> setVar('--exit-requires-confirm', $('#dbgExitConfirm').checked?'1':'0'));
    $('#dbgExitLabel').addEventListener('input', ()=>{ setVar('--exit-button-label', `"${$('#dbgExitLabel').value}"`); applyExitBtnFromVars(); });
    $('#dbgExitText').addEventListener('input',  ()=> setVar('--exit-confirm-text', `"${$('#dbgExitText').value}"`));

    // Panel drag
    (function(){
      const header = panel.querySelector('header');
      let drag=false, offX=0, offY=0;
      const place=(x,y)=>{ panel.style.left=x+'px'; panel.style.top=y+'px'; panel.style.right='auto'; panel.style.bottom='auto'; }
      const savePos = ()=>{
  const r = panel.getBoundingClientRect();
  posStore.setItem(POS_KEY, JSON.stringify({x:r.left, y:r.top}));
};
const loadPos = ()=>{
  const raw = posStore.getItem(POS_KEY);
  if(!raw) return;
  try{
    const {x,y} = JSON.parse(raw);
    if(Number.isFinite(x) && Number.isFinite(y)) place(x,y);
  }catch{}
};
// irgendwo NACH dem panel/drag-Setup:
const resetPanelPosToDefault = ()=>{
  posStore.removeItem(POS_KEY);
  panel.style.left = '';
  panel.style.top = '';
  panel.style.right = '12px';
  panel.style.bottom = '64px';
};

// Doppelklick auf das Schraubenschl√ºssel/Devtool-Icon:
document.getElementById('dbgToggle')?.addEventListener('dblclick', resetPanelPosToDefault);


      header.addEventListener('mousedown', e=>{ drag=true; const r=panel.getBoundingClientRect(); offX=e.clientX-r.left; offY=e.clientY-r.top; e.preventDefault(); });
      addEventListener('mousemove', e=>{ if(!drag) return; place(e.clientX-offX, e.clientY-offY); });
      addEventListener('mouseup', ()=>{ if(drag){ drag=false; savePos(); } });

      header.addEventListener('touchstart', e=>{ drag=true; const t=e.touches[0]; const r=panel.getBoundingClientRect(); offX=t.clientX-r.left; offY=t.clientY-r.top; }, {passive:true});
      addEventListener('touchmove', e=>{ if(!drag) return; const t=e.touches[0]; place(t.clientX-offX, t.clientY-offY); }, {passive:true});
      addEventListener('touchend', ()=>{ if(drag){ drag=false; savePos(); } });

      loadPos();
    })();

    // Init
    (function init(){ loadDefaults(); load(); syncInputs(); })();
  })();

  // initial state
  applyExitBtnFromVars();
  syncSoundBtn();
})();
</script>
</body>
</html>
