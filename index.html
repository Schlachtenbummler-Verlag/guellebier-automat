<!doctype html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Saxonischer Güllebier-Rezepte-Automatron</title>
<style>
  :root{ --reel: clamp(72px, 20vw, 150px); }

  html{ scrollbar-gutter: stable both-edges; }
  body{ background:#000; margin:0; padding:0; font-family:sans-serif; color:#fff; text-align:center; }

  /* === Auto-Fit Wrapper (NEU) === */
  .fitbox{
    position: relative;
    width: 100%;
    height: auto;           /* wird per JS passend reserviert */
    display: inline-block;  /* bleibt zentriert (Body hat text-align:center) */
  }
  .fitbox > *{
    transform-origin: top center;
    will-change: transform;
  }

  /* Holzrahmen */
  .frame-wood{
    --frame: clamp(16px, 3.2vw, 44px);
    display:inline-block; margin:24px auto; padding:var(--frame);
    border:var(--frame) solid transparent;
    border-image-source:url('assets/img/wood.svg');
    border-image-slice:140; border-image-width:var(--frame); border-image-repeat:round;
    border-radius:16px; box-shadow:0 12px 30px rgba(0,0,0,.35);
    position:relative; max-width:98vw;
  }
  .frame-wood::before{
    content:""; position:absolute; inset:calc(var(--frame) - 1px);
    border-radius:12px; box-shadow: inset 0 6px 14px rgba(0,0,0,.35), inset 0 -4px 8px rgba(0,0,0,.25);
    pointer-events:none;
  }

  /* Automat-Box */
  .gba{ color:#fff; background:#222; padding:18px; border-radius:12px; width:min(860px,96vw); box-sizing:border-box; margin:0 auto; }

  /* Header mittig zur rechten Spalte (Kol.2) */
  .gba__header{
    display:grid; grid-template-columns:96px 1fr; column-gap:14px;
    margin-bottom:6px;
  }
  .gba__header > *{ grid-column:2; text-align:center; }

  /* 2-spaltig: links Hebel, rechts Reels/Lampen/Ergebnis */
  .gba__machine{
    display:grid; grid-template-columns:96px 1fr; gap:14px; align-items:center;
    margin:12px 0; min-height:min(360px, 70vh); perspective:1000px;
  }

  /* --------- HEBEL --------- */
  .gba__lever-wrap{ height:100%; display:flex; align-items:center; justify-content:center; }
  .lever{
    width:72px; height:300px; position:relative; user-select:none; touch-action:none; cursor:grab;
    filter: drop-shadow(0 6px 14px rgba(0,0,0,.35));
  }
  .lever.locked{ cursor:not-allowed; filter: grayscale(.35) opacity(.9); }
  .lever__back{
    position:absolute; inset:0; border-radius:10px;
    background:linear-gradient(180deg,#1a1a1a,#0f0f0f);
    box-shadow: inset 0 6px 10px rgba(0,0,0,.6), inset 0 -6px 10px rgba(0,0,0,.4);
  }
  .lever__slot{
    position:absolute; left:50%; top:14px; bottom:14px; width:12px; transform:translateX(-50%);
    background:#080808; border-radius:8px; box-shadow: inset 0 0 10px rgba(0,0,0,.9);
  }
  .lever__arm{
    position:absolute; left:50%; top:22px; width:6px; bottom:22px; transform:translateX(-50%);
    background:linear-gradient(180deg,#555,#2a2a2a); border-radius:3px; box-shadow: inset 0 0 4px rgba(0,0,0,.6);
  }
  .lever__knob{
    --y: 0px;
    position:absolute; left:50%; top:0; width:56px; height:56px; transform: translate(-50%, var(--y));
    border-radius:50%;
    background: radial-gradient(circle at 30% 30%, #fff6b8, #f8d24a 45%, #d3a83c 75%, #8a6b1d 100%);
    box-shadow: 0 10px 18px rgba(0,0,0,.45), inset 0 2px 0 rgba(255,255,255,.35);
    transition: transform .28s cubic-bezier(.2,.8,.2,1);
    z-index:2;
  }
  .lever.pulling .lever__knob{ box-shadow: 0 12px 22px rgba(0,0,0,.5), inset 0 2px 0 rgba(255,255,255,.35); }
  .lever__knob::after{
    content:""; position:absolute; inset:0; border-radius:50%;
    background:linear-gradient(120deg, rgba(255,255,255,.65) 0%, rgba(255,255,255,0) 40%);
    mix-blend-mode:screen; opacity:.35; pointer-events:none;
  }
  .lever__ring{
    position:absolute; left:50%; width:32px; height:8px; transform:translate(-50%, calc(var(--y) + 52px));
    background:linear-gradient(180deg,#777,#333); border-radius:8px; filter:blur(.2px);
    transition: transform .28s cubic-bezier(.2,.8,.2,1); z-index:1;
  }

  /* --------- RECHTE SPALTE --------- */
  .gba__right{ display:flex; flex-direction:column; gap:10px; }

  /* Reels + synchroner Shine */
  .gba__reels{
    display:grid; grid-template-columns:repeat(4, 1fr);
    gap:10px; margin-bottom:0; width:100%; box-sizing:border-box;
    transform: translateZ(0); will-change: transform; position:relative; overflow:hidden;
  }
  .gba__reels::before{
    content:""; position:absolute; top:0; left:-150%; bottom:0; width:150%;
    background: linear-gradient(120deg, rgba(255,255,255,0) 30%, rgba(255,255,255,.25) 50%, rgba(255,255,255,0) 70%);
    transform:skewX(-25deg); animation:shine 12s linear infinite; pointer-events:none; z-index:5;
  }
  .gba__reels.spinning::before{ display:none; }
  @keyframes shine{ from{ left:-150%; } to{ left:150%; } }

  .reel{
    background:#111; padding:10px; border-radius:8px; display:flex; align-items:center; justify-content:center;
    position:relative; overflow:hidden; box-shadow: inset 0 2px 10px rgba(0,0,0,.6), 0 8px 18px rgba(0,0,0,.25);
  }
  .reel::before, .reel::after{ content:""; position:absolute; left:0; right:0; height:22%; pointer-events:none; z-index:2; }
  .reel::before{ top:0; background:linear-gradient(to bottom, rgba(0,0,0,.6), rgba(0,0,0,0)); }
  .reel::after{ bottom:0; background:linear-gradient(to top, rgba(0,0,0,.6), rgba(0,0,0,0)); }

  .symbol{
    position:relative; width:100%; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center;
    overflow:hidden; will-change: transform, filter; transition: filter .2s ease;
  }
  .symbol::after{
    content:""; position:absolute; inset:-10% -40% auto -40%; height:60%;
    background:linear-gradient(to bottom, rgba(255,255,255,.18), rgba(255,255,255,0) 70%);
    transform: rotate(-12deg); pointer-events:none; z-index:1;
  }
  .symbol img, .symbol svg{ width:100%; height:100%; object-fit:contain; display:block; }

  /* Effekte während des Spins */
  .gba.shake{ animation: shake .35s ease-in-out both; }
  @keyframes shake{ 0%,100%{transform:translateX(0)} 20%{transform:translateX(-2px)} 40%{transform:translateX(2px)} 60%{transform:translateX(-1px)} 80%{transform:translateX(1px)} }
  .reel.spinning .symbol{ filter: blur(3px) saturate(1.1); animation: spin-jitter .12s linear infinite; }
  @keyframes spin-jitter{ 0%{transform:translateY(-3%)} 50%{transform:translateY(3%)} 100%{transform:translateY(-3%)} }
  .reel.spinning::after{
    content:""; position:absolute; inset:-30% -10%;
    background:linear-gradient(90deg, rgba(255,255,255,0) 30%, rgba(255,255,255,.25) 50%, rgba(255,255,255,0) 70%);
    filter: blur(6px); opacity:.18; transform: rotate(12deg); animation: streak .5s linear infinite; pointer-events:none;
  }
  @keyframes streak{ from{transform:rotate(12deg) translateX(-8%)} to{transform:rotate(12deg) translateX(8%)} }
  .reel.stop-bounce .symbol{ animation: stop-bounce .32s cubic-bezier(.2,.8,.2,1) 1; filter:none; }
  @keyframes stop-bounce{ 0%{transform:translateY(10%)} 60%{transform:translateY(-4%)} 100%{transform:translateY(0)} }

  /* --------- LAMPEN --------- */
  .gba__action{ display:flex; justify-content:center; margin:8px 0; width:100%; }
  .lamps{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; width:100%; }

  .lamp{
    pointer-events:none; user-select:none;
    display:inline-flex; align-items:center; justify-content:center;
    min-width:160px; height:56px; padding:0 16px; border-radius:32px;
    background:linear-gradient(180deg,#2f2f2f,#161616);
    box-shadow: inset 0 4px 10px rgba(0,0,0,.7), inset 0 -4px 8px rgba(0,0,0,.5);
    position:relative; overflow:hidden;
  }
  .lamp__label{
    font-weight:900; letter-spacing:.08em; text-transform:uppercase;
    color:#8a8a8a;
    text-shadow: 0 1px 0 rgba(0,0,0,.6);
  }
  .lamp__shine{
    content:""; position:absolute; inset:0;
    background: radial-gradient(ellipse at 50% -30%, rgba(255,255,255,.25), rgba(255,255,255,0) 45%);
    opacity:.35; mix-blend-mode:screen; pointer-events:none;
  }

  /* Aktiv-Zustände + Nachglühen */
  .lamp--red.active{
    background: radial-gradient(circle at 50% 20%, #ffd6d6 0%, #ff4d4d 40%, #b11717 70%, #4a0a0a 100%);
    box-shadow: 0 0 18px 6px rgba(255,80,80,.55), 0 0 36px 16px rgba(255,80,80,.22);
    animation: lampPulse 1.2s ease-out 1;
  }
  .lamp--green.active{
    background: radial-gradient(circle at 50% 20%, #eaffea 0%, #4cd964 40%, #1db954 70%, #0e3f1d 100%);
    box-shadow: 0 0 18px 6px rgba(80,255,120,.55), 0 0 36px 16px rgba(80,255,120,.22);
    animation: lampPulse 1.2s ease-out 1;
  }
  .lamp--legend.active{
    background:#FFD400;
    box-shadow: 0 0 18px 6px rgba(255,212,0,.65), 0 0 36px 16px rgba(255,212,0,.28);
    animation: lampPulse 1.2s ease-out 1;
  }

  /* Nachglühen */
  .lamp::after{
    content:""; position:absolute; inset:-10px; border-radius:inherit;
    opacity:0; filter: blur(10px); pointer-events:none;
  }
  .lamp--legend.glow::after{
    background: radial-gradient(ellipse at 50% 50%, rgba(255,212,0,.90), rgba(255,212,0,.45) 42%, rgba(255,212,0,0) 70%);
    animation: afterglow 3.8s ease-out forwards;
  }
  .lamp--red.glow::after{
    background: radial-gradient(ellipse at 50% 50%, rgba(255,110,110,.85), rgba(255,80,80,.35) 40%, rgba(255,80,80,0) 70%);
    animation: afterglow 3.8s ease-out forwards;
  }
  .lamp--green.glow::after{
    background: radial-gradient(ellipse at 50% 50%, rgba(120,255,160,.85), rgba(80,255,120,.35) 40%, rgba(80,255,120,0) 70%);
    animation: afterglow 5s ease-out forwards;
  }

  @keyframes lampPulse{ 0%{box-shadow:0 0 0 0 rgba(255,255,255,0)} 60%{box-shadow:0 0 28px 12px rgba(255,255,255,.65)} 100%{box-shadow:0 0 18px 6px rgba(255,255,255,.4)} }
  @keyframes afterglow{ 0%{opacity:.6;} 100%{opacity:0;} }

  /* Ausgabecontainer – exakt so breit wie die Walzen-Spalte */
  .gba__result{
    width:100%; box-sizing:border-box;
    display:flex; flex-direction:column; gap:6px; padding:8px;
    background:#111; border-radius:8px; min-height:96px;
    align-items:center; text-align:center;
  }
  .gba__result.loading{ color:#ccc; font-style:italic; }
  .gba__result .name{ font-weight:700; margin:0; }
  .gba__result .desc{ margin:0; color:#ccc; }
  .badge{ display:inline-block; margin-right:6px; padding:2px 6px; border-radius:8px; font-size:.85rem; background:#FFD700; color:#000; font-weight:bold; }

  .back-btn{margin:8px auto;}
  .back-btn button{background:#444; color:#fff; padding:10px 20px; border:none; border-radius:8px; cursor:pointer}
  .back-btn button:hover{background:#666}

  #rotateOverlay{
    position:fixed; inset:0; display:none; z-index:9999;
    background:rgba(0,0,0,.9); color:#FFD700;
    font-size:1.2rem; line-height:1.4; text-align:center;
    align-items:center; justify-content:center; padding:20px; box-sizing:border-box;
  }

  /* Mobile */
  @media (max-width: 560px){
    .gba__header{ grid-template-columns:1fr; }
    .gba__header > *{ grid-column:1; }
    .gba__machine{ grid-template-columns: 1fr; }
    .gba__lever-wrap{ order:-1; }
    .lever{ height:240px; }
    .lamp{ min-width: 140px; }
  }
</style>
</head>
<body>

<!-- Auto-Fit Hülle (NEU) -->
<div id="machineFit" class="fitbox">
  <div class="frame-wood">
    <div id="guellebier-automat" class="gba">
      <div class="gba__header">
        <h2>Saxonischer® Rezepte-Automatron 2000</h2>
        <p class="gba__sub">Welche Rüben müssen für das Güllebier-Rezept geerntet werden?</p>
      </div>

      <div class="gba__machine">
        <!-- HEBEL (Start) -->
        <div class="gba__lever-wrap">
          <div id="lever" class="lever" role="button" aria-label="Hebel ziehen" tabindex="0">
            <div class="lever__back"></div>
            <div class="lever__slot"></div>
            <div class="lever__arm"></div>
            <div class="lever__knob"></div>
            <div class="lever__ring"></div>
          </div>
        </div>

        <!-- RECHTS: Reels + Lampen + Ergebnis -->
        <div class="gba__right">
          <div class="gba__reels" id="reelContainer">
            <div class="reel" data-index="0"><div class="symbol"></div></div>
            <div class="reel" data-index="1"><div class="symbol"></div></div>
            <div class="reel" data-index="2"><div class="symbol"></div></div>
            <div class="reel" data-index="3"><div class="symbol"></div></div>
          </div>

          <!-- Lampen -->
          <div class="gba__action">
            <div class="lamps">
              <div id="lampOrd" class="lamp lamp--red" aria-hidden="true">
                <span class="lamp__label">Ordinär</span>
                <div class="lamp__shine" aria-hidden="true"></div>
              </div>
              <div id="lampAlt" class="lamp lamp--green" aria-hidden="true">
                <span class="lamp__label">Alltäglich</span>
                <div class="lamp__shine" aria-hidden="true"></div>
              </div>
              <div id="lampLeg" class="lamp lamp--legend" aria-hidden="true">
                <span class="lamp__label">Legendär</span>
                <div class="lamp__shine" aria-hidden="true"></div>
              </div>
            </div>
          </div>

          <!-- Ergebnis -->
          <div class="gba__result" id="gbaResult"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="back-btn"><button onclick="handleBack()">Zurück</button></div>
<div id="rotateOverlay">Bitte dreh dein Gerät ins Querformat</div>

<!-- Sounds -->
<audio id="sndLever"   src="assets/snd/lever.mp3" preload="auto" loop></audio>
<audio id="sndRattle"  src="assets/snd/dreh.mp3" loop></audio>
<audio id="sndStop"    src="assets/snd/anhalten.mp3"></audio>
<audio id="sndResult"  src="assets/snd/ergebnis.mp3"></audio>
<audio id="sndFanfare" src="assets/snd/fanfare.mp3"></audio>

<script>
function log(msg){ try{ console.log('[Automat]', msg); }catch(e){} }

function handleBack(){
  try { window.close(); } catch(e) {}
  if (document.visibilityState === 'visible') {
    if (history.length > 1) { history.back(); return; }
    if (document.referrer)  { location.href = document.referrer; return; }
  }
  location.href = 'https://schlachtenbummler-verlag.jimdosite.com/neu/';
}

function checkOrientation(){
  const ov = document.getElementById('rotateOverlay');
  if (!ov) return;
  ov.style.display = (window.innerHeight > window.innerWidth) ? 'flex' : 'none';
}

/* === Auto-Fit (NEU) === */
function fitMachineToViewport(){
  const wrap = document.getElementById('machineFit');
  if(!wrap) return;
  const inner = wrap.firstElementChild; // frame-wood
  if(!inner) return;

  // reset alte Skalierung, dann neu messen
  inner.style.transform = '';
  wrap.style.height = '';

  const vw = document.documentElement.clientWidth;
  const vh = (window.visualViewport && window.visualViewport.height) || window.innerHeight;

  const padX = 12, padY = 12;
  const maxW = vw - padX*2;
  const maxH = vh - padY*2;

  const r = inner.getBoundingClientRect();
  const scale = Math.min(1, maxW / r.width, maxH / r.height);

  inner.style.transform = `scale(${scale})`;
  wrap.style.height = (r.height * scale) + 'px';
}

document.addEventListener('DOMContentLoaded',()=>{
  checkOrientation();
  window.addEventListener('resize', checkOrientation);
  window.addEventListener('orientationchange', checkOrientation);

  // Auto-Fit beobachten
  fitMachineToViewport();
  window.addEventListener('resize', fitMachineToViewport);
  window.addEventListener('orientationchange', fitMachineToViewport);
  if (window.visualViewport) {
    visualViewport.addEventListener('resize', fitMachineToViewport);
  }

  const reels = Array.from(document.querySelectorAll('.reel'));
  const reelContainer = document.getElementById('reelContainer');
  const out   = document.getElementById('gbaResult');
  const machine = document.querySelector('.gba');

  // Lampen
  const lampOrd = document.getElementById('lampOrd');
  const lampAlt = document.getElementById('lampAlt');
  const lampLeg = document.getElementById('lampLeg');
  const lampTimers = new WeakMap(); // el -> timeoutId

  // Sounds
  const sndLever  = document.getElementById('sndLever') || document.getElementById('sndRattle');
  const sndRattle = document.getElementById('sndRattle');
  const sndStop   = document.getElementById('sndStop');
  const sndResult = document.getElementById('sndResult');
  const sndFanfare= document.getElementById('sndFanfare');

  const COLORS = ['rot','blau','gruen','gelb'];
  const IMG = {
    rot:'assets/img/rot.png',
    blau:'assets/img/blau.png',
    gruen:'assets/img/gruen.png',
    gelb:'assets/img/gelb.png'
  };
  const SVG = {
    rot:`<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'><path fill='#2b9e45' d='M42 10c6 1 10 6 10 12-6-2-11-6-10-12zM37 9c-2 5-8 10-15 10 3-7 9-11 15-10z'/><path fill='#d94a4a' d='M31 18c10 0 19 8 19 18S43 54 31 54 12 45 12 36s9-18 19-18z'/></svg>`,
    blau:`<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'><path fill='#2c9aa7' d='M42 10c6 1 10 6 10 12-6-2-11-6-10-12zM37 9c-2 5-8 10-15 10 3-7 9-11 15-10z'/><path fill='#3a7bd5' d='M31 18c10 0 19 8 19 18S43 54 31 54 12 45 12 36s9-18 19-18z'/></svg>`,
    gruen:`<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'><path fill='#1f8a4c' d='M42 10c6 1 10 6 10 12-6-2-11-6-10-12zM37 9c-2 5-8 10-15 10 3-7 9-11 15-10z'/><path fill='#2ecc71' d='M31 18c10 0 19 8 19 18S43 54 31 54 12 45 12 36s9-18 19-18z'/></svg>`,
    gelb:`<svg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'><path fill='#79b92f' d='M42 10c6 1 10 6 10 12-6-2-11-6-10-12zM37 9c-2 5-8 10-15 10 3-7 9-11 15-10z'/><path fill='#f5d142' d='M31 18c10 0 19 8 19 18S43 54 31 54 12 45 12 36s9-18 19-18z'/></svg>`
  };

  const RECIPES = {
    // 4 Gleiche → 15/14
    'rot,rot,rot,rot':   {name:'Dösselheimer Güllebier',        pts:15, desc:'Die braune Seele Saxoniens.'},
    'blau,blau,blau,blau': {name:'Leberknebel - Export',        pts:15, desc:'Seitenstechen auch ohne Meuchelmörder.'},
    'gruen,gruen,gruen,gruen': {name:'Braune Soße',            pts:14, desc:'Zähflüssig, herzhaft, löst Sorgen und Rost.'},
    'gelb,gelb,gelb,gelb': {name:'Flotter Otto - Extra Hell',   pts:14, desc:'Fließt es erst heraus, bleibst du lieber gleich zuhaus!'},

    // 3 Gleiche + 1 → 13/12/14 (rot hoch)
    'rot,rot,rot,blau':  {name:'Klemritzer Nierenquetscher',    pts:14, desc:'Massiert die Organe von innen nach außen.'},
    'rot,rot,rot,gruen': {name:'Rülpsheimer Starkbier',         pts:13, desc:'Schenkt Bass im Bauch.'},
    'rot,rot,rot,gelb':  {name:'Lord Villains Glanzparade',     pts:13, desc:'Edel und unbestechlich herb.'},
    'blau,blau,blau,rot':  {name:'Donnerburger Steißtritt',     pts:13, desc:'Treffsicherer Geschmack.'},
    'blau,blau,blau,gruen':{name:'Hassnitzer Kellerbräu',       pts:13, desc:'Aus dem ganz dunklen Fass.'},
    'blau,blau,blau,gelb': {name:'Stinkhornsuppe - Spezial',    pts:12, desc:'Duftet nach Abenteuer, Freiheit und alten Socken.'},
    'gruen,gruen,gruen,rot': {name:'Plärrener Humpentrunk',     pts:12, desc:'Groß im Glas, laut im Kopf.'},
    'gruen,gruen,gruen,blau':{name:'Hassburger Urstoff Brühe',  pts:12, desc:'So bekömmlich wie eine kleine Pilzvergiftung.'},
    'gruen,gruen,gruen,gelb':{name:'Dreschmarer Magenhieb',     pts:12, desc:'Direkt, ehrlich, unvergesslich.'},
    'gelb,gelb,gelb,rot':  {name:'Knurrwitzer Abtritt',         pts:12, desc:'So männlich wie konservative Ein - Artikler.'},
    'gelb,gelb,gelb,blau': {name:'Ynnors Schnarchtrunk',        pts:12, desc:'Wirkt sofort.'},
    'gelb,gelb,gelb,gruen':{name:'Schwitzwasser Abblende',      pts:12, desc:'Leicht bekömmliches Dünnbier.'},

    // 2 Paare → 11/10/9
    'rot,rot,blau,blau':   {name:'Beißburger Rübenhamsterwurf', pts:11, desc:'Zwei Paare, ein Ziel.'},
    'rot,rot,gruen,gruen': {name:'Ningelner Nostalgiker - Urtyp',pts:11, desc:'Schmeckt so gut wie früher, nur besser.'},
    'rot,rot,gelb,gelb':   {name:'Stockheimer Knollentrunk',    pts:10, desc:'Dick im Glas, jetzt mit noch mehr Fruchtfleisch.'},
    'blau,blau,gruen,gruen':{name:'Plärrener Feldschorle - Spezial', pts:10, desc:'Damit sie auch Morgen noch lauthals schreien können.'},
    'blau,blau,gelb,gelb': {name:'Grollstädter Rübensprudel - Deluxe', pts:9, desc:'Gebraut mit Liebe.'},
    'gruen,gruen,gelb,gelb':{name:'Grimmiger Krauttrunk - Extra Herb', pts:9, desc:'Kratzig im Abgang.'},

    // 1 Paar + 2 verschiedene
    'rot,rot,blau,gruen': {name:'Kellerleichen - Party - Mix',  pts:8, desc:'Für Nächte an die man sich lieber nicht erinnert.'},
    'rot,rot,blau,gelb':  {name:'Broilinger Doppelacker Sud',   pts:7, desc:'Das beste aus zwei Welten.'},
    'rot,rot,gruen,gelb': {name:'Feierabend Erntetrunk',        pts:7, desc:'Erfrischend wie eine 16 Stundenschicht bei Schnell & Billig.'},

    'blau,blau,rot,gruen': {name:'Zwicker Feldweg - Knöchelknacks', pts:6, desc:'Holprig und bitter.'},
    'blau,blau,rot,gelb':  {name:'Ackerbowle',                  pts:6, desc:'Erdig-Herb'},
    'blau,blau,gruen,gelb':{name:'Lumpa Umpas goldene Brause - Edel', pts:6, desc:'Kurz aber kräftig.'},

    'gruen,gruen,rot,blau': {name:'Freudloser Hopfenrübling - Hell', pts:5, desc:'Der Spaß aus dem Glas.'},
    'gruen,gruen,rot,gelb': {name:'Ackerschorle - Export',      pts:5, desc:'Das Erfrischungsgetränk für jede Arbeit.'},
    'gruen,gruen,blau,gelb':{name:'Winkelstädter Gärtnerpils',  pts:5, desc:'Gereift im Biercubus.'},

    'gelb,gelb,rot,blau':  {name:'Lästerhainer Jodelsprudel',   pts:4, desc:'Nach zwei Schlucken singst du.'},
    'gelb,gelb,rot,gruen': {name:'Donnerburger Rübenschädel - Spezial', pts:4, desc:'Gebraut mit Blitz und Donner.'},
    'gelb,gelb,blau,gruen':{name:'Karnickelfangschlag',         pts:4, desc:'Erst pelzig auf der Zunge, dann schnell im Abgang.'},

    // Alle unterschiedlich → 2
    'rot,blau,gruen,gelb': {name:'Querbeet - Klassik',          pts:2, desc:'Von allem ein bisschen.'}
  };

  /* Reihenfolgeunabhängiger Index */
  const RECIPES_INDEX={};
  Object.keys(RECIPES).forEach(k=>{ RECIPES_INDEX[k.split(',').sort().join(',')] = RECIPES[k]; });
  function normalize(combo){ return combo.slice().sort().join(','); }

  function evaluate(result){
    const key = normalize(result);
    const recipe = RECIPES_INDEX[key] || {name:'Krautwasser',pts:0,desc:'Schmeckt nach nix.'};

    out.innerHTML = `
      <div class="name">${recipe.name}</div>
      <div class="desc">${recipe.desc || ''}</div>
      <div class="reward">
        <span class="badge">+${recipe.pts} Thaler</span> für den Rübensammler, welcher den Auftrag als erstes erfüllt!
      </div>
    `;

    // Lampen zurücksetzen (inkl. Timer abbrechen)
    [lampOrd, lampAlt, lampLeg].forEach(l => {
      const prev = lampTimers.get(l);
      if (prev) { clearTimeout(prev); lampTimers.delete(l); }
      l.classList.remove('active','glow');
    });

    // Punktbereich -> Lampe (Legendär ab 13, mit Fanfare)
    if (recipe.pts >= 1 && recipe.pts <= 7) {
      activateLamp(lampOrd, false);
    } else if (recipe.pts >= 8 && recipe.pts <= 12) {
      activateLamp(lampAlt, false);
    } else if (recipe.pts >= 13) {
      activateLamp(lampLeg, true); // Fanfare 13–15
    }

    try { sndResult.currentTime = 0; sndResult.play(); } catch(e){}

    // nach jeder Ausgabe neu fitten (Text kann Höhe ändern)
    fitMachineToViewport();
  }

  function activateLamp(el, isLegend){
    if(!el) return;

    // alten Timeout abbrechen
    const prev = lampTimers.get(el);
    if (prev) { clearTimeout(prev); lampTimers.delete(el); }

    // Animation neu starten
    el.classList.remove('glow','active'); void el.offsetWidth;
    el.classList.add('active','glow');

    // Fanfare für Legendär (mit Reset)
    if (isLegend) {
      try { sndFanfare.pause(); sndFanfare.currentTime = 0; sndFanfare.play(); } catch(e){}
    }

    // Dauer passend zur Lampe (Green glüht länger)
    let duration = 4200;
    if (el.classList.contains('lamp--green')) duration = 5000;
    if (el.classList.contains('lamp--legend')) duration = 4200;

    const t = setTimeout(()=>{
      el.classList.remove('active','glow');
      lampTimers.delete(el);
    }, duration);
    lampTimers.set(el, t);
  }

  function randomColor(){ return COLORS[Math.floor(Math.random()*COLORS.length)]; }
  function setSymbol(reelEl,color){
    const sym = reelEl.querySelector('.symbol');
    sym.className = 'symbol ' + color;
    const img = new Image(); img.decoding='async'; img.alt = color + 'e Rübe';
    img.onload = ()=>{ sym.innerHTML=''; sym.appendChild(img); };
    img.onerror = ()=>{ sym.innerHTML = SVG[color]; };
    img.src = IMG[color];
  }

  // Startanzeige
  reels.forEach(reel => setSymbol(reel, randomColor()));

  /* ---------- Hebel-Logik ---------- */
  const lever = document.getElementById('lever');
  const knob  = lever.querySelector('.lever__knob');
  const ring  = lever.querySelector('.lever__ring');

  let isDragging = false;
  let isSpinning = false;
  let startY = 0, startKnob = 0;
  let minY = 0, maxY = 0, knobH = 56, pad = 14;

  function measure(){
    const rect = lever.getBoundingClientRect();
    maxY = rect.height - knobH - pad;
    minY = 0;
  }
  measure(); window.addEventListener('resize', measure);

  function setKnobY(y, withTransition=true){
    const clamped = Math.max(minY, Math.min(maxY, y));
    if(!withTransition){ knob.style.transition='none'; ring.style.transition='none'; }
    knob.style.setProperty('--y', clamped + 'px');
    ring.style.transform = `translate(-50%, ${clamped + 52}px)`;
    if(!withTransition){ void knob.offsetHeight; }
    return clamped;
  }
  function enableKnobTransition(){
    knob.style.transition = 'transform .28s cubic-bezier(.2,.8,.2,1)';
    ring.style.transition = 'transform .28s cubic-bezier(.2,.8,.2,1)';
  }

  function pullStart(e){
    if(isSpinning || lever.classList.contains('locked')) return;
    isDragging = true; lever.classList.add('pulling');
    const pY = ('touches' in e) ? e.touches[0].clientY : e.clientY;
    startY = pY;
    const current = parseFloat(getComputedStyle(knob).getPropertyValue('--y')) || 0;
    startKnob = current;
    setKnobY(current, false);
    try{ sndLever.currentTime=0; sndLever.play(); }catch(_){}
    if(lever.setPointerCapture && e.pointerId != null){ lever.setPointerCapture(e.pointerId); }
    e.preventDefault();
  }
  function pullMove(e){
    if(!isDragging) return;
    const pY = ('touches' in e) ? e.touches[0].clientY : e.clientY;
    const dy = pY - startY;
    setKnobY(startKnob + dy, false);
    e.preventDefault();
  }
  function pullEnd(e){
    if(!isDragging) return;
    isDragging = false; lever.classList.remove('pulling'); enableKnobTransition();
    try{ sndLever.pause(); }catch(_){}
    const current = parseFloat(getComputedStyle(knob).getPropertyValue('--y')) || 0;
    const ratio = current / (maxY || 1);
    setKnobY(minY, true);
    if(ratio >= 0.8 && !isSpinning){ spin(); }
  }

  lever.addEventListener('pointerdown', pullStart);
  lever.addEventListener('pointermove', pullMove);
  lever.addEventListener('pointerup', pullEnd);
  lever.addEventListener('pointercancel', pullEnd);
  lever.addEventListener('touchstart', pullStart, {passive:false});
  lever.addEventListener('touchmove',  pullMove,  {passive:false});
  lever.addEventListener('touchend',   pullEnd);
  lever.addEventListener('mousedown',  pullStart);
  window.addEventListener('mousemove', pullMove);
  window.addEventListener('mouseup',   pullEnd);

  // Tastatur-Fallback
  lever.addEventListener('keydown', (e)=>{
    if(isSpinning || e.repeat) return;
    if(e.key === ' ' || e.key === 'Enter'){
      e.preventDefault();
      setKnobY(maxY, true);
      try{ sndLever.currentTime=0; sndLever.play(); }catch(_){}
      setTimeout(()=>{ setKnobY(minY, true); try{ sndLever.pause(); }catch(_){}; spin(); }, 180);
    }
  });

  /* ---------- Spin ---------- */
  function spin(){
    isSpinning = true;
    lever.classList.add('locked');

    // Lampen reset + Timer abbrechen
    [lampOrd, lampAlt, lampLeg].forEach(l => {
      const prev = lampTimers.get(l);
      if (prev) { clearTimeout(prev); lampTimers.delete(l); }
      l.classList.remove('active','glow');
    });

    out.classList.add("loading");
    out.innerHTML = `<div>…suche Rezept für den Ernteauftrag…</div>`;

    // Maschine wackeln
    machine?.classList.add('shake');
    setTimeout(()=> machine?.classList.remove('shake'), 380);

    // Reels-Shader ausblenden
    reelContainer.classList.add('spinning');

    // Sounds
    try{ sndRattle.currentTime=0; sndRattle.play(); }catch(_){}

    const finals = [];
    reels.forEach((reel,i)=>{
      reel.classList.add('spinning');
      const speed = 95;
      const t = setInterval(()=> setSymbol(reel, randomColor()), speed);

      const stopAfter = 1100 + i*650 + Math.floor(Math.random()*260);
      setTimeout(()=>{
        clearInterval(t);
        const c = randomColor();
        setSymbol(reel, c);
        finals[i] = c;

        try{ sndStop.currentTime=0; sndStop.play(); }catch(_){}
        reel.classList.remove('spinning');
        reel.classList.add('stop-bounce');
        reel.addEventListener('animationend', ()=> reel.classList.remove('stop-bounce'), {once:true});

        if(i === reels.length-1){
          try{ sndRattle.pause(); }catch(_){}
          out.classList.remove("loading");
          reelContainer.classList.remove('spinning');
          evaluate(finals);

          // Hebel wieder freigeben
          isSpinning = false;
          lever.classList.remove('locked');

          // nach Spin neu fitten (Höhe kann sich ändern)
          fitMachineToViewport();
        }
      }, stopAfter);
    });
  }
});
</script>
</body>
</html>
