<!doctype html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>Saxonischer Automat (Design-Space 1920×1080)</title>
<style>
  /* ====== Design-Space Grundwerte ====== */
  :root{
    --design-w: 1920;
    --design-h: 1080;

    /* Reel-Fenster (PX in 1920×1080) */
    --r-top:   340;
    --r-w:     270;
    --r-h:     270;
    --r0-left: 300;
    --r1-left: 640;
    --r2-left: 980;
    --r3-left: 1320;

    /* Ergebnisfenster (PX) */
    --res-left: 280;
    --res-top:  740;
    --res-w:    1360;
    --res-h:    200;

    /* Hebel/Lampen (PX, Zentrum) */
    --lever-x: 150;
    --lever-y: 560;
    --lamps-x: 1770;
    --lamps-y: 520;

    /* Proportionale Skalen */
    --reel-scale: 1;
    --lever-scale: 1;
    --lamps-scale: 1;

    /* UI Buttons (gleich groß) */
    --ui-btn-w: 220px;
    --ui-btn-h: 52px;
    --ui-opacity: 0.85;
    --ui-radius: 12px;
    --ui-pad-x: 14px;
    --ui-pad-y: 10px;

    /* Canvas-Buttons Position */
    --sound-x: 12px;
    --sound-y: 12px;
    --exit-x:  12px;
    --exit-y:  72px;

    /* Farben */
    --lamp-red:   #ff4d4d;
    --lamp-green: #4cd964;
    --lamp-blue:  #4da6ff;
    --lamp-gold:  #ffd400;

    /* Ergebnis-Text */
    --result-name-color:   #ffffff;
    --result-desc-color:   #e8e8e8;
    --result-points-color: #ffd24a;
    --result-name-size:    32px;
    --result-desc-size:    24px;
    --result-points-size:  26px;

    /* Schimmer */
    --shine-angle: 120deg;
    --shine-core:  .20;
    --shine-speed: 9s;
    --scan-angle:  180deg;
    --scan-thickness: 1px;
    --scan-spacing:  3px;
    --scan-bright: rgba(255,255,255,.08);
    --scan-dark:   rgba(0,0,0,0);
    --scan-opacity: .22;
    --scan-blend: overlay;

    /* Lampen */
    --lamps-gap: 10px;
    --lamp-afterglow: 4.2s;

    /* Sound */
    --sound-enabled: 1;

    /* Debug Farben */
    --outline-reel:   #4dbbff;
    --outline-result: #59ffa1;

    /* Startscreen */
    --start-bg: #000;
    --start-fg: #fff;

    /* Hebel-Grenzen */
    --lever-bottom-clearance: 6;
    --lever-ring-offset: 52;
    --lever-ring-h: 8;

    /* === NEU: Scoreboard-Buttons (px in 1920×1080) === */
    --sb-start-x:  540px;
    --sb-start-y:  900px;
    --sb-sound-x:  820px;
    --sb-sound-y:  900px;
    --sb-auto-x:   1100px;
    --sb-auto-y:   900px;
    --sb-reset-x:  1380px;
    --sb-reset-y:  900px;
  
/* Scoreboard-Container: Position & Scale */
  --sb-players-left: 240px;
  --sb-players-right: 240px;
  --sb-players-top: 170px;
  --sb-players-scale: 1;

  --sb-round-left: 240px;
  --sb-round-right: 240px;
  --sb-round-bottom: 380px;
  --sb-round-scale: 1;

  --sb-controls-left: 240px;
  --sb-controls-right: 240px;
  --sb-controls-bottom: 210px;
  --sb-controls-scale: 1;

  /* Scoreboard-Actions (Start/Sound/Automatron/Reset) – Gruppen-Transform */
  --sb-actions-scale: 1;
  --sb-actions-translate-x: 0px;
  --sb-actions-translate-y: 0px;
}
  /* Override (dein Standard-Layout) */
  :root{
  --r-top: 345;
  --r-w: 315;
  --r-h: 271;
  --r0-left: 313;
  --r1-left: 633;
  --r2-left: 952;
  --r3-left: 1273;
  --res-left: 340;
  --res-top: 730;
  --res-w: 1230;
  --res-h: 250;
  --lever-x: 162;
  --lever-y: 546;
  --lamps-x: 1744;
  --lamps-y: 492;
  --reel-scale: 1;
  --lever-scale: 1.5;
  --lamps-scale: 0.87;
  --sb-players-scale: 1.24;
  --sb-round-scale: 1.55;
  --sb-controls-scale: 0.9;
  --sb-actions-scale: 1.2;
  --lamps-gap: 49px;
  --lamp-afterglow: 3.2s;
  --ui-btn-w: 124px;
  --ui-btn-h: 46px;
  --ui-opacity: 0.85;
  --shine-core: .20;
  --shine-speed: 9s;
  --shine-angle: 120deg;
  --scan-thickness: 1.5px;
  --scan-spacing: 3px;
  --scan-opacity: 0.3;
  --scan-blend: overlay;
  --result-name-size: 40px;
  --result-desc-size: 35px;
  --result-points-size: 30px;
  --result-name-color: #008040;
  --result-desc-color: #008040;
  --result-points-color: #008040;
  --scan-angle: 180deg;
  --scan-bright: #00ff40;
  --scan-dark: #004000;
  --sound-x: 80px;
  --sound-y: 826px;
  --exit-x: 80px;
  --exit-y: 905px;
  --sb-start-x: 235px;
  --sb-start-y: 610px;
  --sb-sound-x: 1000px;
  --sb-sound-y: 610px;
  --sb-auto-x: 430px;
  --sb-auto-y: 610px;
  --sb-reset-x: 1195px;
  --sb-reset-y: 610px;
  --sb-players-left: 276px;
  --sb-players-right: 539px;
  --sb-players-top: 97px;
  --sb-round-left: 840px;
  --sb-round-right: 840px;
  --sb-round-bottom: 290px;
  --sb-controls-left: 240px;
  --sb-controls-right: 240px;
  --sb-controls-bottom: 93px;
  --sb-actions-translate-x: 0px;
  --sb-actions-translate-y: 0px;
  --sound-enabled: 1;
}

  /* ===== Animierbare Custom Properties für Fit & Shake ===== */
  @property --fit-x      { syntax:"<length>"; inherits:false; initial-value: 0px; }
  @property --fit-y      { syntax:"<length>"; inherits:false; initial-value: 0px; }
  @property --fit-scale  { syntax:"<number>"; inherits:false; initial-value: 1; }
  @property --shake-x    { syntax:"<length>"; inherits:false; initial-value: 0px; }
  @property --shake-y    { syntax:"<length>"; inherits:false; initial-value: 0px; }
  @property --shake-rot  { syntax:"<angle>";  inherits:false; initial-value: 0deg; }
  @property --shake-mag  { syntax:"<length>"; inherits:false; initial-value: 4px; }
  @property --shake-rot-mag { syntax:"<angle>"; inherits:false; initial-value: .2deg; }
  @property --shake-sign { syntax:"<number>"; inherits:false; initial-value: 1; }

  /* Seite & Bühne */
  html,body{margin:0;padding:0;height:100%;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif; -webkit-text-size-adjust:100%}
  .stage{
  position:fixed; inset:0;
  background:#000;
  padding: env(safe-area-inset);
  /* kein display:grid; kein place-items:center; */
}

 /* Canvas links-oben verankern, Zentrierung/Skalierung per Vars */
.canvas{
  position:absolute; left:0; top:0;
  width: calc(var(--design-w) * 1px);
  height: calc(var(--design-h) * 1px);
  transform-origin: top left;
  transform:
    translate(var(--fit-x), var(--fit-y))
    scale(var(--fit-scale))
    rotate(var(--shake-rot));
}

  .plate__img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:7;pointer-events:none;}

  .global-sweep{position:absolute; inset:0; z-index:4; pointer-events:none; overflow:hidden;}
  .global-sweep__stripe{
    position:absolute; top:0; bottom:0; left:-120%; width:120%;
    background:linear-gradient(var(--shine-angle),
      rgba(255,255,255,0) 30%,
      rgba(255,255,255,var(--shine-core)) 50%,
      rgba(255,255,255,0) 70%);
    transform:skewX(-20deg);
    animation:sweep var(--shine-speed) linear infinite;
  }
  .apply-clip{ clip-path: url(#winClip); }
  @keyframes sweep{ from{ left:-120%; } to{ left:120%; } }
  .reels.spinning ~ .global-sweep{ display:none; }

  .reels{position:absolute; inset:0; z-index:1; transform:scale(var(--reel-scale)); transform-origin:center;}
  .reel{
    position:absolute;
    top:  calc(var(--r-top) * 1px);
    width:calc(var(--r-w)   * 1px);
    height:calc(var(--r-h)  * 1px);
    display:flex; align-items:center; justify-content:center; overflow:hidden; border-radius:10px;
    background:#111; padding:10px; box-shadow: inset 0 2px 10px rgba(0,0,0,.6), 0 8px 18px rgba(0,0,0,.25);
  }
  #reel-0{left:calc(var(--r0-left) * 1px);}
  #reel-1{left:calc(var(--r1-left) * 1px);}
  #reel-2{left:calc(var(--r2-left) * 1px);}
  #reel-3{left:calc(var(--r3-left) * 1px);}

  .reel::before, .reel::after{ content:""; position:absolute; left:0; right:0; height:22%; pointer-events:none; z-index:3; }
  .reel::before{ top:0;    background:linear-gradient(to bottom, rgba(0,0,0,.6), rgba(0,0,0,0)); }
  .reel::after { bottom:0; background:linear-gradient(to top,    rgba(0,0,0,.6), rgba(0,0,0,0)); }

  .reel .sweep{ display:none !important; }

  .symbol{ position:relative; width:80%; aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; overflow:hidden; will-change: transform, filter; transition: filter .2s ease; }
  .symbol img{width:100%;height:100%;object-fit:contain;display:block;}

  .reel.spinning .symbol{ filter: blur(3px) saturate(1.1); animation: spin-jitter .12s linear infinite; }
  @keyframes spin-jitter{ 0%{transform:translateY(-3%)} 50%{transform:translateY(3%)} 100%{transform:translateY(-3%)} }
  .reel.spinning .streak{
    position:absolute; inset:-30% -10%;
    background:linear-gradient(90deg, rgba(255,255,255,0) 30%, rgba(255,255,255,.25) 50%, rgba(255,255,255,0) 70%);
    filter: blur(6px); opacity:.18; transform: rotate(12deg);
    animation: streak .5s linear infinite; pointer-events:none; z-index:4;
  }
  @keyframes streak{ from{transform:rotate(12deg) translateX(-8%)} to{transform:rotate(12deg) translateX(8%)} }
  .reel.stop-bounce .symbol{ animation: stop-bounce .32s cubic-bezier(.2,.8,.2,1) 1; filter:none; }
  @keyframes stop-bounce{ 0%{transform:translateY(10%)} 60%{transform:translateY(-4%)} 100%{transform:translateY(0)} }

  .result{
    position:absolute;
    left: calc(var(--res-left) * 1px);
    top:  calc(var(--res-top)  * 1px);
    width:calc(var(--res-w)    * 1px);
    height:calc(var(--res-h)   * 1px);
    display:grid; place-items:center; text-align:center; padding:8px 10px; z-index:0; line-height:1.25;
    overflow:hidden;
  }
  .result-inner{ display:grid; gap:.35rem; position:relative; z-index:1; }
  .result-inner .name{ color:var(--result-name-color);   font-size:var(--result-name-size);   font-weight:800; letter-spacing:.02em; }
  .result-inner .desc{ color:var(--result-desc-color);   font-size:var(--result-desc-size);   opacity:.95; }
  .result-inner .points{ color:var(--result-points-color); font-size:var(--result-points-size); font-weight:800; }

  .result::after{
    content:""; position:absolute; inset:0; pointer-events:none;
    background: repeating-linear-gradient(
      var(--scan-angle),
      var(--scan-bright) 0,
      var(--scan-bright) var(--scan-thickness),
      var(--scan-dark)   var(--scan-thickness),
      var(--scan-dark)   calc(var(--scan-thickness) + var(--scan-spacing))
    );
    mix-blend-mode: var(--scan-blend);
    opacity: var(--scan-opacity);
    z-index:0;
  }
/* === Sweep-Glanz auf Name, Titel, Thaler und Runde === */
.players .name-wrap,
.players .pill,
.players .thaler,
.round-indicator{
  position: relative;
  overflow: hidden;
}

/* Sweep-Lichtbahn (nutzt --shine-angle / --shine-core / --shine-speed) */
.players .name-wrap::before,
.players .pill::before,
.players .thaler::before,
.round-indicator::before{
  content: "";
  position: absolute;
  top: 0; bottom: 0;
  left: -120%; width: 120%;
  pointer-events: none;
  background: linear-gradient(
    var(--shine-angle),
    rgba(255,255,255,0) 30%,
    rgba(255,255,255,var(--shine-core)) 50%,
    rgba(255,255,255,0) 70%
  );
  transform: skewX(-20deg);
  animation: sweep var(--shine-speed) linear infinite;
  z-index: 1;                 /* unter Scanlines lassen */
}

/* (optional) falls du zusätzlich Scanlines auf denselben Boxen hast:
   die Scanlines oben drüber legen */
.players .name-wrap::after,
.players .pill::after,
.players .thaler::after{
  z-index: 2;
}

  .lever-area{
    position:absolute;
    left: calc(var(--lever-x) * 1px);
    top:  calc(var(--lever-y) * 1px);
    transform:translate(-50%,-50%) scale(var(--lever-scale));
    z-index:8;
  }
  .lever{ width:72px; height:300px; position:relative; cursor:grab; user-select:none; touch-action:none; filter: drop-shadow(0 6px 14px rgba(0,0,0,.35)); }
  .lever__back{ position:absolute; inset:0; border-radius:10px; background:linear-gradient(180deg,#1a1a1a,#0f0f0f); box-shadow: inset 0 6px 10px rgba(0,0,0,.6), inset 0 -6px 10px rgba(0,0,0,.4); }
  .lever__slot{ position:absolute; left:50%; top:14px; bottom:14px; width:12px; transform:translateX(-50%); background:#080808; border-radius:8px; box-shadow: inset 0 0 10px rgba(0,0,0,.9); }
  .lever__arm{ position:absolute; left:50%; top:22px; width:6px; bottom:22px; transform:translateX(-50%); background:linear-gradient(180deg,#555,#2a2a2a); border-radius:3px; box-shadow: inset 0 0 4px rgba(0,0,0,.6); }
  .lever__knob{
    --y:0px; position:absolute; left:50%; top:0; width:56px; height:56px; transform:translate(-50%, var(--y));
    border-radius:50%;
    background: radial-gradient(circle at 30% 30%, #ffb8b8, #ff4a4a 45%, #d33c3c 75%, #8a1d1d 100%);
    box-shadow: 0 10px 18px rgba(0,0,0,.45), inset 0 2px 0 rgba(255,255,255,.35);
    overflow:hidden; isolation:isolate;
  }
  .lever__knob::after{
    content:""; position:absolute; inset:0; border-radius:50%;
    background:linear-gradient(120deg, rgba(255,255,255,.65) 0%, rgba(255,255,255,0) 40%);
    mix-blend-mode:screen; opacity:.35; pointer-events:none; animation: knobShine 3s linear infinite;
  }
  @keyframes knobShine{ from{ transform:translateX(-100%) rotate(25deg);} to{ transform:translateX(100%) rotate(25deg);} }
  .lever__ring{ position:absolute; left:50%; width:32px; height:8px; transform:translate(-50%, calc(var(--y) + 52px)); background:linear-gradient(180deg,#777,#333); border-radius:8px; filter:blur(.2px); }

  .lamps-area{
    position:absolute;
    left: calc(var(--lamps-x) * 1px);
    top:  calc(var(--lamps-y) * 1px);
    transform:translate(-50%,-50%) scale(var(--lamps-scale));
    z-index:8;
    display:flex; flex-direction:column; gap: max(var(--lamps-gap), 8px);
  }
  @supports not (gap: 1px) {
    .lamps-area .lamp + .lamp{ margin-top: max(var(--lamps-gap), 8px); }
  }

  .lamp{
    pointer-events:none; user-select:none; min-width:160px; height:56px; padding:0 16px;
    display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden;
    border-radius:32px; background:linear-gradient(180deg,#2f2f2f,#161616);
    box-shadow: inset 0 4px 10px rgba(0,0,0,.7), inset 0 -4px 8px rgba(0,0,0,.5);
  }
  .lamp__label{ font-weight:900; letter-spacing:.08em; text-transform:uppercase; color:#8a8aa0; text-shadow: 0 1px 0 rgba(0,0,0,.6); }
  .lamp__shine{ content:""; position:absolute; inset:0; background: radial-gradient(ellipse at 50% -30%, rgba(255,255,255,.25), rgba(255,255,255,0) 45%); opacity:.35; mix-blend-mode:screen; }

  .lamp--red.active{   background: radial-gradient(circle at 50% 20%, #ffd6d6 0%, #ff4d4d 40%, #b11717 70%, #4a0a0a 100%); box-shadow: 0 0 18px 6px rgba(255,80,80,.55), 0 0 36px 16px rgba(255,80,80,.22); animation: lampPulse 1.2s ease-out 1; }
  .lamp--green.active{ background: radial-gradient(circle at 50% 20%, #eaffea 0%, #4cd964 40%, #1db954 70%, #0e3f1d 100%); box-shadow: 0 0 18px 6px rgba(80,255,120,.55), 0 0 36px 16px rgba(80,255,120,.22); animation: lampPulse 1.2s ease-out 1; }
  .lamp--blue.active{  background: radial-gradient(circle at 50% 20%, #e2efff 0%, #4da6ff 40%, #175ab1 70%, #0a224a 100%); box-shadow: 0 0 18px 6px rgba(80,120,255,.55), 0 0 36px 16px rgba(80,120,255,.22); animation: lampPulse 1.2s ease-out 1; }
  .lamp--gold.active{  background:#FFD400; box-shadow: 0 0 18px 6px rgba(255,212,0,.65), 0 0 36px 16px rgba(255,212,0,.28); animation: lampPulse 1.2s ease-out 1; }
  @keyframes lampPulse{ 0%{box-shadow:0 0 0 0 rgba(255,255,255,0)} 60%{box-shadow:0 0 28px 12px rgba(255,255,255,.65)} 100%{box-shadow:0 0 18px 6px rgba(255,255,255,.4)} }
  .lamp.glow::after{ content:""; position:absolute; inset:-10px; border-radius:inherit; opacity:0; filter: blur(10px); pointer-events:none; animation: afterglow var(--lamp-afterglow) ease-out forwards; }
  .lamp--gold.glow::after { background: radial-gradient(ellipse at 50% 50%, rgba(255,212,0,.90), rgba(255,212,0,.45) 42%, rgba(255,212,0,0) 70%); }
  .lamp--red.glow::after  { background: radial-gradient(ellipse at 50% 50%, rgba(255,110,110,.85), rgba(255,80,80,.35) 40%, rgba(255,80,80,0) 70%); }
  .lamp--green.glow::after{ background: radial-gradient(ellipse at 50% 50%, rgba(120,255,160,.85), rgba(80,255,120,.35) 40%, rgba(80,255,120,0) 70%); }
  .lamp--blue.glow::after { background: radial-gradient(ellipse at 50% 50%, rgba(140,180,255,.85), rgba(100,140,255,.35) 40%, rgba(100,140,255,0) 70%); }

  .debug .reel{ outline:2px dashed var(--outline-reel); outline-offset:-2px; }
  .debug .result{ outline:2px dashed var(--outline-result); }
  .debug .lever-area{ outline:2px dashed #ff8a00; outline-offset:4px; }
  .debug .score-card{ outline:2px dashed #4dbbff; outline-offset:-2px; }
  .debug .sb-btn{ outline:2px dashed #ff8a00; }
/* ==== Debug: Scoreboard komplett markieren ==== */
.debug .players .row{ outline:2px dashed #4dbbff; outline-offset:-2px; }
.debug .name-input{ outline:2px dashed #59ffa1; }
.debug .coin-badge{ outline:2px dashed #ffd400; }
.debug .pill{ outline:2px dashed #59ffa1; }
.debug .thaler{ outline:2px dashed #59ffa1; }
.debug #roundIndicator{ outline:2px dashed #ffd24a; }
.debug .score-controls{ outline:2px dashed #ff8a00; }
.debug #roundsBox,
.debug #diffBox{ outline:2px dashed #ff8a00; }
.debug .score-actions .sb-btn{ outline:2px dashed #ff8a00; }

  /* zufälliger Canvas-Shake */
  @keyframes machine-shake {
    0%   { --shake-x: 0px; --shake-y: 0px; --shake-rot: 0deg; }
    20%  { --shake-x: calc( .5 * var(--shake-mag) * var(--shake-sign));  --shake-y: calc(-.5 * var(--shake-mag)); --shake-rot: calc(-1 * var(--shake-rot-mag) * var(--shake-sign)); }
    40%  { --shake-x: calc(-.5 * var(--shake-mag) * var(--shake-sign));  --shake-y: calc( .5 * var(--shake-mag)); --shake-rot: calc( 1 * var(--shake-rot-mag) * var(--shake-sign)); }
    60%  { --shake-x: calc( .3 * var(--shake-mag) * var(--shake-sign));  --shake-y: calc(-.3 * var(--shake-mag)); --shake-rot: calc(-.6 * var(--shake-rot-mag) * var(--shake-sign)); }
    80%  { --shake-x: calc(-.3 * var(--shake-mag) * var(--shake-sign));  --shake-y: calc( .3 * var(--shake-mag)); --shake-rot: calc( .6 * var(--shake-rot-mag) * var(--shake-sign)); }
    100% { --shake-x: 0px; --shake-y: 0px; --shake-rot: 0deg; }
  }
  .canvas.shake { animation: machine-shake 320ms ease; }

  .ui-fixed-btn{
    position:absolute; z-index:12; display:inline-flex; align-items:center; justify-content:center;
    width:var(--ui-btn-w); height:var(--ui-btn-h);
    padding:var(--ui-pad-y) var(--ui-pad-x);
    border-radius:var(--ui-radius);
    border:1px solid rgba(255,255,255,calc(var(--ui-opacity)*.7));
    background: rgba(20,20,20,var(--ui-opacity));
    color:#fff; cursor:pointer; font-weight:800; letter-spacing:.02em;
    backdrop-filter: blur(4px);
    box-sizing:border-box;
  }
  #scoreboardBtn{ left:var(--sound-x); top:var(--sound-y); }
  #exitBtn{ left:var(--exit-x); top:var(--exit-y); text-decoration:none; }

  /* Debug-Button fix im Viewport */
  #dbgToggle{ position:fixed; right:12px; bottom:12px; z-index:2147483647; }

  #dbgPanel{ position:fixed; right:12px; bottom:64px; width:min(92vw,420px); max-height:72vh; overflow:auto; z-index:2147483646; background:#0b0b0b; color:#fff; border:1px solid #333; border-radius:14px; box-shadow:0 12px 28px rgba(0,0,0,.5); display:none; }
  #dbgPanel header{ position:sticky; top:0; padding:10px 12px; background:#101010; border-bottom:1px solid #222; display:flex; align-items:center; justify-content:space-between; gap:8px; cursor:move; }
  #dbgPanel header h4{ margin:0; font-size:1rem; }
  #dbgPanel .grp{ padding:10px 12px; border-top:1px solid #1a1a1a; }
  #dbgPanel .row{ display:grid; grid-template-columns: 1fr auto; align-items:center; gap:8px; margin:6px 0; }
  #dbgPanel label{ font-size:.9rem; color:#ddd; }
  #dbgPanel input[type="range"]{ width:100%; }
  #dbgPanel input[type="number"]{ width:110px; background:#000; color:#fff; border:1px solid #333; border-radius:8px; padding:6px; }
  #dbgPanel input[type="color"]{ width:42px; height:32px; padding:0; border:none; background:transparent; }
  #dbgPanel input[type="text"]{ width:100%; background:#000; color:#fff; border:1px solid #333; border-radius:8px; padding:6px; }

  /* Startscreen: eigener Scroll-Container */
.startscreen{
  position:fixed; inset:0; z-index:2147483602;
  display:flex; flex-direction:column;
  background:var(--start-bg); color:var(--start-fg);
  padding: env(safe-area-inset);
  min-height:100dvh;
  overflow:auto;                    /* ← Scrollen auf Handy */
  -webkit-overflow-scrolling:touch;
}
  .startscreen button{
    display:inline-flex; align-items:center; justify-content:center;
    min-width: 280px; min-height:64px; padding:16px 22px;
    border-radius:16px; border:2px solid #fff; background:#111; color:#fff; font-size:1.15rem; font-weight:900; letter-spacing:.03em; cursor:pointer;
  }
  /* Inhalt oben, Actions unten „kleben“ */
.start-panel{ flex:1 1 auto; color:#eee; text-align:left; padding:0 16px 28px; }
  .start-panel .intro{ font-style: italic; font-size: clamp(18px, 2.2vw, 26px); line-height: 1.45; margin: 0 0 16px 0; }
  .start-panel h2{ margin: 8px 0 6px 0; font-size: clamp(22px, 2.4vw, 32px); letter-spacing:.02em; }
  .start-panel ol{ margin: 6px 0 0 1.2em; padding:0; font-size: clamp(16px, 1.8vw, 22px); line-height:1.45; }
  .start-actions{
  position: sticky; bottom: 0;
  display:flex; justify-content:center;
  gap:12px; padding: 12px 16px;
  background: linear-gradient(180deg, transparent, rgba(0,0,0,.6));
}

  #rotateOverlay{position:fixed;inset:0;display:none;z-index:9999;background:rgba(0,0,0,.9);color:#FFD700;align-items:center;justify-content:center;text-align:center;padding:20px;box-sizing:border-box}

/* Dev-Placeholders für Screensaver */
.ss-dev-placeholders .at-bug::after{
  content:"🐞"; display:block; text-align:center;
  font-size:48px; line-height:72px;
}
.ss-dev-placeholders .at-hamster::after{
  content:"🐹"; display:block; text-align:center;
  font-size:120px; line-height:140px;
}
.ss-dev-placeholders .at-gum-base,
.ss-dev-placeholders .at-gum-stretch{
  /* rosa Blob als „Kaugummi“ */
  background: radial-gradient(circle at 30% 35%, #ff9ecf, #ff4fa6 60%, #b71d6a 100%);
}

  /* ---- UI-Buttons im Lampen-Look (Canvas) ---- */
  .ui-fixed-btn.ui-lamp{
    min-width:160px;
    height:56px;
    padding:0 16px;
    border:none;
    border-radius:32px;
    display:flex; align-items:center; justify-content:center;
    background:linear-gradient(180deg,#2f2f2f,#161616);
    color:#fff;
    font-weight:900; letter-spacing:.08em; text-transform:uppercase;
    box-shadow: inset 0 4px 10px rgba(0,0,0,.7), inset 0 -4px 8px rgba(0,0,0,.5);
    cursor:pointer;
  }
  .ui-fixed-btn.ui-lamp::after{
    content:""; position:absolute; inset:0; border-radius:inherit;
    background: radial-gradient(ellipse at 50% -30%, rgba(255,255,255,.25), rgba(255,255,255,0) 45%);
    opacity:.35; mix-blend-mode:screen; pointer-events:none;
  }
  .ui-lamp--blue.active{
    background: radial-gradient(circle at 50% 20%, #e2efff 0%, #4da6ff 40%, #175ab1 70%, #0a224a 100%);
    box-shadow: 0 0 18px 6px rgba(80,120,255,.55), 0 0 36px 16px rgba(80,120,255,.22);
    animation: lampPulse 1.2s ease-out 1;
  }
  .ui-lamp--gold{ color:#222; text-shadow:none; }
  .ui-lamp--gold.active{
    background:#FFD400;
    box-shadow: 0 0 18px 6px rgba(255,212,0,.65), 0 0 36px 16px rgba(255,212,0,.28);
    animation: lampPulse 1.2s ease-out 1;
  }
  .ui-fixed-btn.ui-lamp{ width:var(--ui-btn-w); height:var(--ui-btn-h); }
  .ui-fixed-btn.ui-lamp{ color:#8a8aa0; text-shadow:0 1px 0 rgba(0,0,0,.6); }

  /* ===================== SCOREBOARD SCREEN ===================== */
  .score-screen{ position:fixed; inset:0; display:none; z-index:2147483601; background:#000; color:#fff; overflow:hidden; }
  .score-card{
    position:absolute;
    width: calc(var(--design-w) * 1px);
    height: calc(var(--design-h) * 1px);
    transform-origin: top left;
    transform: translate(var(--fit-x), var(--fit-y)) scale(var(--fit-scale));
  }
  .score-title{
    position:absolute; left:50%; top:40px; transform:translateX(-50%);
    font-size: clamp(26px, 3.4vw, 48px); font-weight:900; letter-spacing:.04em;
  }
  /* Players-Liste */
.players{
  position:absolute;
  left:  var(--sb-players-left);
  right: var(--sb-players-right);
  top:   var(--sb-players-top);
  display:grid; gap:18px; grid-template-columns: 1fr;
  transform: scale(var(--sb-players-scale));
  transform-origin: top left;
}

/* Controls (Runden/Schwierigkeit) */
.score-controls{
  position:absolute;
  left:   var(--sb-controls-left);
  right:  var(--sb-controls-right);
  bottom: var(--sb-controls-bottom);
  display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:center;
  transform: scale(var(--sb-controls-scale));
  transform-origin: bottom center;
}

/* Actions-Layer (Start/Sound/Automatron/Reset) – Gruppentransform */
.score-actions{
  position:absolute; inset:0; pointer-events:none;
  transform: translate(var(--sb-actions-translate-x), var(--sb-actions-translate-y))
             scale(var(--sb-actions-scale));
  transform-origin: top left;
}
.score-actions .sb-btn{ pointer-events:auto; }

  .row{
    display:grid; grid-template-columns: minmax(320px, 560px) 1fr auto; gap:16px; align-items:center;
    padding:12px 16px; border-radius:18px; background:linear-gradient(180deg,#1a1a1a,#0f0f0f);
    box-shadow: inset 0 4px 10px rgba(0,0,0,.65), inset 0 -6px 12px rgba(0,0,0,.45);
    position:relative; overflow:hidden;
  }
  .row::after{
    content:""; position:absolute; inset:0; pointer-events:none;
    background: repeating-linear-gradient(var(--scan-angle), var(--scan-bright) 0, var(--scan-bright) var(--scan-thickness), var(--scan-dark) var(--scan-thickness), var(--scan-dark) calc(var(--scan-thickness) + var(--scan-spacing)));
    mix-blend-mode: var(--scan-blend);
    opacity: var(--scan-opacity);
  }
  .row.inactive{ filter:grayscale(.8) opacity(.7); }

  .name-wrap{ position:relative; }
  .name-input{
    width:75%; height:54px; border:none; outline:none; border-radius:12px;
    background:rgba(255,255,255,.06); color:#fff; padding:0 14px 0 14px;
    font-size: clamp(16px, 1.8vw, 22px); font-weight:800; letter-spacing:.02em;
  }
  .name-input::placeholder{ color:#9aa0a6; }

  .coin-badge{
    position:absolute; right:8px; top:50%; transform:translateY(-50%);
    display:none; align-items:center; justify-content:center;
    min-width:74px; height:40px; padding:0 12px; border:none; border-radius:22px;
    background:#FFD400; color:#222; font-weight:900; letter-spacing:.02em; cursor:pointer;
    box-shadow: 0 0 14px rgba(255,212,0,.55), inset 0 -2px 0 rgba(0,0,0,.2);
  }
  .coin-badge.show{ display:inline-flex; }

  .pill{
    justify-self:start;
    min-width: 260px; height:54px; display:flex; align-items:center; justify-content:center;
    border-radius:28px; padding:0 16px; background:linear-gradient(180deg,#2f2f2f,#161616);
    box-shadow: inset 0 4px 10px rgba(0,0,0,.7), inset 0 -4px 8px rgba(0,0,0,.5);
    font-weight:900; letter-spacing:.06em; text-transform:uppercase; color:#d8d8d8;
  }
  .thaler{
  justify-self:end;
  min-width:180px; height:54px;
  display:flex; align-items:center; justify-content:center;
  gap:.35em;                    /* ⬅️ sorgt für Leerzeichen */
  border-radius:28px; padding:0 16px; background:#111; border:1px solid #333;
  font-weight:900; letter-spacing:.04em; color:#ffd24a;
}


 /* Labels "Runden:" / "Schwierigkeit:" ausblenden,
   aber die Radio-Labels normal lassen */
.score-controls .rounds,
.score-controls .diff{ font-size:0; }
.score-controls .rounds .lamp-button,
.score-controls .diff .lamp-button{ font-size: clamp(16px, 1.8vw, 22px); }

/* Runde-Anzeige als Scanbox (wie die Spielerzeilen/Namen) */
.round-indicator{
  position:absolute;
  left: var(--sb-round-left);
  right: var(--sb-round-right);
  bottom: var(--sb-round-bottom);

  display:flex; align-items:center; justify-content:center;
  height:54px;
  border-radius:18px;
  background:linear-gradient(180deg,#1a1a1a,#0f0f0f);
  box-shadow: inset 0 4px 10px rgba(0,0,0,.65), inset 0 -6px 12px rgba(0,0,0,.45);
  color:#d8d8d8; font-weight:900; letter-spacing:.06em;
  transform: scale(var(--sb-round-scale));
  transform-origin: center;
}
.round-indicator::after{
  content:""; position:absolute; inset:0; pointer-events:none;
  background: repeating-linear-gradient(
    var(--scan-angle),
    var(--scan-bright) 0,
    var(--scan-bright) var(--scan-thickness),
    var(--scan-dark)   var(--scan-thickness),
    var(--scan-dark)   calc(var(--scan-thickness) + var(--scan-spacing))
  );
  mix-blend-mode: var(--scan-blend);
  opacity: var(--scan-opacity);
}
/* Z-Order / Layering im Scoreboard */
.plate__img.score-bg { z-index: 0; }

/* Inhalt über Hintergrund, unter Template */
.players,
.round-indicator,
.score-controls {
  z-index: 2;
}

/* Template-Overlay oben drüber, klick-durchlässig */
.plate__img.score-template {
  z-index: 5;
  pointer-events: none;
}

/* Buttons ganz oben und weiterhin klickbar */
.score-actions { 
  z-index: 8;
  pointer-events: none;
}
.score-actions .sb-btn {
  pointer-events: auto;
}


  /* Buttons frei positioniert */
  .score-actions{ position:absolute; inset:0; pointer-events:none; }
  .score-actions .sb-btn{ pointer-events:auto; }

  .sb-btn{
    position:absolute;
    min-width:160px; height:56px; padding:0 16px; border:none; border-radius:32px;
    display:inline-flex; align-items:center; justify-content:center;
    background:linear-gradient(180deg,#2f2f2f,#161616);
    color:#fff; font-weight:900; letter-spacing:.08em; text-transform:uppercase;
    box-shadow: inset 0 4px 10px rgba(0,0,0,.7), inset 0 -4px 8px rgba(0,0,0,.5);
    cursor:pointer; text-decoration:none;
  }
  .sb-btn::after{
    content:""; position:absolute; inset:0; border-radius:inherit;
    background: radial-gradient(ellipse at 50% -30%, rgba(255,255,255,.25), rgba(255,255,255,0) 45%);
    opacity:.35; mix-blend-mode:screen; pointer-events:none;
  }
  #sbStartBtn   { left: var(--sb-start-x);  top: var(--sb-start-y); }
  #sbSoundToggle{ left: var(--sb-sound-x);  top: var(--sb-sound-y); }
  #toMachineBtn { left: var(--sb-auto-x);   top: var(--sb-auto-y); }
  #sbResetBtn   { left: var(--sb-reset-x);  top: var(--sb-reset-y); }

  .lamp-button{
    position:relative;
    display:inline-flex; align-items:center; justify-content:center;
    min-width:160px; height:56px; padding:0 16px;
    border:none; border-radius:32px;
    background:linear-gradient(180deg,#2f2f2f,#161616);
    color:#fff; font-weight:900; letter-spacing:.08em; text-transform:uppercase;
    box-shadow: inset 0 4px 10px rgba(0,0,0,.7), inset 0 -4px 8px rgba(0,0,0,.5);
    cursor:pointer; text-decoration:none;
  }
  .lamp-button::after{
    content:""; position:absolute; inset:0; border-radius:inherit;
    background: radial-gradient(ellipse at 50% -30%, rgba(255,255,255,.25), rgba(255,255,255,0) 45%);
    opacity:.35; mix-blend-mode:screen; pointer-events:none;
  }
  .lamp-button--blue.active{
    background: radial-gradient(circle at 50% 20%, #e2efff 0%, #4da6ff 40%, #175ab1 70%, #0a224a 100%);
    box-shadow: 0 0 18px 6px rgba(80,120,255,.55), 0 0 36px 16px rgba(80,120,255,.22);
    animation: lampPulse 1.2s ease-out 1;
  }
  .lamp-button--gold{ color:#222; text-shadow:none; }
  .lamp-button--gold.active{
    background:#FFD400;
    box-shadow: 0 0 18px 6px rgba(255,212,0,.65), 0 0 36px 16px rgba(255,212,0,.28);
    animation: lampPulse 1.2s ease-out 1;
  }
  .lamp-button[disabled]{ opacity:.45; cursor:not-allowed; }
/* --- Override: Scoreboard Gold-Buttons lesbar, wenn nicht aktiv --- */
.score-screen .sb-btn.lamp-button--gold { color:#fff; }        /* normal: weiß auf dunklem Grund */
.score-screen .sb-btn.lamp-button--gold.active { color:#222; } /* beim aktiven Gold-Leuchten dunkel */


  /* Scoreboard-Debug NICHT verstecken */
  #scoreDbgToggle { display: inline-flex !important; }
  #scoreDbgPanel  { display: none; }

/* === Scoreboard-Farben an Ausgabe angleichen === */

/* 1) Namen-Farbe wie Ergebnis-Name */
.score-screen .name-input{
  color: var(--result-name-color);
}

/* 2) Rundenanzeige-Farbe wie Ergebnis-Name */
.score-screen .round-indicator{
  color: var(--result-name-color);
}

/* 3) Scanlines im Scoreboard exakt wie in der Ausgabe */
.score-screen .row::after,
.score-screen .round-indicator::after{
  background: repeating-linear-gradient(
    var(--scan-angle),
    var(--scan-bright) 0,
    var(--scan-bright) var(--scan-thickness),
    var(--scan-dark)   var(--scan-thickness),
    var(--scan-dark)   calc(var(--scan-thickness) + var(--scan-spacing))
  );
  mix-blend-mode: var(--scan-blend);
  opacity: var(--scan-opacity);
}

</style>
</head>
<body>
<div class="startscreen" id="startScreen">
  <div class="start-panel">
    <p class="intro">
      <em>„In Saxonien sprudeln unzählige geheime Güllebier-Rezepte – und kein Mensch kann sie sich alle merken. Darum übernimmt der legendäre Automatron: Eine dampfbetriebene Wundermaschine voller Geheimnisse (und gelegentlicher Fehlzündungen). Sie spuckt Ernteaufträge aus, streng nach Rezept – und wehe, die Rüben stehen nicht parat!“</em>
    </p>

    <h2>Kurzanleitung</h2>
    <ol>
      <li><b>Achtung:</b> Spielt ihr mit dem Automatron habt ihr ein Handkartenlimit von 5. Alle Karten sind im Spiel.</li>
      <li><b>Vorbereitung:</b> Gebt im Scoreboard Namen ein, wählt die Runden, die Schwierigkeit und drückt Start.</li>
      <li><b>Hebel ziehen:</b> Zieht den roten Knauf kräftig nach unten (fast bis zum Ende) und lasst los – die Walzen starten.</li>
      <li><b>Kombination abwarten:</b> Die unterschiedlichen Rüben (Farben) ergeben euren Ernteauftrag.</li>
      <li><b>Seltenheit & Lohn:</b> Aufträge reichen von einfach bis legendär und werden unterschiedlich vergütet.</li>
      <li><b>Schnell sein:</b> Wer die Rüben-Kombination zuerst auslegt, darf sich die Thaler im Scoreboard gutschreiben.</li>
      <li><b>Schwierigkeit Leicht:</b> Rezepte wiederholen sich nicht bis alle einmal gezogen wurden, mehr Thaler.</li>
      <li><b>Schwierigkeit Normal:</b> Zufällige Rezepte, normalviele Thaler, Hin und wieder Störung ohne Konsequenzen.</li>
      <li><b>Schwierigkeit Schwer:</b> Zufällige Rezepte, weniger Thaler, Störungen ziehen einem zufälligen Spieler Thaler ab.</li>


    </ol>

    <div class="start-actions">
      <button id="startBtn" type="button">Drücken zum Starten</button>
    </div>
  </div>
</div>

<div class="stage" id="machineStage">
  <div class="canvas" id="canvas">
    <svg width="0" height="0" aria-hidden="true">
      <defs>
        <clipPath id="winClip" clipPathUnits="userSpaceOnUse">
          <rect x="0" y="0" width="0" height="0" fill="none" />
          <rect x="300" y="340" width="270" height="270" />
          <rect x="640" y="340" width="270" height="270" />
          <rect x="980" y="340" width="270" height="270" />
          <rect x="1320" y="340" width="270" height="270" />
          <rect x="280" y="740" width="1360" height="200" />
        </clipPath>
      </defs>
    </svg>

    <div class="reels" id="reels">
      <div class="reel" id="reel-0"><div class="sweep"></div><div class="streak" hidden></div><div class="symbol"><img src="assets/img/rot.png" alt=""></div></div>
      <div class="reel" id="reel-1"><div class="sweep"></div><div class="streak" hidden></div><div class="symbol"><img src="assets/img/blau.png" alt=""></div></div>
      <div class="reel" id="reel-2"><div class="sweep"></div><div class="streak" hidden></div><div class="symbol"><img src="assets/img/gruen.png" alt=""></div></div>
      <div class="reel" id="reel-3"><div class="sweep"></div><div class="streak" hidden></div><div class="symbol"><img src="assets/img/gelb.png" alt=""></div></div>
    </div>

    <div class="result" id="gbaResult">
      <div class="result-inner">
  <div class="name" id="resName">Willkommen beim Güllebier-Rezept-O-Mat!</div>
  <div class="desc" id="resDesc">Gib im Scoreboard mindestens 2 Namen ein, wähle die Rundenanzahl, den Schwierigkeitsgrad und drücke Start.</div>
  <div class="points" id="resPts"></div>
</div>
    </div>

    <div class="global-sweep apply-clip" aria-hidden="true"><div class="global-sweep__stripe"></div></div>

    <div class="lever-area">
      <div id="lever" class="lever" role="button" aria-label="Hebel ziehen" tabindex="0">
        <div class="lever__back"></div>
        <div class="lever__slot"></div>
        <div class="lever__arm"></div>
        <div class="lever__knob"></div>
        <div class="lever__ring"></div>
      </div>
    </div>

    <div class="lamps-area">
      <div id="lampGold"  class="lamp lamp--gold"><span class="lamp__label">Legendär</span><div class="lamp__shine"></div></div>
      <div id="lampBlue"  class="lamp lamp--blue"><span class="lamp__label">Mittel</span><div class="lamp__shine"></div></div>
      <div id="lampGreen" class="lamp lamp--green"><span class="lamp__label">Normal</span><div class="lamp__shine"></div></div>
      <div id="lampRed"   class="lamp lamp--red"><span class="lamp__label">Einfach</span><div class="lamp__shine"></div></div>
    </div>

    <!-- Buttons im Canvas -->
    <button id="scoreboardBtn" class="ui-fixed-btn ui-lamp ui-lamp--gold" type="button">SCOREBOARD</button>

    <a id="exitBtn" class="ui-fixed-btn ui-lamp ui-lamp--gold" href="https://schlachtenbummler-verlag.jimdosite.com/neu/">BEENDEN</a>

    <img class="plate__img" src="assets/img/overlay.png" alt="Frontplatte">
  </div>
</div>

<div id="rotateOverlay">Bitte Querformat drehen<br><small>(Taste D: Debug-Outlines)</small></div>

<button id="dbgToggle" class="ui-fixed-btn ui-lamp ui-lamp--blue" type="button" style="position:fixed;left:auto;right:12px;top:auto;bottom:12px;z-index:2147483647;">🛠️ Debug</button>

<div id="dbgPanel" role="dialog" aria-label="Layout Debug">
  <header>
    <h4>Layout Debug (Design-Space 1920×1080)</h4>
    <div>
      <button class="lamp-button lamp-button--blue" id="dbgCopyCss">CSS kopieren</button>
      <button class="lamp-button lamp-button--blue" id="dbgSave">Speichern</button>
      <button class="lamp-button lamp-button--gold" id="dbgReset">Reset</button>
    </div>
  </header>

  <div class="grp">
    <div class="sw"><input type="checkbox" id="dbgOn"> <label for="dbgOn"><strong>Debug an (Outlines)</strong></label></div>
    <div class="sw"><input type="checkbox" id="dbgSoundOn"><label for="dbgSoundOn"><strong>Sound an</strong></label></div>
  </div>

  <div class="grp"><strong>Walzen-Fenster (px)</strong>
    <div class="row"><label>Top Y <input type="range" min="0" max="1080" step="1" data-var="--r-top"></label><input type="number" step="1" data-var="--r-top"></div>
    <div class="row"><label>W Breite <input type="range" min="50" max="600" step="1" data-var="--r-w"></label><input type="number" step="1" data-var="--r-w"></div>
    <div class="row"><label>H Höhe <input type="range" min="50" max="600" step="1" data-var="--r-h"></label><input type="number" step="1" data-var="--r-h"></div>
    <div class="row"><label>Reel 0 X <input type="range" min="0" max="1920" step="1" data-var="--r0-left"></label><input type="number" step="1" data-var="--r0-left"></div>
    <div class="row"><label>Reel 1 X <input type="range" min="0" max="1920" step="1" data-var="--r1-left"></label><input type="number" step="1" data-var="--r1-left"></div>
    <div class="row"><label>Reel 2 X <input type="range" min="0" max="1920" step="1" data-var="--r2-left"></label><input type="number" step="1" data-var="--r2-left"></div>
    <div class="row"><label>Reel 3 X <input type="range" min="0" max="1920" step="1" data-var="--r3-left"></label><input type="number" step="1" data-var="--r3-left"></div>
  </div>

  <div class="grp"><strong>Ergebnis (px)</strong>
    <div class="row"><label>Left X <input type="range" min="0" max="1920" step="1" data-var="--res-left"></label><input type="number" step="1" data-var="--res-left"></div>
    <div class="row"><label>Top Y <input type="range" min="0" max="1080" step="1" data-var="--res-top"></label><input type="number" step="1" data-var="--res-top"></div>
    <div class="row"><label>Breite <input type="range" min="100" max="1920" step="1" data-var="--res-w"></label><input type="number" step="1" data-var="--res-w"></div>
    <div class="row"><label>Höhe <input type="range" min="60" max="1080" step="1" data-var="--res-h"></label><input type="number" step="1" data-var="--res-h"></div>

    <div class="row"><label>Name Größe px <input type="range" min="10" max="64" step="1" data-var="--result-name-size"></label><input type="number" step="1" data-var="--result-name-size"></div>
    <div class="row"><label>Name Farbe <input type="color" data-var="--result-name-color"></label><input type="text" data-var="--result-name-color" placeholder="#ffffff oder rgba(...)"></div>

    <div class="row"><label>Beschreibung Größe px <input type="range" min="8" max="48" step="1" data-var="--result-desc-size"></label><input type="number" step="1" data-var="--result-desc-size"></div>
    <div class="row"><label>Beschreibung Farbe <input type="color" data-var="--result-desc-color"></label><input type="text" data-var="--result-desc-color" placeholder="#e8e8e8 oder rgba(...)"></div>

    <div class="row"><label>Punkte Größe px <input type="range" min="8" max="48" step="1" data-var="--result-points-size"></label><input type="number" step="1" data-var="--result-points-size"></div>
    <div class="row"><label>Punkte Farbe <input type="color" data-var="--result-points-color"></label><input type="text" data-var="--result-points-color" placeholder="#ffd24a oder rgba(...)"></div>
  </div>

  <div class="grp"><strong>Hebel & Lampen (px + Scale)</strong>
    <div class="row"><label>Hebel X <input type="range" min="0" max="1920" step="1" data-var="--lever-x"></label><input type="number" step="1" data-var="--lever-x"></div>
    <div class="row"><label>Hebel Y <input type="range" min="0" max="1080" step="1" data-var="--lever-y"></label><input type="number" step="1" data-var="--lever-y"></div>
    <div class="row"><label>Hebel Scale <input type="range" min="0.5" max="2" step="0.01" data-var="--lever-scale"></label><input type="number" step="0.01" data-var="--lever-scale"></div>

    <div class="row"><label>Lampen X <input type="range" min="0" max="1920" step="1" data-var="--lamps-x"></label><input type="number" step="1" data-var="--lamps-x"></div>
    <div class="row"><label>Lampen Y <input type="range" min="0" max="1080" step="1" data-var="--lamps-y"></label><input type="number" step="1" data-var="--lamps-y"></div>
    <div class="row"><label>Lampen Scale <input type="range" min="0.5" max="2" step="0.01" data-var="--lamps-scale"></label><input type="number" step="0.01" data-var="--lamps-scale"></div>
    <div class="row"><label>Lampen Abstand <input type="range" min="0" max="100" step="1" data-var="--lamps-gap"></label><input type="number" step="1" data-var="--lamps-gap"></div>
  </div>

  <div class="grp"><strong>Canvas-Buttons (Position)</strong>
    <div class="row"><label>Scoreboard X px <input type="range" min="0" max="1920" step="1" data-var="--sound-x"></label><input type="number" step="1" data-var="--sound-x"></div>
    <div class="row"><label>Scoreboard Y px <input type="range" min="0" max="1080" step="1" data-var="--sound-y"></label><input type="number" step="1" data-var="--sound-y"></div>
    <div class="row"><label>Exit X px <input type="range" min="0" max="1920" step="1" data-var="--exit-x"></label><input type="number" step="1" data-var="--exit-x"></div>
    <div class="row"><label>Exit Y px <input type="range" min="0" max="1080" step="1" data-var="--exit-y"></label><input type="number" step="1" data-var="--exit-y"></div>
  </div>

  <div class="grp"><strong>Scoreboard Buttons (Position)</strong>
<!-- Players -->
  <div class="row"><label>Players Left px  <input type="range" min="0" max="1920" step="1" data-var="--sb-players-left"></label><input type="number" step="1" data-var="--sb-players-left"></div>
  <div class="row"><label>Players Right px <input type="range" min="0" max="1920" step="1" data-var="--sb-players-right"></label><input type="number" step="1" data-var="--sb-players-right"></div>
  <div class="row"><label>Players Top px   <input type="range" min="0" max="1080" step="1" data-var="--sb-players-top"></label><input type="number" step="1" data-var="--sb-players-top"></div>
  <div class="row"><label>Players Scale    <input type="range" min="0.5" max="2" step="0.01" data-var="--sb-players-scale"></label><input type="number" step="0.01" data-var="--sb-players-scale"></div>

  <!-- Runde-Box -->
  <div class="row"><label>Runde Left px    <input type="range" min="0" max="1920" step="1" data-var="--sb-round-left"></label><input type="number" step="1" data-var="--sb-round-left"></div>
  <div class="row"><label>Runde Right px   <input type="range" min="0" max="1920" step="1" data-var="--sb-round-right"></label><input type="number" step="1" data-var="--sb-round-right"></div>
  <div class="row"><label>Runde Bottom px  <input type="range" min="0" max="1080" step="1" data-var="--sb-round-bottom"></label><input type="number" step="1" data-var="--sb-round-bottom"></div>
  <div class="row"><label>Runde Scale      <input type="range" min="0.5" max="2" step="0.01" data-var="--sb-round-scale"></label><input type="number" step="0.01" data-var="--sb-round-scale"></div>

  <!-- Controls -->
  <div class="row"><label>Controls Left px   <input type="range" min="0" max="1920" step="1" data-var="--sb-controls-left"></label><input type="number" step="1" data-var="--sb-controls-left"></div>
  <div class="row"><label>Controls Right px  <input type="range" min="0" max="1920" step="1" data-var="--sb-controls-right"></label><input type="number" step="1" data-var="--sb-controls-right"></div>
  <div class="row"><label>Controls Bottom px <input type="range" min="0" max="1080" step="1" data-var="--sb-controls-bottom"></label><input type="number" step="1" data-var="--sb-controls-bottom"></div>
  <div class="row"><label>Controls Scale     <input type="range" min="0.5" max="2" step="0.01" data-var="--sb-controls-scale"></label><input type="number" step="0.01" data-var="--sb-controls-scale"></div>

  <!-- Actions-Gruppe -->
  <div class="row"><label>Actions Translate X px <input type="range" min="-500" max="500" step="1" data-var="--sb-actions-translate-x"></label><input type="number" step="1" data-var="--sb-actions-translate-x"></div>
  <div class="row"><label>Actions Translate Y px <input type="range" min="-500" max="500" step="1" data-var="--sb-actions-translate-y"></label><input type="number" step="1" data-var="--sb-actions-translate-y"></div>
  <div class="row"><label>Actions Scale          <input type="range" min="0.5" max="2" step="0.01" data-var="--sb-actions-scale"></label><input type="number" step="0.01" data-var="--sb-actions-scale">
</div>
    <div class="row"><label>START X px <input type="range" min="0" max="1920" step="1" data-var="--sb-start-x"></label><input type="number" step="1" data-var="--sb-start-x"></div>
    <div class="row"><label>START Y px <input type="range" min="0" max="1080" step="1" data-var="--sb-start-y"></label><input type="number" step="1" data-var="--sb-start-y"></div>

    <div class="row"><label>SOUND X px <input type="range" min="0" max="1920" step="1" data-var="--sb-sound-x"></label><input type="number" step="1" data-var="--sb-sound-x"></div>
    <div class="row"><label>SOUND Y px <input type="range" min="0" max="1080" step="1" data-var="--sb-sound-y"></label><input type="number" step="1" data-var="--sb-sound-y"></div>

    <div class="row"><label>AUTOMATRON X px <input type="range" min="0" max="1920" step="1" data-var="--sb-auto-x"></label><input type="number" step="1" data-var="--sb-auto-x"></div>
    <div class="row"><label>AUTOMATRON Y px <input type="range" min="0" max="1080" step="1" data-var="--sb-auto-y"></label><input type="number" step="1" data-var="--sb-auto-y"></div>

    <div class="row"><label>RESET X px <input type="range" min="0" max="1920" step="1" data-var="--sb-reset-x"></label><input type="number" step="1" data-var="--sb-reset-x"></div>
    <div class="row"><label>RESET Y px <input type="range" min="0" max="1080" step="1" data-var="--sb-reset-y"></label><input type="number" step="1" data-var="--sb-reset-y"></div>
  </div>

  <div class="grp"><strong>Schimmer</strong>
    <div class="row"><label>Winkel ° <input type="range" min="0" max="180" step="1" data-var="--shine-angle"></label><input type="number" step="1" data-var="--shine-angle"></div>
    <div class="row"><label>Kern 0–.6 <input type="range" min="0" max="0.6" step="0.01" data-var="--shine-core"></label><input type="number" step="0.01" data-var="--shine-core"></div>
    <div class="row"><label>Speed s <input type="range" min="2" max="20" step="0.1" data-var="--shine-speed"></label><input type="number" step="0.1" data-var="--shine-speed"></div>
  </div>

  <div class="grp"><strong>Scanlines</strong>
    <div class="row"><label>Dicke px <input type="range" min="0.5" max="6" step="0.5" data-var="--scan-thickness"></label><input type="number" step="0.5" data-var="--scan-thickness"></div>
    <div class="row"><label>Abstand px <input type="range" min="0" max="12" step="0.5" data-var="--scan-spacing"></label><input type="number" step="0.5" data-var="--scan-spacing"></div>
    <div class="row"><label>Deckkraft <input type="range" min="0" max="1" step="0.01" data-var="--scan-opacity"></label><input type="number" step="0.01" data-var="--scan-opacity"></div>
    <div class="row"><label>Blend-Mode <input type="text" placeholder="overlay, soft-light..." data-var="--scan-blend"></label><div></div></div>

    <div class="row"><label>Winkel ° <input type="range" min="0" max="360" step="1" data-var="--scan-angle"></label><input type="number" step="1" data-var="--scan-angle"></div>
    <div class="row"><label>Hellfarbe <input type="color" data-var="--scan-bright"></label><input type="text" data-var="--scan-bright" placeholder="#ffffff oder rgba(...)"></div>
    <div class="row"><label>Dunkelfarbe <input type="color" data-var="--scan-dark"></label><input type="text" data-var="--scan-dark" placeholder="transparent oder rgba(...)"></div>
  </div>
</div>

<!-- ============ SCOREBOARD-BILDSCHIRM ============ -->
<div class="score-screen" id="scoreScreen">
  <div class="score-card">
    <!-- Hintergrund -->
    <img src="assets/img/score.png" class="plate__img score-bg" alt="">

    <!-- NEU: Overlay mit transparenten „Löchern“ -->
    <img src="assets/img/score_template.png" class="plate__img score-template" alt="">

    <!-- Players-Liste -->
    <div class="players" id="playersList">
      <!-- 5 Spielerzeilen -->
      <div class="row inactive" data-idx="0">
        <div class="name-wrap">
          <input class="name-input" id="pName0" maxlength="12" placeholder="Bitte Namen eingeben" />
          <button class="coin-badge" id="coin0">+0</button>
        </div>
        <div class="pill"><span id="pTitle0">Rübenhamster</span></div>
        <div class="thaler"><span id="pThaler0">0</span> Thaler</div>
      </div>
      <div class="row inactive" data-idx="1">
        <div class="name-wrap">
          <input class="name-input" id="pName1" maxlength="12" placeholder="Bitte Namen eingeben" />
          <button class="coin-badge" id="coin1">+0</button>
        </div>
        <div class="pill"><span id="pTitle1">Rübenhamster</span></div>
        <div class="thaler"><span id="pThaler1">0</span> Thaler</div>
      </div>
      <div class="row inactive" data-idx="2">
        <div class="name-wrap">
          <input class="name-input" id="pName2" maxlength="12" placeholder="Bitte Namen eingeben" />
          <button class="coin-badge" id="coin2">+0</button>
        </div>
        <div class="pill"><span id="pTitle2">Rübenhamster</span></div>
        <div class="thaler"><span id="pThaler2">0</span> Thaler</div>
      </div>
      <div class="row inactive" data-idx="3">
        <div class="name-wrap">
          <input class="name-input" id="pName3" maxlength="12" placeholder="Bitte Namen eingeben" />
          <button class="coin-badge" id="coin3">+0</button>
        </div>
        <div class="pill"><span id="pTitle3">Rübenhamster</span></div>
        <div class="thaler"><span id="pThaler3">0</span> Thaler</div>
      </div>
      <div class="row inactive" data-idx="4">
        <div class="name-wrap">
          <input class="name-input" id="pName4" maxlength="12" placeholder="Bitte Namen eingeben" />
          <button class="coin-badge" id="coin4">+0</button>
        </div>
        <div class="pill"><span id="pTitle4">Rübenhamster</span></div>
        <div class="thaler"><span id="pThaler4">0</span> Thaler</div>
      </div>
    </div>

    <div class="round-indicator" id="roundIndicator">Runde – / –</div>

    <div class="score-controls">
      <div class="rounds" id="roundsBox">
        <label class="lamp-button"><input type="radio" name="sbRounds" value="3"  checked> 3</label>
        <label class="lamp-button"><input type="radio" name="sbRounds" value="5"> 5</label>
        <label class="lamp-button"><input type="radio" name="sbRounds" value="10"> 10</label>
        <label class="lamp-button"><input type="radio" name="sbRounds" value="endless"> Endlos</label>
      </div>
      <div class="diff" id="diffBox">
        <label class="lamp-button"><input type="radio" name="sbDiff" value="leicht"> Leicht</label>
        <label class="lamp-button"><input type="radio" name="sbDiff" value="normal" checked> Normal</label>
        <label class="lamp-button"><input type="radio" name="sbDiff" value="schwer"> Schwer</label>
      </div>
    </div>

    <div class="score-actions" id="scoreActions">
      <button id="sbStartBtn" class="sb-btn lamp-button--blue" disabled>START</button>
      <button id="sbSoundToggle" class="sb-btn lamp-button--blue">SOUND</button>
      <button id="toMachineBtn" class="sb-btn lamp-button--gold">AUTOMATRON</button>
      <button id="sbResetBtn" class="sb-btn lamp-button--gold">RESET</button>
    </div>
  </div>
</div>

<script>
(function(){
  const $  = s => document.querySelector(s);
  const $$ = s => [...document.querySelectorAll(s)];

 // ===== Startscreen & Fullscreen =====
async function enterFullscreen(){
  const el = document.documentElement;
  try{
    if (!document.fullscreenElement) {
      if (el.requestFullscreen) await el.requestFullscreen({ navigationUI: "hide" });
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen(); // Safari
    }
  }catch(e){}
  // iPad/Safari braucht kurz, bis Maße stimmen → doppelt rAF
  requestAnimationFrame(()=> requestAnimationFrame(fit));
}

const startScreen = document.getElementById('startScreen');
const startBtn    = document.getElementById('startBtn');

// überall auf dem Startscreen darf FS angestoßen werden (User-Geste)
startScreen.addEventListener('pointerdown', async ()=>{
  if (startScreen.dataset.fsDone === '1') return; // doppelte Anfragen vermeiden
  startScreen.dataset.fsDone = '1';
  await enterFullscreen();
});

// Button blendet Screen aus und wechselt ins Spiel
startBtn.addEventListener('click', async ()=>{
  await enterFullscreen();
  startScreen.style.display = 'none';
  fit();
  AutomatronScreensaver.autowireIdle(); // Timer hier erneut scharf stellen (optional)
});


  /* ===== Fit (FIX: Variablen auf :root setzen, nicht nur auf #canvas) ===== */
  const canvas = $('#canvas');
  function fit(){
  const root  = document.documentElement;
  const stage = document.getElementById('machineStage');

  const cs = getComputedStyle(stage);
  const padX = (parseFloat(cs.paddingLeft)||0) + (parseFloat(cs.paddingRight)||0);
  const padY = (parseFloat(cs.paddingTop)||0)  + (parseFloat(cs.paddingBottom)||0);

  const rect   = stage.getBoundingClientRect();
  const availW = rect.width  - padX;
  const availH = rect.height - padY;

  const W = parseInt(getComputedStyle(root).getPropertyValue('--design-w')) || 1920;
  const H = parseInt(getComputedStyle(root).getPropertyValue('--design-h')) || 1080;

  const scale = Math.min(availW / W, availH / H);
  const tx = Math.round((availW - W*scale) / 2);
  const ty = Math.round((availH - H*scale) / 2);

  canvas.style.setProperty('--fit-scale', String(scale));
canvas.style.setProperty('--fit-x', `${tx}px`);
canvas.style.setProperty('--fit-y', `${ty}px`);

}


  addEventListener('resize', fit);
  addEventListener('orientationchange', fit);
  document.addEventListener('DOMContentLoaded', fit);
  // Fullscreen-Wechsel (Desktop + Safari)
document.addEventListener('fullscreenchange', fit);
document.addEventListener('webkitfullscreenchange', fit); // Safari/WebKit

// „Visueller Viewport“ (Tablets/iOS: Adressleiste/Notch ändert nutzbare Fläche)
if ('visualViewport' in window) {
  window.visualViewport.addEventListener('resize', fit);
  window.visualViewport.addEventListener('scroll', fit);
}

  function checkOrientation(){ $('#rotateOverlay').style.display = (innerHeight>innerWidth)?'flex':'none'; }
  addEventListener('resize',checkOrientation);
  addEventListener('orientationchange',checkOrientation);
  document.addEventListener('DOMContentLoaded',checkOrientation);

  addEventListener('keydown', (e)=>{
    if(e.key.toLowerCase()==='d'){
      document.body.classList.toggle('debug');
      const cb=$('#dbgOn'); if(cb) cb.checked=document.body.classList.contains('debug');
    }
  });

  /* Assets */
  const IMG = { rot:'assets/img/rot.png', blau:'assets/img/blau.png', gruen:'assets/img/gruen.png', gelb:'assets/img/gelb.png', stoer:'assets/img/stoer.png' };
  const COLORS_ALL = Object.keys(IMG);
  const COLORS_NO_STOER = COLORS_ALL.filter(c=>c!=='stoer');

  /* Sounds */
  const audio = {
    lever:   new Audio('assets/snd/lever.mp3'),
    dreh:    new Audio('assets/snd/dreh.mp3'),
    anhalten:new Audio('assets/snd/anhalten.mp3'),
    ergebnis:new Audio('assets/snd/ergebnis.mp3'),
    lvlup:   new Audio('assets/snd/lvlup.mp3'),
    fanfare: new Audio('assets/snd/fanfare.mp3'),
    stoer:   new Audio('assets/snd/stoer.mp3'),
    click:   new Audio('assets/snd/click.mp3'),
    kaching: new Audio('assets/snd/kaching.mp3'),
    get enabled(){ return getVar('--sound-enabled')==='1'; }
  };
  audio.dreh.loop = true;
  function safePlay(a){ if(!audio.enabled) return; try{ a.currentTime=0; a.play(); }catch{} }
  function safeStop(a){ try{ a.pause(); a.currentTime=0; }catch{} }

  // Globale Click-Sounds (keine Coins)
  document.addEventListener('click', (e)=>{
    const el = e.target.closest('button, a');
    if(!el) return;
    if(el.classList.contains('coin-badge')) return;
    safePlay(audio.click);
  });
// === Klick-Sound für Runden- & Schwierigkeits-Schalter ===
// genau HIER einfügen – NACH dem globalen Click-Sound-Block
['roundsBox','diffBox'].forEach(id=>{
  const box = document.getElementById(id);
  if(!box) return;
  // "change" feuert nur, wenn wirklich umgeschaltet wurde (kein Doppelsound)
  box.addEventListener('change', (e)=>{
    if (e.target && e.target.matches('input[type="radio"]')) {
      safePlay(audio.click);
    }
  });
});

  /* UI Buttons */
  const exitBtn = $('#exitBtn');
  exitBtn.addEventListener('mousedown', ()=>{
    exitBtn.classList.add('active','glow');
    setTimeout(()=> exitBtn.classList.remove('active','glow'), 800);
  });

  /* Reels & Lamps */
  const reelsWrap = $('#reels');
  const reels = $$('#reels .reel');
  const nameEl = $('#resName'), descEl = $('#resDesc'), ptsEl = $('#resPts');
  function setSymbol(reelEl, color){ const imgEl = reelEl.querySelector('img'); if(imgEl){ imgEl.src = IMG[color]; imgEl.alt = color; } }
  const rndFrom = arr => arr[(Math.random()*arr.length)|0];
  const rndAll = () => rndFrom(COLORS_ALL);
  const rndNoStoer = () => rndFrom(COLORS_NO_STOER);
  reels.forEach(r=> setSymbol(r, rndNoStoer()));

  const lamps = { gold:$('#lampGold'), blue:$('#lampBlue'), green:$('#lampGreen'), red:$('#lampRed') };

  function getVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
  function setVar(n, v){
    const root=document.documentElement;
    if(n==='--shine-angle' || n==='--scan-angle') root.style.setProperty(n, parseFloat(v)+'deg');
    else if(/--(shine-speed|lamp-afterglow)$/.test(n)) root.style.setProperty(n, parseFloat(v)+'s');
    else if(n.startsWith('--ui-btn-') || n==='--ui-opacity') root.style.setProperty(n, String(v));
    else root.style.setProperty(n, v);
  }

  /* Lampen */
  const lampTimers = new WeakMap();
  function clearLampTimers(){ Object.values(lamps).forEach(n=>{ const t = lampTimers.get(n); if(t){ clearTimeout(t); lampTimers.delete(n); } n.classList.remove('active','glow'); }); }
  function flashLamp(el){
    clearLampTimers();
    el.classList.add('active','glow');
    const sec = parseFloat(getVar('--lamp-afterglow')) || 4.2;
    const t = setTimeout(()=>{ el.classList.remove('active','glow'); lampTimers.delete(el); }, sec*1000);
    lampTimers.set(el, t);
  }
  function setLampsByScore(score){
    if(score >= 13)      flashLamp(lamps.gold);
    else if(score >= 10) flashLamp(lamps.blue);
    else if(score >= 6)  flashLamp(lamps.green);
    else                 flashLamp(lamps.red);
  }
  function allLampsOff(){ Object.values(lamps).forEach(l=> l.classList.remove('active','glow')); }
  function chaosLamps(ms = 1200){
    clearLampTimers();
    const els = Object.values(lamps);
    const int = setInterval(()=>{
      els.forEach(l => l.classList.remove('active','glow'));
      const count = 1 + (Math.random()*3|0);
      for(let i=0;i<count;i++){
        const el = els[Math.random()*els.length|0];
        el.classList.add('active');
      }
    }, 120);
    setTimeout(()=>{ clearInterval(int); allLampsOff(); }, ms + 80);
  }

 /* Rezepte */
  const RECIPES = {
    'rot,rot,rot,rot':{name:'Dösselheimer Güllebier',pts:15,desc:'Die braune Seele Saxoniens.'},
    'blau,blau,blau,blau':{name:'Leberknebel - Export',pts:15,desc:'Seitenstechen auch ohne Meuchelmörder.'},
    'gruen,gruen,gruen,gruen':{name:'Braune Soße - Spezial',pts:14,desc:'Zähflüssig, herzhaft, löst Sorgen und Rost.'},
    'gelb,gelb,gelb,gelb':{name:'Flotter Otto - Extra Hell',pts:14,desc:'Fließt es erst heraus, bleibst du lieber gleich zuhaus!'},
    'rot,rot,rot,blau':{name:'Klemritzer Nierenquetscher',pts:13,desc:'Massiert die Organe von innen nach außen.'},
    'rot,rot,rot,gruen':{name:'Rülpsheimer Starkbier',pts:13,desc:'Schenkt Bass im Bauch.'},
    'rot,rot,rot,gelb':{name:'Lord Villains Glanzparade',pts:13,desc:'Edel und unbestechlich herb.'},
    'blau,blau,blau,rot':{name:'Donnerburger Steißtritt',pts:13,desc:'Treffsicher im Geschmack.'},
    'blau,blau,blau,gruen':{name:'Hassnitzer Kellerbräu',pts:13,desc:'Aus dem ganz dunklen Fass.'},
    'blau,blau,blau,gelb':{name:'Stinkhornsuppe - Spezial',pts:13,desc:'Duftet nach Abenteuer, Freiheit und alten Socken.'},
    'gruen,gruen,gruen,rot':{name:'Plärrener Humpentrunk',pts:13,desc:'Groß im Glas, laut im Kopf.'},
    'gruen,gruen,gruen,blau':{name:'Hassburger Urstoff Brühe',pts:13,desc:'So bekömmlich wie eine kleine Pilzvergiftung.'},
    'gruen,gruen,gruen,gelb':{name:'Dreschmarer Magenhieb',pts:12,desc:'Direkt, ehrlich, unvergesslich.'},
    'gelb,gelb,gelb,rot':{name:'Knurrwitzer Abtritt',pts:12,desc:'So männlich wie konservative Ein-Artikler.'},
    'gelb,gelb,gelb,blau':{name:'Ynnors Schnarchtrunk',pts:12,desc:'Wirkt sofort.'},
    'gelb,gelb,gelb,gruen':{name:'Schwitzwasser Abblende',pts:12,desc:'Leicht bekömmliches Dünnbier.'},
    'rot,rot,blau,blau':{name:'Beißburger Rübenhamster',pts:11,desc:'Zwei Paare, ein Ziel.'},
    'rot,rot,gruen,gruen':{name:'Ningelner Nostalgiker - Urtyp',pts:11,desc:'Schmeckt so gut wie früher, nur besser.'},
    'rot,rot,gelb,gelb':{name:'Stockheimer Knollentrunk',pts:10,desc:'Dick im Glas, jetzt mit noch mehr Fruchtfleisch.'},
    'blau,blau,gruen,gruen':{name:'Plärrener Feldschorle - Spezial',pts:10,desc:'Damit sie auch morgen noch lauthals schreien können.'},
    'blau,blau,gelb,gelb':{name:'Grollstädter Rübensprudel - Deluxe',pts:9,desc:'Gebraut mit Liebe.'},
    'gruen,gruen,gelb,gelb':{name:'Grimmiger Nackenschlag - Extra Herb',pts:9,desc:'Haut rein!'},
    'rot,rot,blau,gruen':{name:'Kellerleichen - Party - Mix',pts:8,desc:'Für Nächte an die man sich lieber nicht erinnert.'},
    'rot,rot,blau,gelb':{name:'Broilinger Doppelacker Sud',pts:7,desc:'Das beste aus zwei Welten.'},
    'rot,rot,gruen,gelb':{name:'Feierabend Erntetrunk',pts:7,desc:'Erfrischend wie eine 16 Stundenschicht bei Schnell & Billig.'},
    'blau,blau,rot,gruen':{name:'Zwicker Feldweg - Knöchelknacks',pts:6,desc:'Holprig und bitter.'},
    'blau,blau,rot,gelb':{name:'Ackerbowle',pts:6,desc:'Erdig-Herb'},
    'blau,blau,gruen,gelb':{name:'Lumpa Umpas goldene Brause - Edel',pts:6,desc:'Kurz aber kräftig.'},
    'gruen,gruen,rot,blau':{name:'Freudloser Hopfenrübling - Hell',pts:5,desc:'Der Spaß aus dem Glas.'},
    'gruen,gruen,rot,gelb':{name:'Ackerschorle - Export',pts:5,desc:'Das Erfrischungsgetränk für jede Arbeit.'},
    'gruen,gruen,blau,gelb':{name:'Winkelstädter Gärtnerpils',pts:5,desc:'Gereift im Biercubus.'},
    'gelb,gelb,rot,blau':{name:'Lästerhainer Jodelsprudel',pts:4,desc:'Nach zwei Schlucken singst du.'},
    'gelb,gelb,rot,gruen':{name:'Donnerburger Rübenschädel - Spezial',pts:4,desc:'Gebraut mit Blitz und Donner.'},
    'gelb,gelb,blau,gruen':{name:'Karnickelfangschlag',pts:4,desc:'Erst pelzig auf der Zunge, dann schnell im Abgang.'},
    'rot,blau,gruen,gelb':{name:'Querbeet - Klassik',pts:3,desc:'Von allem ein bisschen.'}
  };

  const keyOf = arr => arr.slice().sort().join(',');
  const RECIPE_KEYS = Object.keys(RECIPES);
  const RECIPES_INDEX = {}; Object.keys(RECIPES).forEach(k => { RECIPES_INDEX[keyOf(k.split(','))] = RECIPES[k]; });
  function getRecipeFromColors(colorsArr){ return RECIPES_INDEX[keyOf(colorsArr)] }
  // Merkt sich stets den letzten "Rezept"-Text fürs Zurückschalten
const lastResult = { name:'', desc:'', pts:'' };
function setResult(name='', desc='', pts=''){
  lastResult.name = name;
  lastResult.desc = desc;
  lastResult.pts  = pts;
  nameEl.textContent = name;
  descEl.textContent = desc;
  ptsEl.textContent  = pts;
}


  /* ===== Hebel, Vibration, Shake ===== */
  const lever = $('#lever');
  const knob  = lever.querySelector('.lever__knob');
  const ring  = lever.querySelector('.lever__ring');
  const slot  = lever.querySelector('.lever__slot');
  let dragging=false, startY=0, startVal=0, maxY=200, lastY=0, lastT=0, maxSpeedDown=0;

  function measure(){
    const leverH = lever.offsetHeight || 300;
    const knobH  = knob.offsetHeight  || 56;
    const slotTop = slot.offsetTop;
    const slotBottom = slotTop + slot.offsetHeight;
    const bc = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--lever-bottom-clearance')) || 6;
    const ringOffset = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--lever-ring-offset')) || 52;
    const ringH = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--lever-ring-h')) || 8;
    const maxByKnob = (leverH - knobH - bc);
    const maxByRing = (slotBottom - (ringOffset + ringH) - bc);
    maxY = Math.max(0, Math.min(maxByKnob, maxByRing));
  }
  measure();
  addEventListener('resize', measure);

  let vibTimer=null, holdStart=0;
  const canVibrate = () => 'vibrate' in navigator;
  function startVibrationHold(){
    if(!canVibrate()) return;
    holdStart = Date.now();
    try{ navigator.vibrate(10); }catch{}
    clearInterval(vibTimer);
    vibTimer = setInterval(()=>{ try{ navigator.vibrate(8); }catch{} }, 90);
  }
  function stopVibrationHold(){
    if(!canVibrate()) return;
    clearInterval(vibTimer); vibTimer=null;
    try{ navigator.vibrate(0); }catch{}
  }
  function burstVibration(){
    if(!canVibrate()) return;
    const held = Date.now()-holdStart;
    try{ if(held>200) navigator.vibrate([0,18,30,18]); else navigator.vibrate(15); }catch{}
  }

  function setKnob(y, withTransition){
    const clamped = Math.max(0, Math.min(maxY, y));
    const ringOffset = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--lever-ring-offset')) || 52;
    if(!withTransition){ knob.style.transition='none'; ring.style.transition='none'; }
    knob.style.setProperty('--y', clamped+'px');
    ring.style.transform = `translate(-50%, ${clamped + ringOffset}px)`;
    if(!withTransition){ void knob.offsetHeight; knob.style.transition=''; ring.style.transition=''; }
    return clamped;
  }

  const clamp = (v, min=0, max=1) => Math.max(min, Math.min(max, v));
  const lerp  = (a,b,t) => a + (b-a)*t;
  function computeShakeIntensity({holdMs, maxSpeedDown, depth}){
    const holdNorm  = clamp((holdMs - 120) / 900);
    const speedNorm = clamp((maxSpeedDown - 0.25) / 1.25);
    const depthNorm = clamp((depth - 0.80) / 0.20);
    return clamp(0.55*speedNorm + 0.35*holdNorm + 0.10*depthNorm, 0.10, 1);
  }
  function triggerShake(intensity=1){
    intensity = clamp(intensity, 0, 1);
    const sign    = Math.random()<0.5 ? -1 : 1;
    const magPx   = lerp(2, 10, intensity).toFixed(2) + 'px';
    const rmagDeg = lerp(0.08, 0.45, intensity).toFixed(3) + 'deg';
    canvas.style.setProperty('--shake-sign', String(sign));
    canvas.style.setProperty('--shake-mag', magPx);
    canvas.style.setProperty('--shake-rot-mag', rmagDeg);
    canvas.classList.add('shake');
    setTimeout(()=> canvas.classList.remove('shake'), 360);
  }

  function onDown(e){
    if(!gameReady || leverLocked){ e.preventDefault(); return; }
    measure();
    dragging=true;
    startY=('touches' in e ? e.touches[0].clientY : e.clientY);
    lastY = startY;
    lastT = performance.now();
    maxSpeedDown = 0;
    const cur=parseFloat(getComputedStyle(knob).getPropertyValue('--y'))||0;
    startVal=cur; setKnob(cur,false);
    safePlay(audio.lever);
    startVibrationHold();
    e.preventDefault();
  }
  function onMove(e){
    if(!dragging) return;
    const y = ('touches' in e ? e.touches[0].clientY : e.clientY);
    const now = performance.now();
    const dY  = y - lastY;
    const dt  = now - lastT || 1;
    if(dY > 0){ const v = dY / dt; if(v > maxSpeedDown) maxSpeedDown = v; }
    lastY = y; lastT = now;
    const dyFromStart = y - startY;
    setKnob(startVal + dyFromStart, false);
    e.preventDefault();
  }
  function onUp(){
    if(!dragging) return; dragging=false;
    stopVibrationHold(); burstVibration();
    const cur = parseFloat(getComputedStyle(knob).getPropertyValue('--y'))||0;
    const ratio = cur/(maxY||1);
    const holdMs = Date.now() - holdStart;
    const intensity = computeShakeIntensity({holdMs, maxSpeedDown, depth: ratio});
    setKnob(0,true);
    if(ratio>=0.8) spin(intensity);
  }

  lever.addEventListener('mousedown',onDown);
  addEventListener('mousemove',onMove);
  addEventListener('mouseup',onUp);
  lever.addEventListener('touchstart',onDown,{passive:false});
  addEventListener('touchmove',onMove,{passive:false});
  addEventListener('touchend',onUp);
  lever.addEventListener('keydown',e=>{
    if(e.key===' '||e.key==='Enter'){
      if(!gameReady || leverLocked){ e.preventDefault(); return; }
      e.preventDefault();
      setKnob(maxY,true);
      setTimeout(()=>{ setKnob(0,true); spin(0.8); },180);
    }
  });

  /* ===== SCOREBOARD Logik ===== */
  const scoreScreen   = $('#scoreScreen');
  const machineStage  = $('#machineStage');
  const sbStartBtn    = $('#sbStartBtn');
  const sbSoundToggle = $('#sbSoundToggle');
  const toMachineBtn  = $('#toMachineBtn');
  const sbResetBtn    = $('#sbResetBtn');
  const scoreboardBtn = $('#scoreboardBtn');
  const roundIndicator= $('#roundIndicator');

  scoreboardBtn.addEventListener('click', ()=>{
  scoreboardBtn.classList.remove('active','glow'); // beim Klick aus
  navigateToScore();
});


  const players = Array.from({length:5}, (_,i)=>({ id:i, name:'', thaler:0, active:false }));
  const TITLES = [
  {min: 0,   name:'Lvl.0 Rübenhamster'},
  {min: 20,  name:'Lvl.1 Rübenzähler'},
  {min: 50,  name:'Lvl.2 Rübenschnitzer'},
  {min: 90,  name:'Lvl.3 Rübenknecht'},
  {min: 150, name:'Lvl.4 Rübenbauer'},
  {min: 210, name:'Lvl.5 Rübenmeister'},
  {min: 280, name:'Lvl.6 Rübenmagnat'},
  {min: 370, name:'Lvl.7 Rübenfürst'},
  {min: 470, name:'Lvl.8 Rübenkaiser'},
  {min: 700, name:'Lvl.9 Güllebier-Legende'}
];
function nextRoundLabel(){
  const cur = roundsPlayed + 1;                           // aktuelle (nächste) Runde
  return (roundsTotal === Infinity) ? `Runde ${cur}`      // Endlos: nur X
                                    : `Runde ${cur} / ${roundsTotal}`; // sonst: X / Y
}

  function titleFor(thaler){
    let t = TITLES[0].name;
    for(const tier of TITLES){ if(thaler>=tier.min) t=tier.name; else break; }
    return t;
  }
  function refreshPlayerUI(i){
    $('#pThaler'+i).textContent = players[i].thaler;
    $('#pTitle'+i).textContent  = titleFor(players[i].thaler);
    const row = $('[data-idx="'+i+'"]');
    row.classList.toggle('inactive', !players[i].active);
  }
// Gewinner/Leader so aufbereiten, dass oben NUR der Name steht
function getLeaderInfo(){
  const active = players.filter(p => p.active);
  if (!active.length) return null;

  const max = Math.max(...active.map(p => p.thaler));
  if (max <= 0) return null;

  const leaders = active.filter(p => p.thaler === max);
  const names = leaders.map(p => p.name || ('Spieler/in ' + (p.id + 1)));
  const title = titleFor(max);
  const wort = (max === 1) ? 'Thaler' : 'Thalern';

  if (leaders.length === 1){
    return {
      textName: names[0],                  // ⬅️ OBEN nur der Name
      textDesc: `${title}`,                // ⬅️ Mitte: Titel/Rang
      textPts:  `führt mit ${max} ${wort}` // ⬅️ Unten: Punktezeile
    };
  } else {
    const nameStr = names.slice(0,-1).join(', ') + ' & ' + names.slice(-1);
    return {
      textName: 'Gleichstand',
      textDesc: `${title}`,
      textPts:  `${nameStr} (je ${max} ${wort})`
    };
  }
}

  function activeCount(){ return players.filter(p=>p.active).length; }
  function updateStartEnabled(){ sbStartBtn.disabled = activeCount() < 2; }

  // NEU: Großbuchstaben nach Wortanfang, Leerzeichen oder Bindestrich
const capName = (s) =>
  (s || '').replace(/(^|[\s-])(\p{L})/gu, (_m, p1, p2) => p1 + p2.toUpperCase());

  for(let i=0;i<5;i++){
    const inp = $('#pName'+i);
    inp.addEventListener('input', ()=>{
  inp.value = capName(inp.value);                // ← vorher capWords
  players[i].name = (inp.value || '').trim();
  players[i].active = players[i].name.length>0;
  refreshPlayerUI(i);
  updateStartEnabled();
});

inp.addEventListener('blur', ()=>{
  inp.value = capName(inp.value);                // ← vorher capWords
  players[i].name = (inp.value || '').trim();
  players[i].active = players[i].name.length>0;
  refreshPlayerUI(i);
  updateStartEnabled();
});

  }
  updateStartEnabled();

  function navigateToScore(){
  scoreScreen.style.display='block';
  machineStage.style.display='none';
  stopTicker(); // Ticker pausieren
}

function navigateToMachine(){
  scoreScreen.style.display='none';
  machineStage.style.display='grid';
  fit();
 
  if (!isGameOver && hasAnyPoints()) startTicker();   // ⬅️ NEU
  else stopTicker();              // ⬅️ sicherheitshalber stoppen
}


  function syncSbSoundBtn(){
    const on = getVar('--sound-enabled')==='1';
    sbSoundToggle.textContent = on ? '🔊 SOUND' : '🔇 SOUND';
    sbSoundToggle.classList.toggle('active', !on);
  }
  sbSoundToggle.addEventListener('click', ()=>{
    const on = getVar('--sound-enabled')==='1';
    setVar('--sound-enabled', on ? '0' : '1');
    if(on) safeStop(audio.dreh);
    syncSbSoundBtn();
    const dbg = $('#dbgSoundOn'); if(dbg) dbg.checked = !on;
  });
  syncSbSoundBtn();

  let gameReady = false;
let leverLocked = false;
let roundsPlayed = 0;
let roundsTotal  = 0;
let difficulty   = 'normal';
let unusedRecipeKeys = [];
let isGameOver  = false; // ⬅️ NEU
let roundAdvancePending = false; // ⬅️ NEU: Runde erst beim nächsten Hebelzug erhöhen


  function getRoundsSetting(){
    const sel = document.querySelector('input[name="sbRounds"]:checked');
    const v = sel ? sel.value : '3';
    return (v==='endless') ? Infinity : parseInt(v,10)||3;
  }
  function getDifficulty(){
    const sel = document.querySelector('input[name="sbDiff"]:checked');
    return sel ? sel.value : 'normal';
  }
  function updateRoundIndicator(){
    const total = (roundsTotal===Infinity) ? '∞' : String(roundsTotal);
    const cur   = (roundsTotal===Infinity) ? String(roundsPlayed+1) : String(Math.min(roundsPlayed+1, roundsTotal));
    roundIndicator.textContent = `Runde ${cur} / ${total}`;
  }
  function setEditingDisabled(disabled){
    for(let i=0;i<5;i++){ $('#pName'+i).disabled = disabled; }
    document.querySelectorAll('input[name="sbRounds"]').forEach(r=> r.disabled = disabled);
    document.querySelectorAll('input[name="sbDiff"]').forEach(r=> r.disabled = disabled);
  }

  let pendingPayout = null;
  function showCoinBadges(amount){
    pendingPayout = {amount};
    for(let i=0;i<5;i++){
      const btn = $('#coin'+i);
      const isActive = players[i].active;
      btn.textContent = `+${amount}`;
      btn.classList.toggle('show', isActive);
      btn.disabled = !isActive;
    }
  }
  function hideCoinBadges(){
    pendingPayout = null;
    for(let i=0;i<5;i++){ $('#coin'+i).classList.remove('show'); }
  }
  function awardTo(i){
  if(!pendingPayout) return;

  const add = pendingPayout.amount;
  const prevTitle = titleFor(players[i].thaler);

  players[i].thaler += add;
  refreshPlayerUI(i);
  hideCoinBadges();
  safePlay(audio.kaching);

  toMachineBtn.classList.add('active','glow');

  const newTitle = titleFor(players[i].thaler);
  if(newTitle !== prevTitle) safePlay(audio.lvlup);

  leverLocked = false;

  // Rundenfortschritt steuern
  const nextRound = roundsPlayed + 1;
  if (roundsTotal !== Infinity && nextRound >= roundsTotal) {
    roundAdvancePending = false;   // sofort beenden
    advanceRound();
  } else {
    roundAdvancePending = true;    // erst beim nächsten Hebelzug erhöhen
  }
}

// Coin-Badges EINMALIG registrieren (nicht in awardTo!)
for (let idx=0; idx<5; idx++){
  document.getElementById('coin'+idx)
    .addEventListener('click', ()=> awardTo(idx));
}

// Top-level, von überall aufrufbar:
function advanceRound(){
  roundsPlayed++;
  updateRoundIndicator();

  // Spiel zu Ende?
  if (roundsTotal !== Infinity && roundsPlayed >= roundsTotal){
    gameReady = false;
    isGameOver = true;
    stopTicker();

    const active = players.filter(p => p.active);
    if (active.length){
      const maxThaler = Math.max(...active.map(p => p.thaler));
      const winners   = active.filter(p => p.thaler === maxThaler);
      const names     = winners.map(p => p.name || ('Spieler/in ' + (p.id+1)));
      const title     = titleFor(maxThaler);

      const nameStr = (winners.length === 1)
        ? names[0]
        : names.slice(0, -1).join(', ') + ' & ' + names.slice(-1);

      const verb = (winners.length === 1) ? 'gewinnt' : 'gewinnen';

      setResult(
        `${nameStr} ${verb} als ${title}`,
        winners.length === 1 ? `mit ${maxThaler} Thaler`
                             : `mit je ${maxThaler} Thaler`,
        `Starte eine neue Runde im Scoreboard`
      );
    } else {
      setResult('Keine aktiven Spieler', '', '');
    }
    return;
  }
}



  sbStartBtn.addEventListener('click', ()=>{
    
// Falls das vorherige Spiel beendet war: Thaler zurücksetzen
const wasGameOver = (roundsTotal !== Infinity) && (roundsTotal > 0) && (roundsPlayed >= roundsTotal);
if (wasGameOver){
  players.forEach((p,i)=>{ p.thaler = 0; refreshPlayerUI(i); });
}
isGameOver = false;   // <-- NEU
  stopTicker();         // <-- NEU

    if(activeCount()<2) return;
    roundsPlayed = 0;
    roundsTotal  = getRoundsSetting();
    difficulty   = getDifficulty();
    updateRoundIndicator();
    gameReady = true;
    leverLocked = false;
    sbStartBtn.disabled = true;
    setEditingDisabled(true);
    if(difficulty==='leicht'){ unusedRecipeKeys = RECIPE_KEYS.slice(); shuffle(unusedRecipeKeys); }
    navigateToMachine();
    setResult('Bereit!','Ziehe den Hebel für einen Ernteauftrag.','');
    toMachineBtn.classList.remove('active','glow');
    scoreboardBtn.classList.remove('active','glow');
  });

 // NEU:
toMachineBtn.addEventListener('click', ()=>{
  const gameOver = (roundsTotal !== Infinity) && (roundsPlayed >= roundsTotal);
  if (gameOver) setEditingDisabled(false); // Eingabe erst nach letzter Runde wieder erlauben
  toMachineBtn.classList.remove('active','glow');
  navigateToMachine();
});


  sbResetBtn.addEventListener('click', ()=>{
    players.forEach(p=>{ p.name=''; p.thaler=0; p.active=false; });
    for(let i=0;i<5;i++){ const inp=$('#pName'+i); inp.value=''; refreshPlayerUI(i); }
    (document.querySelector('input[name="sbRounds"][value="3"]')||{}).checked = true;
    (document.querySelector('input[name="sbDiff"][value="normal"]')||{}).checked = true;
    gameReady = false; leverLocked=false; roundsPlayed=0; roundsTotal=0;
    hideCoinBadges(); setEditingDisabled(false);
    sbStartBtn.disabled = true;
    setResult('Zurückgesetzt','Öffne Scoreboard, gib mind. 2 Namen ein und drücke START.','');
    allLampsOff(); safeStop(audio.dreh);
    updateStartEnabled(); roundIndicator.textContent='Runde – / –';
    toMachineBtn.classList.remove('active','glow');
    scoreboardBtn.classList.remove('active','glow');

});

  /* ===== Spin-Logik mit Difficulty ===== */
  let spinning=false; let timers=[]; let intervals=[];
  /* ===== Ergebnis-Ticker (Rezept <-> Führung) ===== */
let tickerTimer = null;
let showTickerNext = false; // false = Rezept anzeigen, true = Führung anzeigen

function hasAnyPoints(){
  return players.some(p => p.active && p.thaler > 0);
}

function tickDisplay(){
  if (isGameOver) return;                             // schon drin?
  if (!hasAnyPoints()) return;                        // ⬅️ NEU
  if (reelsWrap.classList.contains('spinning')) return;

  showTickerNext = !showTickerNext;
  const L = getLeaderInfo();

  if(showTickerNext && L){
    nameEl.textContent = L.textName;
    descEl.textContent = L.textDesc;
    ptsEl.textContent  = L.textPts;
  }else{
    nameEl.textContent = lastResult.name;
    descEl.textContent = lastResult.desc;
    ptsEl.textContent  = lastResult.pts;
  }
}
function startTicker(){
  if (isGameOver || !hasAnyPoints()){ stopTicker(); return; } // ⬅️ NEU
  if (tickerTimer) return;
  tickerTimer = setInterval(tickDisplay, 3500);
}
function stopTicker(){  clearInterval(tickerTimer); tickerTimer = null; }

  function clearTimers(){ intervals.forEach(i=>clearInterval(i)); intervals=[]; timers.forEach(t=>clearTimeout(t)); timers=[]; }
  const shuffle = arr => { for(let i=arr.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; };

  function getStoerChance(){
    if(difficulty==='leicht') return 40;
    if(difficulty==='schwer') return 5;
    return 20;
  }
  function adjustPts(base){
    if(difficulty==='leicht') return Math.max(1, base+2);
    if(difficulty==='schwer') return Math.max(1, base-2);
    return base;
  }

  function spin(intensity=0.75){
  // ⬅️ NEU: Falls die vorige Runde „ausgezahlt“ wurde,
  //         jetzt (beim Hebelzug) den Rundenzähler erhöhen
  if (roundAdvancePending){
    roundAdvancePending = false;
    advanceRound();
    // Wenn das Spiel dadurch beendet wurde, GAR NICHT mehr spinnen
    if (!gameReady || isGameOver) return;
  }

  if(spinning) return;  spinning=true;
    triggerShake(intensity);

    setResult(`…${nextRoundLabel()}… suche Rezept…`, '', '');
    showTickerNext = false; // beim Suchen zuerst den Rezept-Text anzeigen

    reelsWrap.classList.add('spinning');
    safePlay(audio.dreh);

    const STOER_CHANCE = getStoerChance();
    const willForceStoerStop = ((Math.random()*STOER_CHANCE)|0)===0;

    let plannedColors = null;
    let plannedRecipe = null;

    if(!willForceStoerStop && difficulty==='leicht'){
      if(unusedRecipeKeys.length===0){ unusedRecipeKeys = RECIPE_KEYS.slice(); shuffle(unusedRecipeKeys); }
      const key = unusedRecipeKeys.pop();
      plannedRecipe = RECIPES[key];
      plannedColors = shuffle(key.split(',').slice());
    }

    reels.forEach((r,i)=>{
      r.classList.add('spinning');
      r.querySelector('.streak').hidden=false;
      const intId = setInterval(()=> setSymbol(r, rndAll()), 92);
      intervals.push(intId);
    });

    const stopBase=[1100,1750,2400,3050];
    let finalColors = [];

    reels.forEach((r,i)=>{
      const to=setTimeout(()=>{
        clearInterval(intervals[i]);

        let finalColor;
        if(willForceStoerStop){
          finalColor = 'stoer';
        }else if(plannedColors){
          finalColor = plannedColors[i % plannedColors.length];
        }else{
          finalColor = rndNoStoer();
        }

        setSymbol(r, finalColor);
        finalColors[i]=finalColor;

        r.classList.remove('spinning'); r.classList.add('stop-bounce');
        r.querySelector('.streak').hidden=true;
        safePlay(audio.anhalten);
        r.addEventListener('animationend',()=> r.classList.remove('stop-bounce'),{once:true});

        if(i===reels.length-1){
          reelsWrap.classList.remove('spinning');
          safeStop(audio.dreh);

         if (finalColors.every(c => c === 'stoer')) {
  chaosLamps(1400);

  if (difficulty === 'schwer' && activeCount() > 0) {
    const actIdx   = players.map((p,idx)=>p.active?idx:null).filter(v=>v!==null);
    const unlucky  = actIdx[(Math.random()*actIdx.length)|0];
    const penalty  = 3;
    players[unlucky].thaler = Math.max(0, players[unlucky].thaler - penalty);
    refreshPlayerUI(unlucky);
    setResult('❌ Maschine hat eine Störung!','',
      `${players[unlucky].name || (''+(unlucky+1))} werden ${penalty} Thaler abgezogen. Ziehe den Hebel zum Neustart.`);
  } else {
    setResult('❌ Maschine hat eine Störung!','Ziehe den Hebel zum Neustart.','');
  }

  safePlay(audio.stoer);
  try { if ('vibrate' in navigator) navigator.vibrate([0,40,40,40]); } catch {}

  // 🔧 WICHTIG: für erneuten Zug freischalten
  leverLocked = false;   // Hebel wieder frei
  spinning    = false;   // interner Spin-Guard zurücksetzen
  clearTimers();
  hideCoinBadges();      // falls noch ein Payout offen war
  // ❌ KEIN advanceRound();  // Störung zählt nicht als Runde

  return;
}


          const recipe = plannedRecipe || getRecipeFromColors(finalColors);
         if(!recipe){
  setResult('Unbekanntes Rezept','Ziehe den Hebel zum Neustart.','');
  leverLocked = false;
  roundAdvancePending = true;  // ⬅️ NEU: Runde erst beim nächsten Hebelzug erhöhen
  spinning = false; 
  clearTimers(); 
  return;
}


          const ptsAdj = adjustPts(recipe.pts);
          setLampsByScore(ptsAdj);
          setResult(recipe.name, recipe.desc, `Verteilt ${ptsAdj} Thaler im Scoreboard!`);
          safePlay(audio.ergebnis);
          if(ptsAdj>=13) safePlay(audio.fanfare);
          try{ if('vibrate' in navigator) navigator.vibrate(30); }catch{}

          leverLocked = true;
          showCoinBadges(ptsAdj);
                         // Scoreboard-Button (auf der Maschine) gelb leuchten lassen:
          scoreboardBtn.classList.add('active','glow');

          spinning=false; clearTimers();
        }
      }, stopBase[i]+Math.floor(Math.random()*260));
      timers.push(to);
    });
  }

  /* ===== Debug-Panel, Storage & Drag ===== */
  (function(){
    const BUILD_VERSION = (new URLSearchParams(location.search).get('dbgver')) || '2025-09-03-b';
    const STORAGE_PREFIX = 'rezep_debug_vars';
    const STORAGE_KEY    = `${STORAGE_PREFIX}_${BUILD_VERSION}`;
    const DBG_KEY        = `${STORAGE_PREFIX}_flag_${BUILD_VERSION}`;
    const POS_KEY        = `${STORAGE_PREFIX}_panelpos_${BUILD_VERSION}`;
    const posStore       = sessionStorage;

    const root   = document.documentElement;
    const panel  = $('#dbgPanel');
    const dbgOn  = $('#dbgOn');
    const dbgSoundOn = $('#dbgSoundOn');

    function getVarLocal(n){ return getComputedStyle(root).getPropertyValue(n).trim(); }
    function flashSaved(btn, txt='✅'){ const prev = btn.textContent; btn.disabled=true; btn.textContent=txt; setTimeout(()=>{ btn.textContent=prev; btn.disabled=false; },900); }

    const VARS_PX      = ['--r-top','--r-w','--r-h','--r0-left','--r1-left','--r2-left','--r3-left','--res-left','--res-top','--res-w','--res-h','--lever-x','--lever-y','--lamps-x','--lamps-y'];
    const VARS_SCALE = [
  '--reel-scale','--lever-scale','--lamps-scale',
  '--sb-players-scale','--sb-round-scale','--sb-controls-scale','--sb-actions-scale'
];

    const VARS_LAMPS   = ['--lamps-gap','--lamp-afterglow'];
    const VARS_UI      = ['--ui-btn-w','--ui-btn-h','--ui-opacity'];
    const VARS_SHINE   = ['--shine-core','--shine-speed','--shine-angle'];
    const VARS_SCAN    = ['--scan-thickness','--scan-spacing','--scan-opacity','--scan-blend'];
    const VARS_MISC    = ['--sound-enabled'];
    const VARS_TEXT    = ['--result-name-size','--result-desc-size','--result-points-size','--result-name-color','--result-desc-color','--result-points-color'];
    const VARS_SCAN_X  = ['--scan-angle','--scan-bright','--scan-dark'];
    const VARS_BTN_POS   = ['--sound-x','--sound-y','--exit-x','--exit-y','--sb-start-x','--sb-start-y','--sb-sound-x','--sb-sound-y','--sb-auto-x','--sb-auto-y','--sb-reset-x','--sb-reset-y','--sb-players-left','--sb-players-right','--sb-players-top',
  '--sb-round-left','--sb-round-right','--sb-round-bottom',
  '--sb-controls-left','--sb-controls-right','--sb-controls-bottom',
  '--sb-actions-translate-x','--sb-actions-translate-y'
];


    const VARS = [...VARS_PX, ...VARS_SCALE, ...VARS_LAMPS, ...VARS_UI, ...VARS_SHINE, ...VARS_SCAN, ...VARS_TEXT, ...VARS_SCAN_X, ...VARS_BTN_POS, ...VARS_MISC];

 function setVarAuto(n, raw){
  const root = document.documentElement;
  const num  = parseFloat(raw);
  const asNum = Number.isFinite(num) ? String(num) : '0';

  // 1) DESIGN-SPACE: unitlos, weil im CSS mit "* 1px" multipliziert
  const DESIGN_NUM = [
    '--r-top','--r-w','--r-h',
    '--r0-left','--r1-left','--r2-left','--r3-left',
    '--res-left','--res-top','--res-w','--res-h',
    '--lever-x','--lever-y','--lamps-x','--lamps-y'
  ];
  if (DESIGN_NUM.includes(n)) { root.style.setProperty(n, asNum); return; }

  // 2) Skalen (rein numerisch)
  const SCALES = [
    '--reel-scale','--lever-scale','--lamps-scale',
    '--sb-players-scale','--sb-round-scale','--sb-controls-scale','--sb-actions-scale'
  ];
  if (SCALES.includes(n)) { root.style.setProperty(n, asNum); return; }

  // 3) Winkel/Zeiten
  if (n === '--shine-angle' || n === '--scan-angle') {
    root.style.setProperty(n, (Number.isFinite(num)?num:0) + 'deg'); return;
  }
  if (n === '--shine-speed' || n === '--lamp-afterglow') {
    root.style.setProperty(n, (Number.isFinite(num)?num:0) + 's'); return;
  }

  // 4) DIREKTE LÄNGEN in px (Buttons, Scoreboard-Pos, UI-Größen, Textgrößen, Scan-Dicke/Abstand, Lamps-Gap)
  const LENGTH_PX = [
    '--ui-btn-w','--ui-btn-h',
    '--sound-x','--sound-y','--exit-x','--exit-y',
    '--sb-start-x','--sb-start-y','--sb-sound-x','--sb-sound-y','--sb-auto-x','--sb-auto-y','--sb-reset-x','--sb-reset-y',
    '--sb-players-left','--sb-players-right','--sb-players-top',
    '--sb-round-left','--sb-round-right','--sb-round-bottom',
    '--sb-controls-left','--sb-controls-right','--sb-controls-bottom',
    '--sb-actions-translate-x','--sb-actions-translate-y',
    '--result-name-size','--result-desc-size','--result-points-size',
    '--lamps-gap','--scan-thickness','--scan-spacing'
  ];
  if (LENGTH_PX.includes(n)) {
    root.style.setProperty(n, (Number.isFinite(num)?num:0) + 'px'); return;
  }

  // 5) Rest (Farben, Blend-Mode usw.) 1:1 übernehmen
  root.style.setProperty(n, String(raw));
}


    function syncClipFromVars(){
      const cp = document.querySelector('#winClip'); if(!cp) return;
      const vals = {
        rtop:+getVarLocal('--r-top'), rw:+getVarLocal('--r-w'), rh:+getVarLocal('--r-h'),
        r0:+getVarLocal('--r0-left'), r1:+getVarLocal('--r1-left'), r2:+getVarLocal('--r2-left'), r3:+getVarLocal('--r3-left'),
        rx:+getVarLocal('--res-left'), ry:+getVarLocal('--res-top'), rw2:+getVarLocal('--res-w'), rh2:+getVarLocal('--res-h')
      };
      const rects = cp.querySelectorAll('rect');
      if(rects.length>=6){
        rects[1].setAttribute('x', vals.r0); rects[1].setAttribute('y', vals.rtop); rects[1].setAttribute('width', vals.rw); rects[1].setAttribute('height', vals.rh);
        rects[2].setAttribute('x', vals.r1); rects[2].setAttribute('y', vals.rtop); rects[2].setAttribute('width', vals.rw); rects[2].setAttribute('height', vals.rh);
        rects[3].setAttribute('x', vals.r2); rects[3].setAttribute('y', vals.rtop); rects[3].setAttribute('width', vals.rw); rects[3].setAttribute('height', vals.rh);
        rects[4].setAttribute('x', vals.r3); rects[4].setAttribute('y', vals.rtop); rects[4].setAttribute('width', vals.rw); rects[4].setAttribute('height', vals.rh);
        rects[5].setAttribute('x', vals.rx); rects[5].setAttribute('y', vals.ry); rects[5].setAttribute('width', vals.rw2); rects[5].setAttribute('height', vals.rh2);
      }
    }

    function save(btn){
      try{
        const out={}; VARS.forEach(n=> out[n]=getVarLocal(n));
        localStorage.setItem(STORAGE_KEY, JSON.stringify(out));
        localStorage.setItem(DBG_KEY, document.body.classList.contains('debug')?'1':'0');
        if(btn) flashSaved(btn);
      }catch(err){ console.error('Save failed:', err); }
    }
    function load(){
      const raw=localStorage.getItem(STORAGE_KEY);
      if(raw){ try{ const obj=JSON.parse(raw); Object.entries(obj).forEach(([k,v])=>{ if(VARS.includes(k)) setVarAuto(k,v); }); }catch{} }
      const df=localStorage.getItem(DBG_KEY);
      document.body.classList.toggle('debug', df==='1');
      if(dbgOn) dbgOn.checked=document.body.classList.contains('debug');
      if(dbgSoundOn) dbgSoundOn.checked = getVarLocal('--sound-enabled')==='1';
      syncInputs(); syncClipFromVars(); fit();
    }
    function reset(){
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(DBG_KEY);
      [...VARS].forEach(n=> root.style.removeProperty(n));
      syncInputs(); syncClipFromVars(); fit();
    }
   function stripUnit(name, val){
  const num = parseFloat(val);
  const asNum = Number.isFinite(num) ? num : 0;

  if (name.startsWith('--sb-')) return asNum; // alle Scoreboard-Variablen
  if (['--shine-angle','--scan-angle','--shine-speed','--lamp-afterglow'].includes(name)) return asNum;
  if (name.startsWith('--ui-btn-')) return asNum;
  if (['--sound-x','--sound-y','--exit-x','--exit-y',
       '--sb-start-x','--sb-start-y','--sb-sound-x','--sb-sound-y','--sb-auto-x','--sb-auto-y','--sb-reset-x','--sb-reset-y',
       '--result-name-size','--result-desc-size','--result-points-size',
       '--lamps-gap','--scan-thickness','--scan-spacing'
      ].includes(name)) return asNum;
  if (VARS_PX.includes(name)) return asNum;

  // Strings (Farben, Blend-Modi) unverändert zurück (ohne evtl. Anführungszeichen)
  return (val || '').replace(/(^"|"$)/g,'');
}


    function syncInputs(){
      panel.querySelectorAll('[data-var]').forEach(inp=>{
        const name = inp.getAttribute('data-var');
        const cssVal = getVarLocal(name);
        if (inp.type === 'color') {
          if (/^#([0-9a-f]{3}|[0-9a-f]{6}|[0-9a-f]{8})$/i.test(cssVal)) { inp.value = cssVal; } else { inp.value = '#ffffff'; }
        } else if (inp.type === 'text') { inp.value = cssVal;
        } else { inp.value = stripUnit(name, cssVal); }
      });
    }

    /* Panel öffnen/schließen */
    $('#dbgToggle').addEventListener('click', ()=> 
      panel.style.display = (panel.style.display==='block'?'none':'block')
    );

    panel.addEventListener('input', (e)=>{
      const el=e.target; if(!el.matches('[data-var]')) return;
      const name=el.getAttribute('data-var'); let raw=el.value;
      if(name==='--lamps-gap') raw = String(Math.max(8, parseFloat(raw)||0));
      setVarAuto(name, raw);
      panel.querySelectorAll(`[data-var="${name}"]`).forEach(x=>{ if(x!==el) x.value=raw; });
      if(['--r-top','--r-w','--r-h','--r0-left','--r1-left','--r2-left','--r3-left','--res-left','--res-top','--res-w','--res-h'].includes(name)) syncClipFromVars();
      if(name.startsWith('--ui-btn-')) fit();
      if(name==='--lever-scale') measure();
    });

    document.getElementById('dbgSave').addEventListener('click', (e)=> save(e.target));
    document.getElementById('dbgReset').addEventListener('click', reset);
    document.getElementById('dbgCopyCss').addEventListener('click', (e)=>{
      const css=':root{\n'+VARS.map(n=>`  ${getVarLocal(n)?`${n}: ${getVarLocal(n)};`:''}`).filter(Boolean).join('\n')+'\n}';
      if(navigator.clipboard) navigator.clipboard.writeText(css);
      flashSaved(e.target,'✅ Kopiert');
    });

    if(dbgOn) dbgOn.addEventListener('change', ()=>{ document.body.classList.toggle('debug', dbgOn.checked); });
    if(dbgSoundOn) dbgSoundOn.addEventListener('change', ()=>{
      root.style.setProperty('--sound-enabled', dbgSoundOn.checked?'1':'0');
      if(!dbgSoundOn.checked) safeStop(audio.dreh);
      const b = $('#sbSoundToggle'); if(b){ b.textContent = dbgSoundOn.checked ? '🔊 SOUND' : '🔇 SOUND'; b.classList.toggle('active', !dbgSoundOn.checked); }
    });

    (function panelDrag(){
      const panel = $('#dbgPanel');
      const header = panel.querySelector('header');
      let drag=false, offX=0, offY=0;
      const place=(x,y)=>{ panel.style.left=x+'px'; panel.style.top=y+'px'; panel.style.right='auto'; panel.style.bottom='auto'; };
      const savePos = ()=>{ const r = panel.getBoundingClientRect(); sessionStorage.setItem(POS_KEY, JSON.stringify({x:r.left, y:r.top})); };
      const loadPos = ()=>{ const raw = sessionStorage.getItem(POS_KEY); if(!raw) return; try{ const {x,y} = JSON.parse(raw); if(Number.isFinite(x)&&Number.isFinite(y)) place(x,y); }catch{} };
      

      header.addEventListener('mousedown', e=>{ drag=true; const r=panel.getBoundingClientRect(); offX=e.clientX-r.left; offY=e.clientY-r.top; e.preventDefault(); });
      addEventListener('mousemove', e=>{ if(!drag) return; place(e.clientX-offX, e.clientY-offY); });
      addEventListener('mouseup', ()=>{ if(drag){ drag=false; savePos(); } });
      header.addEventListener('touchstart', e=>{ drag=true; const t=e.touches[0]; const r=panel.getBoundingClientRect(); offX=t.clientX-r.left; offY=t.clientY-r.top; }, {passive:true});
      addEventListener('touchmove', e=>{ if(!drag) return; const t=e.touches[0]; place(t.clientX-offX, t.clientY-offY); }, {passive:true});
      addEventListener('touchend', ()=>{ if(drag){ drag=false; savePos(); } });
      loadPos();
    })();

    load();
  })();

 
  fit();
})();
</script>
<script src="assets/js/automatron-screensaver.js"></script>
<script>
  // Screensaver nach 6s Inaktivität, schnelleres Spawning
  AutomatronScreensaver.init({
    inactivityMs: 30000,
    startBurst: 1,        // ⬅️ Anfangsmenge
    spawnEveryMs: 4000,    // ⬅️ niedriger = mehr Käfer
    bugFps: 10,
    speedMin: 50,
    speedMax: 1000,
    bobAmpMin: 20,
    bobAmpMax: 30,
    bobFreqMin: 0.18,
    bobFreqMax: 0.35,
    assets: {
      bug:  "assets/img/bug.png",
      bug1: "assets/img/bug1.png",
      bug2: "assets/img/bug2.png",
      bug3: "assets/img/bug3.png",
      bug4: "assets/img/bug4.png",
      snd: {
        grabel: "assets/snd/grabel.mp3",
        hit:    "assets/snd/hit.mp3"
      }
    }
  }).autowireIdle();

  // Manuell testen: Taste "S"
  document.addEventListener("keydown", (e)=>{
    if (e.key.toLowerCase()==="s") AutomatronScreensaver.start();
  });
</script>
</body>
</html>
